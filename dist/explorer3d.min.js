!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Explorer3d=t.Explorer3d||{})}(this,function(t){"use strict";function e(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function i(t){return t.split(/\s+/g).map(function(t){return t.replace(/\"/g,"")})}function n(t){var e=t.split(/\s+/g),i=(e.length,{get xyz(){return[this.x,this.y,this.z]}});return e.forEach(function(t,e){switch(e){case 0:break;case 1:i.index=parseInt(t);break;case 2:i.vertexId=parseFloat(t);break;case 3:i.properties=[];default:i.properties.push(t)}}),i}function r(t,e,i){var n=t.split(/\s+/g),r=(n.length,i?i:1),o=[],s={get xyz(){return[this.x,this.y,this.z]},get all(){var t=[this.x,this.y,this.z];return this.properties&&this.properties.forEach(function(e){t.push(e)}),t}};return n.forEach(function(t,e){switch(e){case 0:break;case 1:s.index=parseInt(t);break;case 2:o[0]=parseFloat(t);break;case 3:o[1]=parseFloat(t);break;case 4:s.z=parseFloat(t)*r;break;case 5:s.properties=[];default:s.properties.push(t)}}),e&&(o=e(o)),s.x=o[0],s.y=o[1],s}function o(t){return"true"===t}function s(t){return t}function a(t){if(t){var e=t.trim().split(/\s+/g);return 1===e.length&&0===e[0].indexOf("#")?parseInt("0x"+e[0].substring(1)):255*parseFloat(e[0])*256*256+255*parseFloat(e[1])*256+255*parseFloat(e[2])}return null}function h(t){var e=t.split(/\s+/g);return{id:+e[1],vertices:[+e[2],+e[3]]}}function c(t){var e=t.split(/\s+/g),i=e.length,n={get abc(){return[this.a,this.b,this.c]}};return 4===i&&(n.a=parseInt(e[1]),n.b=parseFloat(e[2]),n.c=parseFloat(e[3])),n}function l(t){var e=t.split(/\s+/g);return parseInt(e[1])}function d(t){var e=t.split(/\s+/g);return[parseInt(e[1]),parseInt(e[2])]}function u(t){var e=t.split(/\s+/g);return[parseInt(e[1]),parseInt(e[2]),parseInt(e[3]),parseInt(e[4])]}function p(t){var e=t.split(/\s+/g);return e.shift(),e}function f(t,e){var i=Array.isArray(e),n=i&&[]||{};if(Array.isArray(e)){var r=n;t=t||[],r=r.concat(t),e.forEach(function(e,i){"undefined"==typeof r[i]?r[i]=e:"object"==typeof e?r[i]=f(t[i],e):t.indexOf(e)===-1&&r.push(e)})}else t&&"object"==typeof t&&Object.keys(t).forEach(function(e){n[e]=t[e]}),Object.keys(e).forEach(function(i){"object"==typeof e[i]&&e[i]&&t[i]?n[i]=f(t[i],e[i]):n[i]=e[i]});return n}function v(t,e){var i,n,r,o=-1,s=t.length;if(null==e){for(;++o<s;)if(null!=(n=t[o])&&n>=n){i=r=n;break}for(;++o<s;)null!=(n=t[o])&&(i=Math.min(i,n),r=Math.max(r,n))}else{for(;++o<s;)if(null!=(n=e(t[o],o,t))&&n>=n){i=r=n;break}for(;++o<s;)null!=(n=e(t[o],o,t))&&(i=Math.min(i,n),r=Math.max(r,n))}return[i,r]}function E(t){if("undefined"!=typeof DOMParser)return(new DOMParser).parseFromString(t,"text/xml");if("undefined"!=typeof ActiveXObject&&new ActiveXObject("Microsoft.XMLDOM")){var e=new ActiveXObject("Microsoft.XMLDOM");return e.async="false",e.loadXML(t),e}return null}function x(t){var e=new THREE.Geometry;return t.borders.forEach(function(i){var n=t.vertices[i[0]];e.vertices.push(new THREE.Vector3(n[0],n[1],n[2])),n=t.vertices[i[1]],e.vertices.push(new THREE.Vector3(n[0],n[1],n[2]))}),e.vertices.length?(e.computeBoundingBox(),new THREE.LineSegments(e,new THREE.LineBasicMaterial({linewidth:10,color:16711935}))):null}function y(t){var e=new THREE.Geometry;if(t.bstones.forEach(function(i){var n=t.vertices[i];if(n){var r=new THREE.Vector3(n[0],n[1],n[2]);e.vertices.push(r)}}),e.vertices.length){e.computeBoundingBox();var i=new THREE.PointsMaterial({size:16384});return new THREE.Points(e,i)}return null}function m(t){var e=v(t.vertices,function(t){return t?+t[3]:null}),i=new THREE.LineBasicMaterial({linewidth:10,color:16777215,vertexColors:THREE.VertexColors}),n=new THREE.Geometry,r=new THREE.Lut("rainbow",Math.floor(e[1]-e[0]));return r.setMax(Math.floor(e[1])),r.setMin(Math.floor(e[0])),t.lines.forEach(function(e){e.forEach(function(e,i){var o=t.vertices[e[0]];n.vertices.push(new THREE.Vector3(o[0],o[1],o[2])),n.colors.push(r.getColor(parseInt(o[3]))),o=t.vertices[e[1]],n.vertices.push(new THREE.Vector3(o[0],o[1],o[2])),n.colors.push(r.getColor(parseInt(o[3])))})}),n.computeBoundingBox(),n.computeBoundingSphere(),new THREE.LineSegments(n,i)}function g(t){var e=new THREE.Geometry,i=t.header.solidColor,n=new THREE.MeshLambertMaterial({color:i?i:16716049,side:THREE.DoubleSide});t.vertices.forEach(function(t){e.vertices.push(new THREE.Vector3(t[0],t[1],t[2]))}),t.faces.forEach(function(t){e.faces.push(new THREE.Face3(t[0]-1,t[1]-1,t[2]-1))}),e.computeBoundingBox(),e.computeFaceNormals();var r=new THREE.Mesh(e,n);return r}function b(t){var e=new THREE.Geometry,i=t.header.color;t.vertices.forEach(function(t){var i=new THREE.Vector3(t[0],t[1],t[2]);e.vertices.push(i)});var n=new THREE.PointsMaterial({size:16,color:i}),r=new THREE.Points(e,n);return e.computeBoundingBox(),e.computeBoundingSphere(),e.computeFaceNormals(),r}var w=function(){function t(t){this.isValid=!0,this.typeMap={AXIS_NAME:i,AXIS_UNIT:i};var e=t.nextDataLine().trim();if("GOCAD_ORIGINAL_COORDINATE_SYSTEM"!==e)t.previous(),this.isValid=!1;else for(e=t.nextDataLine().trim();e&&"END_ORIGINAL_COORDINATE_SYSTEM"!==e;){var n=e.indexOf(" ");if(n>0){var r=e.substring(0,n),o=e.substring(n).trim(),s=this.typeMap[r]?this.typeMap[r]:function(t){return t};this[r]=s(o)}e=t.nextDataLine().trim()}this.typeMap=null}return t}(),T=function(){function t(){}return t.prototype.apply=function(e){e.addEventListener=t.prototype.addEventListener,e.hasEventListener=t.prototype.hasEventListener,e.removeEventListener=t.prototype.removeEventListener,e.dispatchEvent=t.prototype.dispatchEvent},t.prototype.addEventListener=function(t,e){void 0===this._listeners&&(this._listeners={});var i=this._listeners;void 0===i[t]&&(i[t]=[]),i[t].indexOf(e)===-1&&i[t].push(e)},t.prototype.hasEventListener=function(t,e){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[t]&&i[t].indexOf(e)!==-1},t.prototype.removeEventListener=function(t,e){if(void 0!==this._listeners){var i=this._listeners,n=i[t];if(void 0!==n){var r=n.indexOf(e);r!==-1&&n.splice(r,1)}}},t.prototype.dispatchEvent=function(){},t}(),O=function(t){function i(e,i){t.call(this),this.type="Type",this.projectionFn=function(t){return t},this.isValid=!1,this.reader=e,i&&(this.projectionFn=i)}return e(i,t),i.prototype.clear=function(){this.reader=null},i}(T),R=function(){function t(t){this.values={},this.typeMap={ivolmap:o,imap:o,parts:o,mesh:o,cn:o,border:o,"*solid*color":a};for(var e=t.nextDataLine().trim();e&&0!==e.indexOf("}");){var i=e.split(":");if(2===i.length){var n=this.typeMap[i[0]];n=n?n:s,this.values[i[0]]=n(i[1])}else console.warn("That doesn't look like a pair: "+e);e=t.nextDataLine().trim()}this.name=this.values.name,this.solidColor=this.values["*solid*color"],this.solidColor=this.solidColor?this.solidColor:15658734,this.typeMap=null}return t.prototype.toColor=function(t){return a(t)},t.prototype.toBool=function(t){return o(t)},t}(),C=function(t){function i(e,i){t.call(this,e,i),this.type="TSurf",this.vertices=[],this.faces=[],this.bstones=[],this.borders=[];var o=e.expects("HEADER");if(o&&o.indexOf("{")!==-1){this.header=new R(e);var s=new w(e),a=1;for(s.isValid&&(this.coordinateSystem=s,a="Depth"===this.coordinateSystem.ZPOSITIVE?-1:1),o=e.expects("TFACE");"END"!==(o=e.nextDataLine().trim());)if(0===o.indexOf("VRTX")||0===o.indexOf("PVRTX")){var d=r(o,this.projectionFn,a);this.vertices[d.index]=d.all}else if(0===o.indexOf("ATOM")||0===o.indexOf("PATOM")){var u=n(o);this.vertices[u.index]=this.vertices[u.vertexId]}else if(0===o.indexOf("TRGL"))this.faces.push(c(o).abc);else if(0===o.indexOf("BSTONE"))this.bstones.push(l(o));else if(0===o.indexOf("BORDER")){var p=h(o);this.borders[p.id]=[p.vertices[0],p.vertices[1]]}this.clear()}}return e(i,t),i}(O),H=function(t){function i(e){t.call(this,e),this.paintedVariable=this.values["*painted*variable"];var i=this.values["*line*color"];this.color=i?this.toColor(i):255}return e(i,t),i}(R),S=function(t){function i(e,i){t.call(this,e,i),this.type="PLine",this.vertices=[],this.lines=[];var o=e.expects("HEADER");if(o&&o.indexOf("{")!==-1){this.header=new H(e);var s=new w(e),a=1;s.isValid&&(this.coordinateSystem=s,a="Depth"===this.coordinateSystem.ZPOSITIVE?-1:1),o=e.expects("ILINE");var h=1,c=1,l=!1,u=[];o=e.nextDataLine();for(var p="}"===(o?o.trim():"}");!p;){if(0===o.indexOf("VRTX")||0===o.indexOf("PVRTX")){var f=r(o,this.projectionFn,a);this.vertices[f.index]=f.all,c=f.index}else if(0===o.indexOf("ATOM")||0===o.indexOf("PATOM")){var v=n(o);this.vertices[v.index]=this.vertices[v.vertexId]}else if(0===o.indexOf("SEG"))u.push(d(o)),l=!0;else if(0===o.indexOf("ILINE")||0===o.indexOf("END")){if(p=0===o.indexOf("END"),!l&&c>h)for(var E=h;E<c;E++)u.push([E,E+1]);this.lines.push(u),u=[],h=c+1,l=!1}p=!e.hasMore(),p||(p="}"===(o=e.nextDataLine().trim()))}this.clear()}}return e(i,t),i}(O),z=function(t){function i(e,i){t.call(this,e,i),this.type="TSolid",this.vertices=[],this.tetras=[];var o=e.expects("HEADER");if(o){this.header=new R(e);var s=new w(e),a=1;for(s.isValid&&(this.coordinateSystem=s,a="Depth"===this.coordinateSystem.ZPOSITIVE?-1:1),o=e.expects("TVOLUME");"END"!==(o=e.nextDataLine().trim());)if(0===o.indexOf("VRTX")||0===o.indexOf("PVRTX")){var h=r(o,this.projectionFn,a);this.vertices[h.index]=h.all}else if(0===o.indexOf("ATOM")||0===o.indexOf("PATOM")){var c=n(o);this.vertices[c.index]=this.vertices[c.vertexId]}else 0===o.indexOf("TETRA")&&this.tetras.push(u(o));this.clear()}}return e(i,t),i}(O),k=function(t){function i(e){t.call(this,e),this.color=this.toColor(this.values["*atoms*color"])}return e(i,t),i}(R),L=function(t){function i(e,i){t.call(this,e,i),this.type="VSet",this.vertices=[];var o=e.expects("HEADER");if(o&&o.indexOf("{")!==-1){this.header=new k(e);var s=new w(e),a=1;for(s.isValid&&(this.coordinateSystem=s,a="Depth"===this.coordinateSystem.ZPOSITIVE?-1:1);"END"!==(o=e.nextDataLine().trim());)if(0===o.indexOf("VRTX")||0===o.indexOf("PVRTX")){var h=r(o,i,a);this.vertices[h.index]=h.all}else if(0===o.indexOf("ATOM")||0===o.indexOf("PATOM")){var c=n(o);this.vertices[c.index]=this.vertices[c.vertexId]}this.clear()}}return e(i,t),i}(O),A=function(t){function i(e,i){for(t.call(this,e,i),this.type="Unknown";e.hasMore();){var n=e.next().trim();if("END"===n)break}this.clear()}return e(i,t),i}(O),M=function(){function t(t,e){if(this.isValid=!1,t.hasMore()){var i=t.next().trim(),n=i.split(/\s+/g);this.isValid=3===n.length&&"GOCAD"===n[0]&&("1.0"===n[2]||"1"===n[2]),this.isValid&&(this.version=n[2],"TSurf"===n[1]?this.type=new C(t,e):"PLine"===n[1]?this.type=new S(t,e):"TSolid"===n[1]?this.type=new z(t,e):"VSet"===n[1]?this.type=new L(t,e):this.type=new A(t,e))}}return t}(),D=function(){function t(t,e){if(this.types=[],this.reader=t,t.hasMore()){var i=new M(t,e);i.isValid&&this.types.push(i.type)}this.clean()}return t.prototype.clean=function(){this.reader=null,this.types&&this.types.forEach(function(t){t.projectionFn=null})},t}(),P=function(){function t(t,e){var i=this;this.isValid=!0,this.names={},this.range={min:null,max:null},this.terminator="}",e=e?e:[],e.push(this.terminator);var n=t.nextDataLine().trim();if(this.isValid=!1,0!==n.indexOf("PROPERTIES"))t.previous();else{var r=p(n);for(r.length&&r.forEach(function(t){i.names[t]={}}),this.isValid=!0,n=t.nextDataLine().trim();;){var o=p(n);if(0===n.indexOf("PROP_LEGAL_RANGES")&&2===o.length?("**none**"!==o[0]&&(this.range.min=parseFloat(o[0])),"**none**"!==o[1]&&(this.range.min=parseFloat(o[1]))):0===n.indexOf("PROPERTY_CLASSES")&&o.length>0?o.forEach(function(t,e){i.names[r[e]].className=t}):0===n.indexOf("UNITS")&&o.length>0&&o.forEach(function(t,e){i.names[r[e]].unit=t}),n=t.nextDataLine()?n.trim():"}",0===n.indexOf("}"))break}}}return t}(),V=function(){function t(t,e){if(t){var i=t.split(/\s+/g),n=e([parseFloat(i[0]),parseFloat(i[1])]);this.x=n[0],this.y=n[1],this.z=parseFloat(i[2])}}return t}(),j=function(){function t(t,e,i){this.PAGE_SIZE=1048576,this.file=t,this.length=t.size,this.handler=e,this.errorHandler=i,this.pageNo=this.index=0,this.lineBuffer=[],this.process()}return t.prototype.process=function(){this.readPage()},t.prototype.readPage=function(){function t(t){for(var e=0;e<t.length;e++){var i=t[this.index];"\r"!==i&&("\n"!==i?this.lineBuffer.push(t[e]):(this.handler(this.lineBuffer.join("")),this.lineBuffer=[]))}}var e=this,i=this.pageNo*this.PAGE_SIZE;i>=this.length&&this.complete();var n=new FileReader,r=this.file.slice(i,i+this.PAGE_SIZE);n.onloadend=function(i){if(i.target.readyState===FileReader.prototype.DONE){var n=i.target.result;t(n),e.pageNo++,e.readPage()}},n.readAsText(r)},t.prototype.complete=function(){this.lineBuffer.length&&this.handler(this.lineBuffer.join("")),this.handler(null)},t}(),F=function(){function t(t){this.indexStack=[],this.data=t,this.length=t.length,this.index=0}return t.prototype.hasMore=function(){return this.index<this.length-1},t.prototype.peek=function(){this.next();this.previous()},t.prototype.previous=function(){this.indexStack.length&&(this.index=this.indexStack.pop())},t.prototype.next=function(){this.indexStack.push(this.index);for(var t=[];this.index<this.length;this.index++){var e=this.data[this.index];if("\r"!==e){if("\n"===e){this.index++;break}t.push(this.data[this.index])}}return t?t.join(""):null},t.prototype.expects=function(t){for(;this.hasMore();){var e=this.next();if(!e.indexOf(t))return e}return null},t.prototype.nextNonEmpty=function(){for(;this.hasMore();){var t=this.next();if(t)return t}return null},t.prototype.nextDataLine=function(){for(var t=this.nextNonEmpty();t;){if(t.indexOf("#"))return t;t=this.nextNonEmpty()}return t},t}(),I=function(){function t(){this.geometry=new THREE.Geometry,this.userData={}}return t.prototype.setHeader=function(t){this.userData.header=t;var e=t.solidColor;this.material=new THREE.MeshLambertMaterial({color:e?e:16716049,side:THREE.DoubleSide})},t.prototype.setVertices=function(t){var e=this;t.forEach(function(t){e.geometry.vertices.push(new THREE.Vector3(t[0],t[1],t[2]))})},t.prototype.setCoordinateSystem=function(t){this.userData.coordinateSystem=t},t.prototype.setFaces=function(t){var e=this;t.forEach(function(t){e.geometry.faces.push(new THREE.Face3(t[0]-1,t[1]-1,t[2]-1))})},t.prototype.createMesh=function(){this.geometry.computeBoundingBox(),this.geometry.computeFaceNormals();var t=new THREE.Mesh(this.geometry,this.material);return t.userData=this.userData,t},t}(),B=function(){function t(){}return t.add=function(t,e){return e=e?e:{},e.vertexShader=this.VertexShader[t],e.fragmentShader=this.FragmentShader[t],e},t.VertexShader={COLOR_RAMP:"attribute vec3 customColor;\nvarying vec3 vColor;\nvoid main() {\n\tvColor = customColor;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}"},t.FragmentShader={COLOR_RAMP:"uniform vec3 color;\n\nvarying vec3 vColor;\nvoid main() {\n\tgl_FragColor = vec4( vColor * color, 1 );\n}"},t}(),N=function(){function t(t,e){function i(){a.continueAnimation&&(window.requestAnimationFrame(i),a.camera.lookAt(a.lookAt),a.renderer.render(a.scene,a.camera),a.controls.update(.02))}void 0===e&&(e={}),this.options={camera:{fov:45,near:.1,far:5e5,position:{x:-30,y:40,z:30},up:{x:0,y:1,z:0}},lights:{ambient:{color:5592405},directional:{color:10526880,center:{x:0,y:0,z:0},position:{dx:50,dy:10,dz:-300}}},axisHelper:{on:!0,size:20}},this.lights=[],this.options=f(this.options,e);var n=document.body.getBoundingClientRect();"string"==typeof t?this.container=document.getElementById(""+t):this.container=t,this.scene=new THREE.Scene,this.renderer=new THREE.WebGLRenderer({clearColor:16711680}),this.renderer.setSize(n.width,n.height);var r=this.options.camera;this.camera=new THREE.PerspectiveCamera(r.fov,n.width/n.height,r.near,r.far),this.camera.up.set(r.up.x,r.up.y,r.up.z);var o=r.position;if(this.camera.position.x=o.x,this.camera.position.y=o.y,this.camera.position.z=o.z,e.camera.lookAt){var s=e.camera.lookAt;this.lookAt=new THREE.Vector3(s.x,s.y,s.z)}else this.lookAt=this.scene.position;this.camera.lookAt(this.lookAt),this.container.appendChild(this.renderer.domElement),this.renderer.render(this.scene,this.camera),this.axisHelper(this.options.axisHelper.on),this.addLights(),this.addFlyControls(),this.resizer=THREEExt.WindowResize(this.renderer,this.camera,this.container);var a=this;this.continueAnimation=!0,this.resizer.trigger(),i()}return t.prototype.resize=function(t){this.options=f(this.options,t?t:{});var e=this.options.axisHelper.on;this.axisHelper(!1),this.axisHelper(e),this.updateLights();var i=t.camera.lookAt;this.lookAt=new THREE.Vector3(i.x,i.y,i.z),this.camera.far=t.camera.far,this.camera.near=t.camera.near,this.camera.lookAt(this.lookAt)},t.prototype.update=function(t){this.options=f(this.options,t?t:{});var e=this.options.camera;this.camera.up.set(e.up.x,e.up.y,e.up.z);var i=e.position;if(this.camera.position.x=i.x,this.camera.position.y=i.y,this.camera.position.z=i.z,t.camera.lookAt){var n=t.camera.lookAt;this.lookAt=new THREE.Vector3(n.x,n.y,n.z)}else this.lookAt=this.scene.position;this.camera.lookAt(this.lookAt),this.controls.movementSpeed=this.options.radius;var r=this.options.axisHelper.on;this.axisHelper(!1),this.axisHelper(r),this.updateLights()},t.prototype.destroy=function(){for(this.renderer.domElement.addEventListener("dblclick",null,!1),this.scene=null,this.camera=null,this.controls=null;this.container.lastChild;)this.container.removeChild(this.container.lastChild);this.continueAnimation=!1},t.prototype.addLabels=function(t){function e(e,n){var r=f({fontface:"Arial",fontsize:18,borderThickness:4,borderColor:{r:0,g:0,b:0,a:1},backgroundColor:{r:255,g:255,b:255,a:1}},n?n:{}),o=document.createElement("canvas"),s=o.getContext("2d");s.font=r.fontsize+"px "+r.fontface;var a=s.measureText(e),h=a.width;s.fillStyle="rgba("+r.backgroundColor.r+","+r.backgroundColor.g+","+r.backgroundColor.b+","+r.backgroundColor.a+")",s.strokeStyle="rgba("+r.borderColor.r+","+r.borderColor.g+","+r.borderColor.b+","+r.borderColor.a+")",s.lineWidth=r.borderThickness,i(s,r.borderThickness/2,r.borderThickness/2,h+r.borderThickness,1.4*r.fontsize+r.borderThickness,6),s.fillStyle="rgba(0, 0, 0, 1.0)",s.fillText(e,r.borderThickness,r.fontsize+r.borderThickness);var c=new THREE.Texture(o);c.needsUpdate=!0;var l=new THREE.SpriteMaterial({map:c}),d=new THREE.Sprite(l);return d.scale.set(35*t,15*t,1),d}function i(t,e,i,n,r,o){t.beginPath(),t.moveTo(e+o,i),t.lineTo(e+n-o,i),t.quadraticCurveTo(e+n,i,e+n,i+o),t.lineTo(e+n,i+r-o),t.quadraticCurveTo(e+n,i+r,e+n-o,i+r),t.lineTo(e+o,i+r),t.quadraticCurveTo(e,i+r,e,i+r-o),t.lineTo(e,i+o),t.quadraticCurveTo(e,i,e+o,i),t.closePath(),t.fill(),t.stroke()}this.labels&&this.scene.remove(this.labels);var n=this.labels=new THREE.Object3D,r=this.options.axisHelper.position,o=this.options.axisHelper.size,s=this.options.axisHelper.labels,a={fontsize:64,backgroundColor:{r:255,g:200,b:200,a:.7}},h=e(s.x,a);return h.position.set(r.x+o,r.y,r.z),n.add(h),a.backgroundColor={r:200,g:255,b:200,a:.7},h=e(s.y,a),h.position.set(r.x,r.y+o,r.z),n.add(h),a.backgroundColor={r:200,g:200,b:255,a:.7},h=e(s.z,a),h.position.set(r.x,r.y,r.z+o),n.add(h),this.scene.add(n),n},t.prototype.axisHelper=function(t){if(this.axis)t||(this.scene.remove(this.axis),this.axis=null);else if(t){var e=this.options.axisHelper;if(this.axis=new THREE.AxisHelper(e.size),e.position&&(this.axis.position.set(e.position.x,e.position.y,e.position.z),e.labels)){var i=e.size/100;this.addLabels(i)}this.scene.add(this.axis)}this.options.axisHelper.on=t},t.prototype.addControls=function(){this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.25,this.controls.enableZoom=!0,this.controls.userPanSpeed=2e4},t.prototype.addFirstPersonControls=function(){this.controls=new THREE.FirstPersonControls(this.camera,this.renderer.domElement)},t.prototype.addFlyControls=function(){this.controls=new THREE.FlyControls(this.camera,this.renderer.domElement),this.controls.movementSpeed=this.options.radius,this.controls.domElement=this.container,this.controls.rollSpeed=24*Math.PI,this.controls.autoForward=!1,this.controls.dragToLook=!1},t.prototype.addLights=function(){var t=this.options.lights;this.lights[0]=new THREE.AmbientLight(t.ambient.color),this.scene.add(this.lights[0]);var e=t.directional;this.lights[1]=new THREE.DirectionalLight(e.color),this.lights[1].position.set(e.center.x+e.position.dx,e.center.y+e.position.dy,e.center.z+e.position.dz),this.scene.add(this.lights[1]),this.lights[2]=new THREE.DirectionalLight(e.color),this.lights[2].position.set(e.center.x+e.position.dx,e.center.y+e.position.dy,e.center.z-e.position.dz),this.scene.add(this.lights[2])},t.prototype.updateLights=function(){this.scene.remove(this.lights[0]),this.scene.remove(this.lights[1]),this.scene.remove(this.lights[2]),this.addLights()},t}(),_=function(t){function i(){t.call(this),this.state={world:null,dataContainer:null,get isAllVisible(){if(this.state.world&&this.state.world.scene)return!this.state.dataContainer.children.some(function(t){return!t.visible})}}}return e(i,t),i.prototype.destroy=function(){var t=this.state;t.world&&(t.world.destroy(),t.world=null,t.dataContainer=null,this.dispatchEvent({type:"objects.changed",objects:[]}))},i.prototype.remove=function(t){var e=!1;return this.state.dataContainer&&(this.state.dataContainer.remove(t),e=this.state.dataContainer.children.length>0,e?(this.resize(),this.dispatchEvent({type:"objects.changed",objects:this.state.dataContainer.children})):this.destroy()),e},i.prototype.resize=function(){var t=(new THREE.Box3).setFromObject(this.state.dataContainer),e=t.getCenter(),i=t.getBoundingSphere().radius,n=2.5*i,r={radius:i,axisHelper:{on:!0,size:i,position:{x:e.x,y:e.y,z:e.z},labels:{x:" East ",y:" North ",z:" Elevation "}},camera:{far:250*n,near:.01*i,lookAt:{x:e.x,y:e.y,z:e.z}},lights:{directional:{center:{x:e.x,y:e.y,z:e.z},position:{dx:i,dy:-i,dz:n}}}};this.state.world.resize(r)},i.prototype.show=function(t){var e;return e=this.state.dataContainer?this.extend(t):this.create(t),this.dispatchEvent({type:"objects.changed",objects:this.state.dataContainer.children}),e},i.prototype.create=function(t){var e=this.state,i=new THREE.Object3D;i.add(t),e.dataContainer=i;var n=(new THREE.Box3).setFromObject(t),r=n.getCenter();t.userData.center=r;var o=n.getBoundingSphere().radius,s=4*o,a={radius:o,axisHelper:{on:!0,size:o,position:{x:r.x,y:r.y,z:r.z},labels:{x:" East ",y:" North ",z:" Elevation "}},camera:{far:250*s,near:.01*o,up:{x:0,y:0,z:1},position:{x:r.x,y:r.y-3*o,z:r.z+o},lookAt:{x:r.x,y:r.y,z:r.z}},lights:{directional:{center:{x:r.x,y:r.y,z:r.z},position:{dx:o,dy:o,dz:s}}}};return e.world&&(e.world.destroy(),e.world=null),e.world=new N(this.element,a),this.add(this.state.dataContainer),this.dispatchEvent({type:"world.created",world:e.world}),e.world},i.prototype.add=function(t){this.state.world.scene.add(t),this.state.world.dataContainer=t},i.prototype.extend=function(t){var e=(new THREE.Box3).setFromObject(t).getCenter();t.userData.center=e,this.state.dataContainer.add(t);var i=(new THREE.Box3).setFromObject(this.state.dataContainer);e=i.getCenter();var n=i.getBoundingSphere().radius,r=4*n,o={radius:n,axisHelper:{on:!0,size:n,position:{x:e.x,y:e.y,z:e.z},labels:{x:" East ",y:" North ",z:" Elevation "}},camera:{far:250*r,near:.01*n,up:{x:0,y:0,z:1},position:{x:e.x,y:e.y-3*n,z:e.z+n},lookAt:{x:e.x,y:e.y,z:e.z}},lights:{directional:{center:{x:e.x,y:e.y,z:e.z},position:{dx:n,dy:-n,dz:r}}}};return this.state.world.update(o),this.state.world},i}(THREE.EventDispatcher),G=function(){function t(t){var e=this;this.eventdispatcher=t,this.callbacks=[],t.addEventListener("world.created",function(t){e.world=t.world,e.flushCallbacks(t.world)}),t.addEventListener("world.destroyed",function(t){e.world=null,e.flushCallbacks(null)})}return t.prototype.flushCallbacks=function(t){this.callbacks&&(this.callbacks.forEach(function(e){e(t)}),this.callbacks=[])},t.prototype.onChange=function(t){var e=this;return setTimeout(function(){return t(e.world)}),this.callbacks.push(t),this},t}(),X=function(t){function i(){t.apply(this,arguments)}return e(i,t),i.prototype.set=function(t){t?this.on():this.off()},i.prototype.on=function(){this.world&&(this.world.labels.visible=!0)},i.prototype.off=function(){this.world&&(this.world.labels.visible=!1)},i}(G),W=function(t){function i(){t.apply(this,arguments)}return e(i,t),i.prototype.set=function(t){this.world&&(this.world.dataContainer.scale.z=t)},i}(G),Z=function(){function t(t,e){function i(t){t.stopPropagation(),t.preventDefault()}function n(t){t.stopPropagation(),t.preventDefault()}function r(t){t.stopPropagation(),t.preventDefault();var e=t.dataTransfer,i=e.files;o(i)}function o(t){if(t)for(var i=0;i<t.length;i++)e(t.item(i))}if(!e||"function"!=typeof e)throw Error("No file handler provided");if(!t)throw Error("No element provided");t.addEventListener("dragenter",i,!1),t.addEventListener("dragover",n,!1),t.addEventListener("drop",r,!1)}return t}(),U=function(){function t(){}return t.prototype.getBase=function(){return t.workerBase},t.workerBase="",t}(),q=function(){function t(){}return t.transform=function(t){var e;return t.types?(t.types.forEach(function(t){"TSurf"===t.type?e=g(t):"PLine"===t.type?e=m(t):"VSet"===t.type&&(e=b(t))}),e.userData={header:t.types[0].header,coordinateSystem:t.types[0].coordinateSystem},e):null},t}(),K=(function(t){function i(){t.apply(this,arguments)}return e(i,t),i}(THREE.Object3D),function(t){function i(){t.apply(this,arguments)}return e(i,t),i.prototype.parse=function(t,e){var n=this;return new Promise(function(e){var r=new Worker(n.getBase()+i.WORKER_NAME);r.addEventListener("message",function(t){console.log("worker geojson.js finished"),console.log(t.data),e(t.data)}),r.postMessage(t)})},i.WORKER_NAME="gocad.js",i}(U)),Y=function(t){function i(){t.apply(this,arguments)}return e(i,t),i.prototype.parse=function(t,e){var n=this;return new Promise(function(e){var r=new Worker(n.getBase()+i.WORKER_NAME);r.addEventListener("message",function(t){console.log("worker geojson.js finished"),console.log(t.data),e(t.data)}),r.postMessage(t)})},i.WORKER_NAME="geojson.js",i}(U);t.loadBorders=x,t.loadBstones=y,t.TSurfLoader=I,t.loadPLine=m,t.loadTSurf=g,t.loadVSet=b,t.Shaders=B,t.DefaultWorldFactory=_,t.LabelSwitch=X,t.VerticalExagerate=W,t.FileDrop=Z,t.Parser=U,t.Transformer=q,t.GocadParser=K,t.GeoJsonParser=Y,t.CoordinateSystem=w,t.Document=D,t.PLine=S,t.PLineHeader=H,t.Properties=P,t.TSolid=z,t.TSurf=C,t.TypeFactory=M,t.Unknown=A,t.Vertex=V,t.VSet=L,t.VSetHeader=k,t.deepMerge=f,t.EventDispatcher=T,t.LinePusher=j,t.LineReader=F,t.range=v,t.parseXml=E,t.toBool=o,t.flowThru=s,t.toColor=a,t.Header=R,t.atom=n,t.vertex=r,t.Type=O,Object.defineProperty(t,"__esModule",{value:!0})});