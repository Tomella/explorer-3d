"function"!=typeof Object.assign&&(Object.assign=function(t,e){"use strict";if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var r=Object(t),i=1;i<arguments.length;i++){var n=arguments[i];if(null!=n)for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(r[o]=n[o])}return r});var __awaiter=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))(function(n,o){function s(t){try{h(i.next(t))}catch(t){o(t)}}function a(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){t.done?n(t.value):new r(function(e){e(t.value)}).then(s,a)}h((i=i.apply(t,e)).next())})},__generator=this&&this.__generator||function(t,e){function r(t){return function(e){return i([t,e])}}function i(r){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,o&&(s=o[2&r[0]?"return":r[0]?"throw":"next"])&&!(s=s.call(o,r[1])).done)return s;switch(o=0,s&&(r=[0,s.value]),r[0]){case 0:case 1:s=r;break;case 4:return a.label++,{value:r[1],done:!1};case 5:a.label++,o=r[1],r=[0];continue;case 7:r=a.ops.pop(),a.trys.pop();continue;default:if(s=a.trys,!(s=s.length>0&&s[s.length-1])&&(6===r[0]||2===r[0])){a=0;continue}if(3===r[0]&&(!s||r[1]>s[0]&&r[1]<s[3])){a.label=r[1];break}if(6===r[0]&&a.label<s[1]){a.label=s[1],s=r;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(r);break}s[2]&&a.ops.pop(),a.trys.pop();continue}r=e.call(t,a)}catch(t){r=[6,t],o=0}finally{n=s=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var n,o,s,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return{next:r(0),throw:r(1),return:r(2)}},Promise=this&&this.Promise||this.ES6Promise;String.prototype.startsWith||(String.prototype.startsWith=function(t,e){return e=e||0,this.substr(e,t.length)===t}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Explorer3d=t.Explorer3d||{})}(this,function(t){"use strict";function e(t,e){function r(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}function r(t,e,r,i){return new(r||(r=Promise))(function(n,o){function s(t){try{h(i.next(t))}catch(t){o(t)}}function a(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){t.done?n(t.value):new r(function(e){e(t.value)}).then(s,a)}h((i=i.apply(t,e)).next())})}function i(t){var e=t.split(/\s+/g),r=(e.length,{get xyz(){return[this.x,this.y,this.z]}});return e.forEach(function(t,e){switch(e){case 0:break;case 1:r.index=parseInt(t)-1;break;case 2:r.vertexId=parseFloat(t)-1;break;case 3:r.properties=[];default:r.properties.push(t)}}),r}function n(t){var e=t.split(/\s+/g);return{id:+e[1]-1,vertices:[+e[2]-1,+e[3]-1]}}function o(t){var e=t.split(/\s+/g);return parseInt(e[1])-1}function s(t){var e=t.split(/\s+/g),r=e.length,i={get abc(){return[this.a,this.b,this.c]}};return 4===r&&(i.a=parseInt(e[1])-1,i.b=parseFloat(e[2])-1,i.c=parseFloat(e[3])-1),i}function a(t,e,r){var i=t.split(/\s+/g),n=(i.length,r?r:1),o=[],s={get xyz(){return[this.x,this.y,this.z]},get all(){var t=[this.x,this.y,this.z];return this.properties&&this.properties.forEach(function(e){t.push(e)}),t}};return i.forEach(function(t,e){switch(e){case 0:break;case 1:s.index=+t-1;break;case 2:o[0]=+t;break;case 3:o[1]=+t;break;case 4:s.z=+t*n;break;case 5:s.properties=[];default:s.properties.push(t)}}),e&&(o=e(o)),s.x=o[0],s.y=o[1],s}function h(t){return t.split(/\s+/g).map(function(t){return t.replace(/\"/g,"")})}function c(t){return t=t.trim(),u(t)&&0!==t.indexOf("#")}function u(t){return 0!==t.trim().length}function l(t){return t}function p(t){return"true"===t}function f(t){if(t){var e=t.trim().split(/\s+/g);return 1===e.length&&0===e[0].indexOf("#")?parseInt("0x"+e[0].substring(1)):255*parseFloat(e[0])*256*256+255*parseFloat(e[1])*256+255*parseFloat(e[2])}return null}function d(t){var e=t.split(/\s+/g);return[parseInt(e[1])-1,parseInt(e[2])-1]}function y(t){var e=t.split(/\s+/g);return[parseInt(e[1]),parseInt(e[2]),parseInt(e[3]),parseInt(e[4])]}function v(t){return t}function m(t){var e=new THREE.Geometry;return t.borders.forEach(function(r){var i=t.vertices[r[0]];e.vertices.push(new THREE.Vector3(i[0],i[1],i[2])),i=t.vertices[r[1]],e.vertices.push(new THREE.Vector3(i[0],i[1],i[2]))}),e.vertices.length?(e.computeBoundingBox(),new THREE.LineSegments(e,new THREE.LineBasicMaterial({linewidth:10,color:16711935}))):null}function g(t){var e=new THREE.Geometry;if(t.bstones.forEach(function(r){var i=t.vertices[r];if(i){var n=new THREE.Vector3(i[0],i[1],i[2]);e.vertices.push(n)}}),e.vertices.length){e.computeBoundingBox();var r=new THREE.PointsMaterial({size:16384});return new THREE.Points(e,r)}return null}function b(t,e){var r=Array.isArray(e),i=r&&[]||{};if(Array.isArray(e)){var n=i;t=t||[],n=n.concat(t),e.forEach(function(e,r){"undefined"==typeof n[r]?n[r]=e:"object"==typeof e?n[r]=b(t[r],e):t.indexOf(e)===-1&&n.push(e)})}else t&&"object"==typeof t&&Object.keys(t).forEach(function(e){i[e]=t[e]}),Object.keys(e).forEach(function(r){"object"==typeof e[r]&&e[r]&&t[r]?i[r]=b(t[r],e[r]):i[r]=e[r]});return i}var E=function(){function t(){}return t.prototype.addEventListener=function(t,e){void 0===this.listeners&&(this.listeners={});var r=this.listeners;void 0===r[t]&&(r[t]=[]),r[t].indexOf(e)===-1&&r[t].push(e)},t.prototype.hasEventListener=function(t,e){if(void 0===this.listeners)return!1;var r=this.listeners;return void 0!==r[t]&&r[t].indexOf(e)!==-1},t.prototype.removeEventListener=function(t,e){if(void 0!==this.listeners){var r=this.listeners[t];void 0!==r&&(this.listeners[t]=r.filter(function(t){return e!==t}))}},t.prototype.dispatchEvent=function(t){var e=this,r=this.listeners;if(void 0!==r){var i=r[t.type];void 0!==i&&(t.target=this,i.forEach(function(r){return r.call(e,t)}))}},t.prototype.removeAllListeners=function(){this.listeners=void 0},t}(),w=function(t){function r(){var e=t.call(this)||this;return e.complete=!1,e}return e(r,t),r}(E),x=function(){function t(){}return t}();x.names=["bstones","borders","complete","header","vertices","faces","lines","properties"];var T=function(){function t(t,e,r){this.type=t,this.data=e,this.target=r}return t}(),k=function(){function t(t,e){this.min=t,this.max=e}return t}(),z=function(){function t(t,e,r){this.x=t,this.y=e,this.z=r}return t}(),O=function(){function t(){}return t.fromVertices=function(e){void 0===e&&(e=[]);var r;return e.forEach(function(e){r=t.expand(r,e)}),r},t.expand=function(t,e){return void 0===t&&(t=new k(new z(1/0,1/0,1/0),new z((-(1/0)),(-(1/0)),(-(1/0))))),t.min.x=Math.min(t.min.x,e[0]),t.min.y=Math.min(t.min.y,e[1]),t.min.z=Math.min(t.min.z,e[2]),t.max.x=Math.max(t.max.x,e[0]),t.max.y=Math.max(t.max.y,e[1]),t.max.z=Math.max(t.max.z,e[2]),t},t.toThreeBox3=function(t){return new THREE.Box3(new THREE.Vector3(t.min.x,t.min.y,t.min.z),new THREE.Vector3(t.max.x,t.max.y,t.max.z))},t}(),H=function(){function t(){}return t.subVectors=function(t,e){return new z(t[0]-e[0],t[1]-e[1],t[2]-e[2])},t.cross=function(t,e){var r=t.x,i=t.y,n=t.z,o=e.x,s=e.y,a=e.z,h=i*a-n*s,c=n*o-r*a,u=r*s-i*o;return new z(h,c,u)},t.normalize=function(e){return t.divideScalar(e,t.calcLength(e))},t.calcLength=function(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)},t.divideScalar=function(e,r){return t.multiplyScalar(e,1/r)},t.multiplyScalar=function(t,e){return isFinite(e)?(t.x*=e,t.y*=e,t.z*=e):(t.x=0,t.y=0,t.z=0),t},t}(),S=function(){function t(){}return t.computeNormal=function(t,e){var r=e[t[0]],i=e[t[1]],n=e[t[2]],o=H.subVectors(n,i),s=H.subVectors(r,i);o=H.cross(o,s),H.normalize(o),t[3]=o},t}(),j=function(){function t(){this.type="Type",this.isValid=!1}return t}(),P=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="TSurf",e.vertices=[],e.faces=[],e.bstones=[],e.borders=[],e}return e(r,t),r}(j),R=function(){function t(){this.isValid=!0,this.typeMap={AXIS_NAME:h,AXIS_UNIT:h}}return t}(),B=function(t){function r(){var e=t.call(this)||this;return e.state=0,e}return e(r,t),r}(w),C=function(t){function r(){var e=t.call(this)||this;return e.coordinateSystem=new R,e.validHeader=!1,e}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.coordinateSystem},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsurf pusher");switch(this.state){case 0:return this.hasBlock(t);case 1:return this.pushData(t)}},r.prototype.hasBlock=function(t){if(t=t.trim(),t.length){if("GOCAD_ORIGINAL_COORDINATE_SYSTEM"!==t)return this.complete=!0,this.coordinateSystem.isValid=!1,!1;this.state++}return!0},r.prototype.pushData=function(t){if(c(t))if("END_ORIGINAL_COORDINATE_SYSTEM"!==t){var e=t.indexOf(" ");if(e>0){var r=t.substring(0,e),i=t.substring(e).trim(),n=this.coordinateSystem.typeMap[r]?this.coordinateSystem.typeMap[r]:function(t){return t};this.coordinateSystem[r]=n(i)}}else this.coordinateSystem.typeMap=null,this.complete=!0;return!0},r}(B),L=function(){function t(){}return t.noop=function(){},Object.defineProperty(t,"level",{set:function(e){var r=parseInt(e);if(r=NaN===r?0:r,!t._broken){t.log=console.log;try{t.log("Setting log level")}catch(e){t._broken=!0}}t._broken?(t.log=r>=64?function(){console.log.apply(console,arguments)}:t.noop,t.info=r>=32?function(){console.info.apply(console,arguments)}:t.noop,t.warn=r>=16?function(){console.warn.apply(console,arguments)}:t.noop,t.log=r>=8?function(){console.log.apply(console,arguments)}:t.noop):(t.log=r>=64?console.log:t.noop,t.info=r>=32?console.info:t.noop,t.warn=r>=16?console.warn:t.noop,t.error=r>=8?console.error:t.noop)},enumerable:!0,configurable:!0}),t}();L.LOG_ALL=64,L.LOG_INFO=32,L.LOG_WARN=16,L.LOG_ERROR=8,L.LOG_NOTHING=0,L._broken=!1,L.log=L.noop,L.error=L.noop,L.info=L.noop,L.warn=L.noop;var A=function(){function t(){this.values={},this.typeMap={ivolmap:p,imap:p,parts:p,mesh:p,cn:p,border:p,"*solid*color":f}}return t}(),F=function(t){function r(){var e=t.call(this)||this;return e.header=new A,e}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.header},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(!c(t))return!0;if(t=t.trim(),0===t.indexOf("}"))this.postLoad();else{var e=t.split(":");if(2===e.length){var r=this.header.typeMap[e[0]];r=r?r:l,this.header.values[e[0]]=r(e[1])}else L.warn("That doesn't look like a pair: "+t)}return!0},r.prototype.postLoad=function(){this.complete=!0;var t=this.header;t.name=t.values.name,t.solidColor=t.values["*solid*color"],t.solidColor=t.solidColor?t.solidColor:15658734,t.typeMap=null},r}(w),V=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.tsurf=new P,r.zSign=1,r.readTface=!1,r.verticesBuffer=[],r.facesBuffer=[],r.bordersBuffer=[],r.bstonesBuffer=[],r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.tsurf},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsurf pusher");switch(this.state){case 0:return this.waitForHead(t);case 1:return this.loadHeader(t);case 2:return this.loadCs(t);case 3:return this.waitForTface(t);case 4:return this.processToEnd(t)}},r.prototype.waitForHead=function(t){return t.startsWith("HEADER")&&(t.indexOf("{")===-1?this.complete=!0:this.headerPusher=new F,this.state++),!0},r.prototype.loadHeader=function(t){return this.headerPusher.push(t),this.headerPusher.complete&&(this.tsurf.header=this.headerPusher.obj,this.csPusher=new C,this.state++),!0},r.prototype.loadCs=function(t){return this.csPusher.push(t),this.csPusher.complete&&(this.csPusher.obj.isValid&&(this.tsurf.coordinateSystem=this.csPusher.obj,this.zSign="Depth"===this.tsurf.coordinateSystem.ZPOSITIVE?-1:1),this.state++,this.dispatchEvent(new T("header",this.tsurf))),!0},r.prototype.waitForTface=function(t){return t.indexOf("TFACE")||this.state++,!0},r.prototype.processToEnd=function(t){if(t=t.trim(),"END"===t)this.complete=!0,this.state=99,this.flushVertices(),this.flushFaces(),this.flushBstones(),this.flushBorders(),this.tsurf.vertices=[],this.dispatchEvent(new T("complete",{header:this.tsurf.header,coordinateSystem:this.tsurf.coordinateSystem,bbox:this.tsurf.bbox}));else{var e=this.tsurf,r=t.indexOf("VRTX");if(0===r||1===r){var h=a(t,this.projectionFn,this.zSign);e.vertices[h.index]=h.all,this.tsurf.bbox=O.expand(this.tsurf.bbox,h.all),this.checkVertices(h.all)}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var c=i(t);this.checkVertices(e.vertices[c.index]=e.vertices[c.vertexId])}else if(0===t.indexOf("TRGL")){var u=s(t).abc;S.computeNormal(u,this.tsurf.vertices),this.checkFaces(u)}else if(0===t.indexOf("BSTONE")){var l=o(t);this.checkBstones(l)}else if(0===t.indexOf("BORDER")){var p=n(t);this.checkBorders([p.vertices[0],p.vertices[1]])}}return!0},r.prototype.checkVertices=function(t){this.verticesBuffer.push(t),this.verticesBuffer.length>=r.PAGE_SIZE&&this.flushVertices()},r.prototype.flushVertices=function(){this.verticesBuffer=this.flush("vertices",this.verticesBuffer)},r.prototype.checkFaces=function(t){this.facesBuffer.push(t),this.facesBuffer.length>=r.PAGE_SIZE&&this.flushFaces()},r.prototype.flushFaces=function(){this.facesBuffer=this.flush("faces",this.facesBuffer)},r.prototype.checkBorders=function(t){this.bordersBuffer.push(t),this.bordersBuffer.length>=r.PAGE_SIZE&&this.flushBorders()},r.prototype.flushBorders=function(){this.bordersBuffer=this.flush("borders",this.bordersBuffer)},r.prototype.checkBstones=function(t){this.bstonesBuffer.push(t),this.bstonesBuffer.length>=r.PAGE_SIZE&&this.flushBstones()},r.prototype.flushBstones=function(){this.bstonesBuffer=this.flush("bstones",this.bstonesBuffer)},r.prototype.flush=function(t,e){return e.length&&this.dispatchEvent(new T(t,e)),[]},r}(B);V.PAGE_SIZE=65536;var _=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r}(A),N=function(t){function r(){return t.call(this)||this}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.plineHeader},enumerable:!0,configurable:!0}),r.prototype.push=function(e){var r=t.prototype.push.call(this,e);if(this.complete){this.complete=!0,this.plineHeader=Object.assign(new _,this.header),this.plineHeader.typeMap=null,this.plineHeader.paintedVariable=this.plineHeader.values["*painted*variable"];var i=this.plineHeader.values["*line*color"];this.plineHeader.color=i?f(i):255}return r},r}(F),M=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="PLine",e.vertices=[],e.lines=[],e}return e(r,t),r}(j),I=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.pline=new M,r.verticesBuffer=[],r.segmentsBuffer=[],r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.pline},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsolid pusher");switch(this.state){case 0:return this.expectHeader(t);case 1:return this.pushHeader(t);case 2:return this.pushCs(t);case 3:return this.expectIline(t);case 4:return this.pushData(t)}return!0},r.prototype.expectHeader=function(t){return t=t.trim(),!t.startsWith("HEADER")||(t&&t.indexOf("{")!==-1?(this.child=new N,this.state++,!0):(this.complete=!0,!0))},r.prototype.pushHeader=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.pline.header=this.child.obj,this.child=new C),e},r.prototype.pushCs=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.child.isValid&&(this.pline.coordinateSystem=this.child.obj,this.zSign="Depth"===this.pline.coordinateSystem.ZPOSITIVE?-1:1),this.dispatchEvent(new T("header",this.pline))),e},r.prototype.expectIline=function(t){return t.startsWith("ILINE")&&this.state++,!0},r.prototype.pushData=function(t){if(void 0===t&&(t=""),t=t.trim(),!t)return!0;var e=this.pline;if(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")){var r=a(t,this.projectionFn,this.zSign);this.verticesBuffer[r.index]=r.all,e.bbox=O.expand(e.bbox,r.all)}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var n=i(t),r=this.verticesBuffer[n.vertexId];this.verticesBuffer[n.index]=r}else if(0===t.indexOf("SEG")){var o=d(t);this.segmentsBuffer.push(this.verticesBuffer[o[0]]),this.segmentsBuffer.push(this.verticesBuffer[o[1]]),this.checkSegments()}else 0!==t.indexOf("ILINE")&&0!==t.indexOf("END")||(this.complete=0===t.indexOf("END"),this.verticesBuffer=[],this.complete&&(this.flushSegments(),this.dispatchEvent(new T("complete",{header:e.header,coordinateSystem:e.coordinateSystem,bbox:e.bbox}))));return!0},r.prototype.checkSegments=function(){this.segmentsBuffer.length>=r.PAGE_SIZE&&this.flushSegments()},r.prototype.flushSegments=function(){this.segmentsBuffer=this.flush("vertices",this.segmentsBuffer)},r.prototype.flush=function(t,e){return e.length&&this.dispatchEvent(new T(t,e)),[]},r}(B);I.PAGE_SIZE=32768;var D=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="TSolid",e.vertices=[],e.tetras=[],e}return e(r,t),r}(j),W=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.tsolid=new D,r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.tsolid},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsolid pusher");switch(this.state){case 0:return this.expectHeader(t);case 1:return this.pushHeader(t);case 2:return this.pushCs(t);case 3:return this.expectTvolume(t);case 4:return this.pushData(t)}return!0},r.prototype.expectHeader=function(t){return t.startsWith("HEADER")&&(this.child=new F,this.state++),!0},r.prototype.pushHeader=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.tsolid.header=this.child.obj,this.child=new C),e},r.prototype.pushCs=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.tsolid.coordinateSystem=this.child.obj,this.zSign="Depth"===this.tsolid.coordinateSystem.ZPOSITIVE?-1:1),e},r.prototype.expectTvolume=function(t){return t.startsWith("TVOLUME")&&this.state++,!0},r.prototype.pushData=function(t){if(t=t.trim(),"END"===t)if(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")){var e=a(t,this.projectionFn,this.zSign);this.tsolid.vertices[e.index]=e.all}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var r=i(t);this.tsolid.vertices[r.index]=this.tsolid.vertices[r.vertexId]}else 0===t.indexOf("TETRA")&&this.tsolid.tetras.push(y(t));else this.complete=!0;return!0},r}(B),G=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="VSet",e.vertices=[],e}return e(r,t),r}(j),Z=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r}(A),X=function(t){function r(){return t.call(this)||this}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.vsetHeader},enumerable:!0,configurable:!0}),r.prototype.push=function(e){var r=t.prototype.push.call(this,e);return this.complete&&(this.complete=!0,this.vsetHeader=Object.assign(new Z,this.header),this.vsetHeader.color=f(this.vsetHeader.values["*atoms*color"])),r},r}(F),q=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.verticesBuffer=[],r.vset=new G,r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.vset},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsolid pusher");switch(this.state){case 0:return this.expectHeader(t);case 1:return this.pushHeader(t);case 2:return this.pushCs(t);case 3:return this.pushData(t)}return!0},r.prototype.expectHeader=function(t){return void 0===t&&(t=""),t=t.trim(),!t.startsWith("HEADER")||(t.indexOf("{")===-1&&(this.complete=!0),this.child=new X,this.state++,!0)},r.prototype.pushHeader=function(t){void 0===t&&(t="");var e=this.child.push(t);return this.child.complete&&(this.state++,this.vset.header=this.child.obj,this.child=new C,this.zSign=1,this.dispatchEvent(new T("header",this.vset))),e},r.prototype.pushCs=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.vset.coordinateSystem=this.child.obj,this.zSign="Depth"===this.vset.coordinateSystem.ZPOSITIVE?-1:1),e},r.prototype.pushData=function(t){if(void 0===t&&(t=""),t=t.trim())if(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")){var e=a(t,this.projectionFn,this.zSign);this.vset.bbox=O.expand(this.vset.bbox,e.all),this.checkVertices(e.all)}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var r=i(t);this.checkVertices(this.vset.vertices[r.vertexId])}else t.startsWith("END")&&!t.startsWith("END_")&&(this.complete=!0,this.flushVertices(),this.dispatchEvent(new T("complete",{header:this.vset.header,coordinateSystem:this.vset.coordinateSystem,bbox:this.vset.bbox})));return!0},r.prototype.checkVertices=function(t){this.verticesBuffer.push(t),this.verticesBuffer.length>=r.PAGE_SIZE&&this.flushVertices()},r.prototype.flushVertices=function(){this.verticesBuffer=this.flush("vertices",this.verticesBuffer)},r.prototype.flush=function(t,e){return e.length&&this.dispatchEvent(new T(t,e)),[]},r}(B);q.PAGE_SIZE=65536;var K=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="Unknown",e}return e(r,t),r}(j),U=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.unknown=new K,r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.unknown},enumerable:!0,configurable:!0}),r.prototype.push=function(t){return"END"===t.trim()&&(this.complete=!0),!0},r}(w),J=function(){function t(){this.isValid=!1}return t}(),Y=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.typeFactory=new J,r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.type.obj},enumerable:!0,configurable:!0}),r.prototype.push=function(t){var e=!0;return this.type?(e=this.type.push(t),this.complete=this.type.complete):e=this.create(t),e},r.prototype.create=function(t){function e(t){L.log("TFP: "+t.type),n.dispatchEvent(t)}var r=this;t=t.trim();var i=t.split(/\s+/g);this.typeFactory.isValid=3===i.length&&"GOCAD"===i[0]&&("1.0"===i[2]||"1"===i[2]),this.typeFactory.isValid&&(this.typeFactory.version=i[2],"TSurf"===i[1]?this.type=new V(this.projectionFn):"PLine"===i[1]?this.type=new I(this.projectionFn):"TSolid"===i[1]?this.type=new W(this.projectionFn):"VSet"===i[1]?this.type=new q(this.projectionFn):this.type=new U(this.projectionFn));var n=this;return x.names.forEach(function(t){return r.type.addEventListener(t,e)}),this.typeFactory.isValid},r}(w),Q=function(){function t(){this.types=[]}return t}(),$=function(t){function r(){var e=t.call(this)||this;return e.types=[],e}return e(r,t),r}(Q),tt=function(t){function r(e,r){var i=t.call(this)||this;return i.proj4=r,i.eventHandler=function(t){L.log("DP: "+t.type),i.dispatchEvent(t)},i.proj4.defs("EPSG:3112","+proj=lcc +lat_1=-18 +lat_2=-36 +lat_0=0 +lon_0=134 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"),e&&e.from&&e.to&&e.from!==e.to?i.projectionFn=function(t,e){return function(i){return r(t,e,[i[0],i[1]])}}(e.from,e.to):i.projectionFn=v,i.document=new $,i.typefactorypusher=i.createTypeFactoryPusher(i.projectionFn),i}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.document},enumerable:!0,configurable:!0}),r.prototype.push=function(t){var e=this.typefactorypusher.push(t);return e?(this.typefactorypusher.complete&&(this.complete=!0,this.document.types.push(this.typefactorypusher.obj),this.destroyTypeFactoryPusher(this.typefactorypusher),this.typefactorypusher=this.createTypeFactoryPusher(this.projectionFn)),!0):(L.log("NOT PUSHED: "+t),this.push(t),!0)},r.prototype.createTypeFactoryPusher=function(t){var e=this,r=new Y(t);return x.names.forEach(function(t){r.addEventListener(t,e.eventHandler)}),r},r.prototype.destroyTypeFactoryPusher=function(t){var e=this;x.names.forEach(function(r){t.removeEventListener(r,e.eventHandler)})},r}(w),et=function(){function t(t){this.callback=t}return t.prototype.receiver=function(t){var e=this;t.forEach(function(t){e.callback(t)})},t}(),rt=function(){function t(t,e,r){this.file=t,this.callback=r,this.blockSize=16384,this.file=t,this.length=t.size,this.pageNo=-1,this.index=0,this.blockSize=e.blockSize?e.blockSize:this.blockSize,this.reader,this.lineBuffer=[],this.reader=new FileReader}return t.prototype.start=function(){return r(this,void 0,void 0,function(){var t,e,r,i,n;return __generator(this,function(o){switch(o.label){case 0:return[4,this.read()];case 1:t=o.sent(),e=[],o.label=2;case 2:if(!t)return[3,8];switch(r=this.next(),i=r.state){case"more":return[3,3];case"line":return[3,5];case"complete":return[3,6]}return[3,7];case 3:n=e,e=[];try{this.callback(n)}catch(t){L.error(t),L.error("Someone died. Continue on.\n\n"+n.join("\n").substr(0,2e3))}return[4,this.read()];case 4:return t=o.sent(),[3,7];case 5:return e.push(r.line),[3,7];case 6:if(e.push(r.line),e.length)try{this.callback(e)}catch(t){L.error(t),L.error("Someone died. Continue on.\n\n"+e.join("\n").substr(0,2e3))}return t=!1,[3,7];case 7:return[3,2];case 8:return[2]}})})},t.prototype.read=function(){return r(this,void 0,void 0,function(){var t,e,r=this;return __generator(this,function(i){return this.pageNo++,this.index=0,t=this,e=this.pageNo*this.blockSize,L.log("Block size: "+this.blockSize+", file size: "+this.length),[2,new Promise(function(i){if(e>=r.length)return void i(!1);try{t.reader.onloadend=function(e){L.log("We have loaded with ready state = "+e.target.readyState),e.target.readyState===FileReader.prototype.DONE&&(L.log("Reading page "+t.pageNo),t.buffer=e.target.result,i(r.hasMore()))},t.reader.onerror=function(t){L.log("What do you mean, error")};var n=t.file.slice(e,e+t.blockSize);t.reader.readAsText(n)}catch(t){L.log(t)}})]})})},t.prototype.hasMore=function(){return this.index+this.blockSize*this.pageNo<this.length-1},t.prototype.next=function(){for(;this.hasMore();){if(!this.buffer||this.index>=this.blockSize)return{state:"more"};var t=this.buffer[this.index++];if("\r"!==t){if("\n"===t)break;this.lineBuffer.push(t)}}var e=this.lineBuffer.join("");return this.lineBuffer=[],{state:this.hasMore()?"line":"complete",line:e}},t}(),it=function(){function t(t,e,r){void 0===r&&(r=window);var i=this;this.renderer=t,this.camera=e,this.container=r,this.update=function(){var t=i.container.getBoundingClientRect();i.renderer.setSize(t.width,t.height),i.camera.aspect=t.width/t.height,i.camera.updateProjectionMatrix()},window.addEventListener("resize",this.update,!1)}return t.prototype.resize=function(){this.update()},t.prototype.destroy=function(){window.removeEventListener("resize",this.update)},t}(),nt=function(){function t(t,e){function r(){a.continueAnimation&&(window.requestAnimationFrame(r),a.camera.lookAt(a.lookAt),a.renderer.render(a.scene,a.camera),a.controls.update(.02))}void 0===e&&(e={}),this.options={camera:{fov:45,near:.1,far:5e5,position:{x:-30,y:40,z:30},up:{x:0,y:1,z:0}},lights:{ambient:{color:5592405},directional:{color:10526880,center:{x:0,y:0,z:0},position:{dx:50,dy:10,dz:-300}}},axisHelper:{on:!0,size:20}},this.lights=[],this.options=b(this.options,e);var i=document.body.getBoundingClientRect();"string"==typeof t?this.container=document.getElementById(""+t):this.container=t,this.scene=new THREE.Scene,this.renderer=new THREE.WebGLRenderer({clearColor:16711680}),this.renderer.setSize(i.width,i.height);var n=this.options.camera;this.camera=new THREE.PerspectiveCamera(n.fov,i.width/i.height,n.near,n.far),this.camera.up.set(n.up.x,n.up.y,n.up.z);var o=n.position;if(this.camera.position.x=o.x,this.camera.position.y=o.y,this.camera.position.z=o.z,e.camera.lookAt){var s=e.camera.lookAt;this.lookAt=new THREE.Vector3(s.x,s.y,s.z)}else this.lookAt=this.scene.position;this.camera.lookAt(this.lookAt),this.container.appendChild(this.renderer.domElement),this.renderer.render(this.scene,this.camera),this.axisHelper(this.options.axisHelper.on),this.addLights(),this.addFlyControls(),this.resizer=new it(this.renderer,this.camera,this.container);var a=this;this.continueAnimation=!0,this.resizer.resize(),r()}return t.prototype.destroy=function(){for(this.lights=[],this.axis=null,this.renderer.dispose(),this.renderer=null,this.dataContainer.children.forEach(function(t){t.geometry.dispose(),t.material.dispose()}),this.scene.remove(this.dataContainer),this.scene=null,this.camera=null,this.controls.dispose&&this.controls.dispose(),this.controls=null,this.resizer.destroy(),this.resizer=null;this.container.lastChild;)this.container.removeChild(this.container.lastChild);this.continueAnimation=!1},t.prototype.resize=function(t){this.options=b(this.options,t?t:{});var e=this.options.axisHelper.on;this.axisHelper(!1),this.axisHelper(e),this.updateLights();var r=t.camera.lookAt;this.lookAt=new THREE.Vector3(r.x,r.y,r.z),this.camera.far=t.camera.far,this.camera.near=t.camera.near,this.camera.lookAt(this.lookAt)},t.prototype.update=function(t){this.options=b(this.options,t?t:{});var e=this.options.camera;this.camera.up.set(e.up.x,e.up.y,e.up.z);var r=e.position;if(this.camera.position.x=r.x,this.camera.position.y=r.y,this.camera.position.z=r.z,t.camera.lookAt){var i=t.camera.lookAt;this.lookAt=new THREE.Vector3(i.x,i.y,i.z)}else this.lookAt=this.scene.position;this.camera.lookAt(this.lookAt),this.controls.movementSpeed=this.options.radius;var n=this.options.axisHelper.on;this.axisHelper(!1),this.axisHelper(n),this.updateLights()},t.prototype.addLabels=function(t){function e(e,i){var n=b({fontface:"Arial",fontsize:14,borderThickness:4,borderColor:{r:0,g:0,b:0,a:1},backgroundColor:{r:255,g:255,b:255,a:1}},i?i:{}),o=document.createElement("canvas");o.width=256,o.height=128;var s=o.getContext("2d");s.font=n.fontsize+"px "+n.fontface;var a=s.measureText(e),h=a.width;L.log(h),s.fillStyle="rgba("+n.backgroundColor.r+","+n.backgroundColor.g+","+n.backgroundColor.b+","+n.backgroundColor.a+")",s.strokeStyle="rgba("+n.borderColor.r+","+n.borderColor.g+","+n.borderColor.b+","+n.borderColor.a+")",s.lineWidth=n.borderThickness,r(s,n.borderThickness/2,n.borderThickness/2,h+n.borderThickness,1.4*n.fontsize+n.borderThickness,6),s.fillStyle="rgba(0, 0, 0, 1.0)",s.fillText(e,n.borderThickness,n.fontsize+n.borderThickness);var c=new THREE.Texture(o);c.needsUpdate=!0;var u=new THREE.SpriteMaterial({map:c}),l=new THREE.Sprite(u);return l.scale.set(35*t,15*t,1),l}function r(t,e,r,i,n,o){t.beginPath(),t.moveTo(e+o,r),t.lineTo(e+i-o,r),t.quadraticCurveTo(e+i,r,e+i,r+o),t.lineTo(e+i,r+n-o),t.quadraticCurveTo(e+i,r+n,e+i-o,r+n),t.lineTo(e+o,r+n),t.quadraticCurveTo(e,r+n,e,r+n-o),t.lineTo(e,r+o),t.quadraticCurveTo(e,r,e+o,r),t.closePath(),t.fill(),t.stroke()}var i=!0;this.labels&&(i=this.labels.visible,this.scene.remove(this.labels));var n=this.labels=new THREE.Object3D,o=this.options.axisHelper.position,s=this.options.axisHelper.size,a=this.options.axisHelper.labels,h={fontsize:54,backgroundColor:{r:255,g:200,b:200,a:.7}},c=e(a.x,h);return c.position.set(o.x+s,o.y,o.z),n.add(c),h.backgroundColor={r:200,g:255,b:200,a:.7},c=e(a.y,h),c.position.set(o.x,o.y+s,o.z),n.add(c),h.backgroundColor={r:200,g:200,b:255,a:.7},c=e(a.z,h),c.position.set(o.x,o.y,o.z+s),n.add(c),this.scene.add(n),n.visible=i,n},t.prototype.axisHelper=function(t){if(this.axis)t||(this.scene.remove(this.axis),this.axis=null);else if(t){var e=this.options.axisHelper;if(this.axis=new THREE.AxisHelper(e.size),e.position&&(this.axis.position.set(e.position.x,e.position.y,e.position.z),e.labels)){var r=e.size/100;this.addLabels(r)}this.scene.add(this.axis)}this.options.axisHelper.on=t},t.prototype.addControls=function(){this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.25,this.controls.enableZoom=!0,this.controls.userPanSpeed=2e4},t.prototype.addFirstPersonControls=function(){this.controls=new THREE.FirstPersonControls(this.camera,this.renderer.domElement);
},t.prototype.addFlyControls=function(){this.controls=new THREE.FlyControls(this.camera,this.renderer.domElement),this.controls.movementSpeed=this.options.radius,this.controls.domElement=this.container,this.controls.rollSpeed=24*Math.PI,this.controls.autoForward=!1,this.controls.dragToLook=!1},t.prototype.addLights=function(){var t=this.options.lights;this.lights[0]=new THREE.AmbientLight(t.ambient.color),this.scene.add(this.lights[0]);var e=t.directional;this.lights[1]=new THREE.DirectionalLight(e.color),this.lights[1].position.set(e.center.x+e.position.dx,e.center.y+e.position.dy,e.center.z+e.position.dz),this.scene.add(this.lights[1]),this.lights[2]=new THREE.DirectionalLight(e.color),this.lights[2].position.set(e.center.x+e.position.dx,e.center.y+e.position.dy,e.center.z-e.position.dz),this.scene.add(this.lights[2])},t.prototype.updateLights=function(){this.scene.remove(this.lights[0]),this.scene.remove(this.lights[1]),this.scene.remove(this.lights[2]),this.addLights()},t}(),ot=function(t){function r(e){var r=t.call(this)||this;return r.element=e,r.state={world:null,dataContainer:null,get isAllVisible(){if(this.state.world&&this.state.world.scene)return!this.state.dataContainer.children.some(function(t){return!t.visible})}},r}return e(r,t),r.prototype.destroy=function(){this.state.world&&(this.state.world.destroy(),this.state.world=null,this.state.dataContainer=null,this.dispatchEvent({type:"objects.changed",objects:[]}))},r.prototype.remove=function(t){var e=!1;return this.state.dataContainer&&(this.state.dataContainer.remove(t),e=this.state.dataContainer.children.length>0,e?(this.resize(),this.dispatchEvent({type:"objects.changed",objects:this.state.dataContainer.children})):this.destroy()),e},r.prototype.resize=function(){var t=(new THREE.Box3).setFromObject(this.state.dataContainer),e=t.getCenter(),r=t.getBoundingSphere().radius,i=2.5*r,n={radius:r,axisHelper:{on:!0,size:r,position:{x:e.x,y:e.y,z:e.z},labels:{x:" East ",y:" North ",z:" Elevation "}},camera:{far:250*i,near:.01*r,lookAt:{x:e.x,y:e.y,z:e.z}},lights:{directional:{center:{x:e.x,y:e.y,z:e.z},position:{dx:r,dy:-r,dz:i}}}};this.state.world.resize(n)},r.prototype.show=function(t){this.state.dataContainer?this.extend(t):this.create(t),this.dispatchEvent({type:"objects.changed",objects:this.state.dataContainer.children})},r.prototype.create=function(t){this.state.dataContainer=new THREE.Object3D,this.state.dataContainer.add(t);var e=(new THREE.Box3).setFromObject(t),r=e.getCenter();t.userData.center=r;var i=e.getBoundingSphere().radius,n=4*i,o={radius:i,axisHelper:{on:!0,size:i,position:{x:r.x,y:r.y,z:r.z},labels:{x:" East ",y:" North ",z:" Elevation "}},camera:{far:250*n,near:.01*i,up:{x:0,y:0,z:1},position:{x:r.x,y:r.y-3*i,z:r.z+i},lookAt:{x:r.x,y:r.y,z:r.z}},lights:{directional:{center:{x:r.x,y:r.y,z:r.z},position:{dx:i,dy:i,dz:n}}}};this.state.world&&this.state.world.destroy(),this.state.world=new nt(this.element,o),this.add(this.state.dataContainer),this.dispatchEvent({type:"world.created",factory:this})},r.prototype.getWorld=function(){return this.state.world},r.prototype.add=function(t){this.state.world.scene.add(t),this.state.world.dataContainer=t},r.prototype.extend=function(t){var e=(new THREE.Box3).setFromObject(t).getCenter();t.userData.center=e,this.state.dataContainer.add(t);var r=(new THREE.Box3).setFromObject(this.state.dataContainer);e=r.getCenter();var i=r.getBoundingSphere().radius,n=4*i,o={radius:i,axisHelper:{on:!0,size:i,position:{x:e.x,y:e.y,z:e.z},labels:{x:" East ",y:" North ",z:" Elevation "}},camera:{far:250*n,near:.01*i,up:{x:0,y:0,z:1},position:{x:e.x,y:e.y-3*i,z:e.z+i},lookAt:{x:e.x,y:e.y,z:e.z}},lights:{directional:{center:{x:e.x,y:e.y,z:e.z},position:{dx:i,dy:-i,dz:n}}}};this.state.world.update(o)},r}(THREE.EventDispatcher),st=function(){function t(t){var e=this;this.eventdispatcher=t,this.callbacks=[],t.addEventListener("world.created",function(t){e.factory=t.factory,e.flushCallbacks(t.factory)}),t.addEventListener("world.destroyed",function(t){e.factory=null,e.flushCallbacks(null)})}return t.prototype.flushCallbacks=function(t){this.callbacks&&(this.callbacks.forEach(function(e){e(t)}),this.callbacks=[])},t.prototype.onChange=function(t){var e=this;return setTimeout(function(){return t(e.factory)}),this.callbacks.push(t),this},t}(),at=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r.prototype.set=function(t){this.factory&&this.factory.getWorld()&&(this.factory.getWorld().labels.visible=t)},r}(st),ht=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r.prototype.set=function(t){this.factory&&this.factory.getWorld()&&(this.factory.getWorld().dataContainer.scale.z=t)},r}(st),ct=function(){function t(t,e){function r(t){t.stopPropagation(),t.preventDefault(),L.log("dragenter")}function i(t){t.stopPropagation(),t.preventDefault(),L.log("dragover")}function n(t){t.stopPropagation(),t.preventDefault();var e=t.dataTransfer,r=e.files;o(r)}function o(t){if(t)for(var r=0;r<t.length;r++)e(t.item(r))}if(!e||"function"!=typeof e)throw Error("No file handler provided");if(!t)throw Error("No element provided");t.addEventListener("dragenter",r,!1),t.addEventListener("dragover",i,!1),t.addEventListener("drop",n,!1)}return t}(),ut=function(){function t(){}return t.prototype.getWorkersBase=function(){return t.codeBase+"/workers/"},t}();ut.codeBase="";var lt,pt=function(t){function r(){return t.call(this)||this}return e(r,t),r.prototype.destroy=function(){this.removeAllListeners()},r}(E),ft=function(t){function r(){var e=t.call(this)||this;return e.hasColors=!1,e}return e(r,t),r.prototype.destroy=function(){this.geometry=this.pline=this.solidColorObj=this.material=null,t.prototype.destroy.call(this)},r.prototype.pipe=function(t){var e=t.data;switch(t.eventName){case"header":this.processHeader(e);break;case"vertices":this.processVertices(e);break;case"complete":this.complete(e)}},r.prototype.complete=function(t){if(!this.geometry)return this.dispatchEvent(new T("error","We have complete before we even started")),void this.destroy();var e=null,r=this.solidColorObj,i=this.geometry.colors;if(!this.geometry.colors.length&&this.geometry.vertices.length){var n=Math.floor(this.max-this.min);n?(e=new THREE.Lut("rainbow",Math.floor(this.max-this.min)),e.setMax(Math.floor(this.max)),e.setMin(Math.floor(this.min)),this.ws.forEach(function(t){var n=e.getColor(t);n=n?n:r,i.push(n)})):this.geometry.vertices.forEach(function(){i.push(r)})}this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere();var o=new THREE.LineSegments(this.geometry,this.material);o.userData={header:t.header,coordinateSystem:t.coordinateSystem},this.dispatchEvent(new T("complete",o)),this.destroy()},r.prototype.processVertices=function(t){var e=this;if(!this.geometry)return this.dispatchEvent(new T("error","We have vertices before we have the header")),void this.destroy();var r=this.geometry.vertices,i=this.geometry.colors,n=this.solidColorObj;t.forEach(function(t,o){if(r.push(new THREE.Vector3(t[0],t[1],t[2])),t.length<3)i.push(n);else{var s=+t[3];e.min=Math.min(e.min,s),e.max=Math.max(e.max,s),e.ws.push(s)}}),L.log("WE have "+r.length+" vertices now")},r.prototype.processHeader=function(t){if(this.geometry)return this.dispatchEvent(new T("error","We already have processed a header. How did this happen?")),void this.destroy();this.geometry=new THREE.Geometry,this.pline=t;var e=t.header.color?t.header.color:16777215;this.solidColorObj=new THREE.Color(e);var r=t.header.width?t.header.width:10;this.material=new THREE.LineBasicMaterial({linewidth:r,color:e,vertexColors:THREE.VertexColors}),this.min=1/0,this.max=-(1/0),this.ws=[]},r}(pt),dt=function(t){function r(){return t.call(this)||this}return e(r,t),r.prototype.destroy=function(){this.geometry=null,t.prototype.destroy.call(this)},r.prototype.pipe=function(t){var e=t.data;switch(t.eventName){case"header":this.processHeader(e);break;case"vertices":this.processVertices(e);break;case"faces":this.processFaces(e);break;case"complete":this.complete(e)}},r.prototype.complete=function(t){if(!this.geometry)return this.dispatchEvent(new T("error","We have complete before we even started")),void this.destroy();this.geometry.boundingBox=O.toThreeBox3(t.bbox);var e=t.header.solidColor,r=new THREE.MeshLambertMaterial({color:e?e:16716049,side:THREE.DoubleSide}),i=new THREE.Mesh(this.geometry,r);i.userData={header:t.header,coordinateSystem:t.coordinateSystem},this.dispatchEvent(new T("complete",i)),this.destroy()},r.prototype.processFaces=function(t){if(!this.geometry)return this.dispatchEvent(new T("error","We have faces befor we have the header")),void this.destroy();var e=this.geometry.faces;t.forEach(function(t){var r=new THREE.Face3(t[0],t[1],t[2]),i=t[3];r.normal=new THREE.Vector3(i.x,i.y,i.z),e.push(r)})},r.prototype.processVertices=function(t){if(!this.geometry)return this.dispatchEvent(new T("error","We have vertices befor we have the header")),void this.destroy();var e=this.geometry.vertices;t.forEach(function(t){e.push(new THREE.Vector3(t[0],t[1],t[2]))})},r.prototype.processHeader=function(t){return this.geometry?(this.dispatchEvent(new T("error","We already have processed a header. How did this happen?")),void this.destroy()):void(this.geometry=new THREE.Geometry)},r}(pt),yt=function(t){function r(){return t.call(this)||this}return e(r,t),r.prototype.destroy=function(){this.geometry=null,t.prototype.destroy.call(this)},r.prototype.pipe=function(t){var e=t.data;switch(t.eventName){case"header":this.processHeader(e);break;case"vertices":this.processVertices(e);break;case"complete":this.complete(e)}},r.prototype.complete=function(t){if(!this.geometry)return this.dispatchEvent(new T("error","We have complete before we even started")),void this.destroy();var e=new THREE.PointsMaterial({size:16,color:t.header.color});this.geometry.boundingBox=O.toThreeBox3(t.bbox);var r=new THREE.Points(this.geometry,e);this.geometry.computeBoundingSphere(),r.userData={header:t.header,coordinateSystem:t.coordinateSystem},this.dispatchEvent(new T("complete",r)),this.destroy()},r.prototype.processVertices=function(t){if(!this.geometry)return this.dispatchEvent(new T("error","We have vertices before we have the header")),void this.destroy();var e=this.geometry.vertices;t.forEach(function(t){e.push(new THREE.Vector3(t[0],t[1],t[2]))}),L.log("WE have "+e.length+" vertices now")},r.prototype.processHeader=function(t){return this.geometry?(this.dispatchEvent(new T("error","We already have processed a header. How did this happen?")),void this.destroy()):void(this.geometry=new THREE.Geometry)},r}(pt),vt=function(t){function r(){var e=t.call(this)||this;return L.warn("We don't understand this type but we'll soldier on."),e}return e(r,t),r.prototype.pipe=function(t){"complete"===t.eventName&&this.dispatchEvent(new T("complete",{}))},r}(pt);!function(t){t[t.Empty=0]="Empty",t[t.Loading=1]="Loading"}(lt||(lt={}));var mt=function(t){function r(){var e=t.call(this)||this;return e.onEvent=function(t){var r=t;"complete"===t.type&&(r=new T("complete",t.data)),e.dispatchEvent(r),e.destroy()},e.state=lt.Empty,e}return e(r,t),r.prototype.pipe=function(t){switch(this.state){case lt.Empty:this.pipeHeader(t);break;case lt.Loading:this.next.pipe(t)}},r.prototype.pipeHeader=function(t){switch(t.eventName){case"start":break;case"header":var e=t.data;switch(e.type){case"TSurf":this.next=new dt;break;case"PLine":this.next=new ft;break;case"VSet":this.next=new yt;break;default:this.next=new vt}this.next.addEventListener("complete",this.onEvent),this.next.addEventListener("error",this.onEvent),this.next.pipe(t),this.state=lt.Loading}},r.prototype.destroy=function(){this.state===lt.Loading&&(this.next.destroy(),this.state=lt.Empty,this.next=null,t.prototype.destroy.call(this))},r}(pt),gt=function(){function t(){}return t.noop=function(){},Object.defineProperty(t,"level",{set:function(e){var r=parseInt(e);if(r=NaN===r?0:r,!t._broken){t.log=console.log;try{t.log("Setting log level")}catch(e){t._broken=!0}}t._broken?(t.log=r>=64?function(){console.log.apply(console,arguments)}:t.noop,t.info=r>=32?function(){console.info.apply(console,arguments)}:t.noop,t.warn=r>=16?function(){console.warn.apply(console,arguments)}:t.noop,t.log=r>=8?function(){console.log.apply(console,arguments)}:t.noop):(t.log=r>=64?console.log:t.noop,t.info=r>=32?console.info:t.noop,t.warn=r>=16?console.warn:t.noop,t.error=r>=8?console.error:t.noop)},enumerable:!0,configurable:!0}),t}();gt.LOG_ALL=64,gt.LOG_INFO=32,gt.LOG_WARN=16,gt.LOG_ERROR=8,gt.LOG_NOTHING=0,gt._broken=!1,gt.log=gt.noop,gt.error=gt.noop,gt.info=gt.noop,gt.warn=gt.noop;var bt=function(t){function r(e){void 0===e&&(e={});var r=t.call(this)||this;return r.options=e,r}return e(r,t),r.prototype.parse=function(t){var e=this;return new Promise(function(i,n){var o=new Worker(e.getWorkersBase()+r.WORKER_NAME),s=new mt;s.addEventListener("complete",function(t){o.terminate(),i(t.data)}),s.addEventListener("error",function(t){o.terminate(),gt.log("There is an error with your pipes!"),n(t.data)}),o.addEventListener("message",function(t){var e=JSON.parse(t.data);s.pipe(e),gt.log("EVENT = "+e.eventName)}),o.addEventListener("error",function(t){gt.log("There is an error with your worker!"),gt.log(t)}),o.postMessage(t)})},r}(ut);bt.WORKER_NAME="gocadpusher.js";var Et=function(t){function r(e){void 0===e&&(e={});var r=t.call(this)||this;return r.options=e,r}return e(r,t),r.prototype.parse=function(t){var e=this;return new Promise(function(i,n){var o=new Worker(e.getWorkersBase()+r.WORKER_NAME),s=new mt;s.addEventListener("complete",function(t){o.terminate(),i(t.data)}),s.addEventListener("error",function(t){o.terminate(),gt.log("There is an error with your pipes!"),n(t.data)}),o.addEventListener("message",function(t){var e=JSON.parse(t.data);s.pipe(e),gt.log("EVENT = "+e.eventName)}),o.addEventListener("error",function(t){gt.log("There is an error with your worker!"),gt.log(t)}),o.postMessage(t)})},r}(ut);Et.WORKER_NAME="gocadhttppusher.js";var wt=["start","complete","bstones","borders","header","vertices","faces","lines","properties"],xt=function(t){function r(e){void 0===e&&(e={});var r=t.call(this)||this;return r.options=e,r}return e(r,t),r.prototype.parse=function(t){var e=this,r=t.file,i=t.options;return new Promise(function(t,n){var o=new tt(e.options,proj4),s=new et(function(t){o.push(t)}),a=new mt;a.addEventListener("complete",function(e){t(e.data)}),a.addEventListener("error",function(t){gt.log("There is an error with your pipes!"),n(t.data)}),new rt(r,i,function(t){s.receiver(t)}).start().then(function(){gt.log("******************* Local Kaput ****************************")}),wt.forEach(function(t){gt.log("Adding listener: "+t),o.addEventListener(t,function(t){gt.log("GPW: "+t.type),a.pipe({eventName:t.type,data:t.data})})})})},r}(ut),Tt=function(t){function r(e,r){void 0===r&&(r=7);var i=t.call(this)||this;return i.parser=e,i.max=r,i.stack=[],i.count=0,i}return e(r,t),r.prototype.parse=function(t,e){function r(){}function i(){gt.log("We have "+s.count+" jobs queued"),s.count>s.max||s.count<1||n()}function n(){gt.log("Jobs length = "+s.count);var t=s.stack.shift();t&&t.self.parser.parse(t.file,t.options).then(function(e){o(),n(),t.resolver(e)}).catch(function(t){gt.log("Ooops!"),gt.log(t),o()})}function o(){s.count>0&&s.count--}var s=this,a={timestamp:Date.now(),file:t,options:e,self:s},h=new Promise(function(t){a.resolver=t});return this.stack.push(a),this.count++,i(),r(),h},r}(ut);t.loadBorders=m,t.loadBstones=g,t.DefaultWorldFactory=ot,t.LabelSwitch=at,t.VerticalExagerate=ht,t.FileDrop=ct,t.Parser=ut,t.GocadPusherParser=bt,t.HttpGocadPusherParser=Et,t.LocalGocadPusherParser=xt,t.ThrottleProxyParser=Tt,t.DocumentPusher=tt,t.LinesToLinePusher=et,t.LinesPagedPusher=rt,t.Logger=L,Object.defineProperty(t,"__esModule",{value:!0})});