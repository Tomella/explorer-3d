THREE.FlyControls=function(t,e){function i(t,e){return function(){e.apply(t,arguments)}}function n(t){t.preventDefault()}this.object=t,this.domElement=void 0!==e?e:document,e&&this.domElement.setAttribute("tabindex",-1),this.movementSpeed=1,this.rollSpeed=.005,this.dragToLook=!1,this.autoForward=!1,this.tmpQuaternion=new THREE.Quaternion,this.mouseStatus=0,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.moveVector=new THREE.Vector3(0,0,0),this.rotationVector=new THREE.Vector3(0,0,0),this.handleEvent=function(t){"function"==typeof this[t.type]&&this[t.type](t)},this.keydown=function(t){if(!t.altKey){switch(t.keyCode){case 16:this.movementSpeedMultiplier=.1;break;case 87:this.moveState.forward=1;break;case 83:this.moveState.back=1;break;case 65:this.moveState.left=1;break;case 68:this.moveState.right=1;break;case 82:this.moveState.up=1;break;case 70:this.moveState.down=1;break;case 38:this.moveState.pitchUp=1;break;case 40:this.moveState.pitchDown=1;break;case 37:this.moveState.yawLeft=1;break;case 39:this.moveState.yawRight=1;break;case 81:this.moveState.rollLeft=1;break;case 69:this.moveState.rollRight=1}this.updateMovementVector(),this.updateRotationVector()}},this.keyup=function(t){switch(t.keyCode){case 16:this.movementSpeedMultiplier=1;break;case 87:this.moveState.forward=0;break;case 83:this.moveState.back=0;break;case 65:this.moveState.left=0;break;case 68:this.moveState.right=0;break;case 82:this.moveState.up=0;break;case 70:this.moveState.down=0;break;case 38:this.moveState.pitchUp=0;break;case 40:this.moveState.pitchDown=0;break;case 37:this.moveState.yawLeft=0;break;case 39:this.moveState.yawRight=0;break;case 81:this.moveState.rollLeft=0;break;case 69:this.moveState.rollRight=0}this.updateMovementVector(),this.updateRotationVector()},this.mousedown=function(t){if(this.domElement!==document&&this.domElement.focus(),t.preventDefault(),t.stopPropagation(),this.dragToLook)this.mouseStatus++;else{switch(t.button){case 0:this.moveState.forward=1;break;case 2:this.moveState.back=1}this.updateMovementVector()}},this.mousemove=function(t){if(!this.dragToLook||this.mouseStatus>0){var e=this.getContainerDimensions(),i=e.size[0]/2,n=e.size[1]/2;this.moveState.yawLeft=-(t.pageX-e.offset[0]-i)/i,this.moveState.pitchDown=(t.pageY-e.offset[1]-n)/n,this.updateRotationVector()}},this.mouseup=function(t){if(t.preventDefault(),t.stopPropagation(),this.dragToLook)this.mouseStatus--,this.moveState.yawLeft=this.moveState.pitchDown=0;else{switch(t.button){case 0:this.moveState.forward=0;break;case 2:this.moveState.back=0}this.updateMovementVector()}this.updateRotationVector()},this.update=function(t){var e=t*this.movementSpeed,i=t*this.rollSpeed;this.object.translateX(this.moveVector.x*e),this.object.translateY(this.moveVector.y*e),this.object.translateZ(this.moveVector.z*e),this.tmpQuaternion.set(this.rotationVector.x*i,this.rotationVector.y*i,this.rotationVector.z*i,1).normalize(),this.object.quaternion.multiply(this.tmpQuaternion),this.object.rotation.setFromQuaternion(this.object.quaternion,this.object.rotation.order)},this.updateMovementVector=function(){var t=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-t+this.moveState.back},this.updateRotationVector=function(){this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft},this.getContainerDimensions=function(){return this.domElement!=document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}},this.dispose=function(){this.domElement.removeEventListener("contextmenu",n,!1),this.domElement.removeEventListener("mousedown",s,!1),this.domElement.removeEventListener("mousemove",o,!1),this.domElement.removeEventListener("mouseup",r,!1),window.removeEventListener("keydown",a,!1),window.removeEventListener("keyup",h,!1)};var o=i(this,this.mousemove),s=i(this,this.mousedown),r=i(this,this.mouseup),a=i(this,this.keydown),h=i(this,this.keyup);this.domElement.addEventListener("contextmenu",n,!1),this.domElement.addEventListener("mousemove",o,!1),this.domElement.addEventListener("mousedown",s,!1),this.domElement.addEventListener("mouseup",r,!1),window.addEventListener("keydown",a,!1),window.addEventListener("keyup",h,!1),this.updateMovementVector(),this.updateRotationVector()},THREE.Lut=function(t,e){this.lut=[],this.map=THREE.ColorMapKeywords[t],this.n=e,this.mapname=t;for(var i=1/this.n,n=0;n<=1;n+=i)for(var o=0;o<this.map.length-1;o++)if(n>=this.map[o][0]&&n<this.map[o+1][0]){var s=this.map[o][0],r=this.map[o+1][0],a=new THREE.Color(16777215),h=new THREE.Color(16777215).setHex(this.map[o][1]),c=new THREE.Color(16777215).setHex(this.map[o+1][1]);a=h.lerp(c,(n-s)/(r-s)),this.lut.push(a)}return this.set(this)},THREE.Lut.prototype={constructor:THREE.Lut,lut:[],map:[],mapname:"rainbow",n:256,minV:0,maxV:1,legend:null,set:function(t){return t instanceof THREE.Lut&&this.copy(t),this},setMin:function(t){return this.minV=t,this},setMax:function(t){return this.maxV=t,this},changeNumberOfColors:function(t){return this.n=t,new THREE.Lut(this.mapname,this.n)},changeColorMap:function(t){return this.mapname=t,new THREE.Lut(this.mapname,this.n)},copy:function(t){return this.lut=t.lut,this.mapname=t.mapname,this.map=t.map,this.n=t.n,this.minV=t.minV,this.maxV=t.maxV,this},getColor:function(t){t<=this.minV?t=this.minV:t>=this.maxV&&(t=this.maxV),t=(t-this.minV)/(this.maxV-this.minV);var e=Math.round(t*this.n);return e==this.n?e-=1:e,this.lut[e]},addColorMap:function(t,e){THREE.ColorMapKeywords[t]=e},setLegendOn:function(t){void 0===t&&(t={}),this.legend={},this.legend.layout=t.hasOwnProperty("layout")?t.layout:"vertical",this.legend.position=t.hasOwnProperty("position")?t.position:{x:21.5,y:8,z:5},this.legend.dimensions=t.hasOwnProperty("dimensions")?t.dimensions:{width:.5,height:3},this.legend.canvas=document.createElement("canvas"),this.legend.canvas.setAttribute("id","legend"),this.legend.canvas.setAttribute("hidden",!0),document.body.appendChild(this.legend.canvas),this.legend.ctx=this.legend.canvas.getContext("2d"),this.legend.canvas.setAttribute("width",1),this.legend.canvas.setAttribute("height",this.n),this.legend.texture=new THREE.Texture(this.legend.canvas),imageData=this.legend.ctx.getImageData(0,0,1,this.n),data=imageData.data,len=data.length,this.map=THREE.ColorMapKeywords[this.mapname];for(var e=0,i=1/this.n,n=1;n>=0;n-=i)for(var o=this.map.length-1;o>=0;o--)if(n<this.map[o][0]&&n>=this.map[o-1][0]){var s=this.map[o-1][0],r=this.map[o][0],a=new THREE.Color(16777215),h=new THREE.Color(16777215).setHex(this.map[o-1][1]),c=new THREE.Color(16777215).setHex(this.map[o][1]);a=h.lerp(c,(n-s)/(r-s)),data[4*e]=Math.round(255*a.r),data[4*e+1]=Math.round(255*a.g),data[4*e+2]=Math.round(255*a.b),data[4*e+3]=255,e+=1}return this.legend.ctx.putImageData(imageData,0,0),this.legend.texture.needsUpdate=!0,this.legend.legendGeometry=new THREE.PlaneBufferGeometry(this.legend.dimensions.width,this.legend.dimensions.height),this.legend.legendMaterial=new THREE.MeshBasicMaterial({map:this.legend.texture,side:THREE.DoubleSide}),this.legend.mesh=new THREE.Mesh(this.legend.legendGeometry,this.legend.legendMaterial),"horizontal"==this.legend.layout&&(this.legend.mesh.rotation.z=-90*(Math.PI/180)),this.legend.mesh.position.copy(this.legend.position),this.legend.mesh},setLegendOff:function(){return this.legend=null,this.legend},setLegendLayout:function(t){return!!this.legend&&(this.legend.layout!=t&&(("horizontal"==t||"vertical"==t)&&(this.layout=t,"horizontal"==t&&(this.legend.mesh.rotation.z=90*(Math.PI/180)),"vertical"==t&&(this.legend.mesh.rotation.z=-90*(Math.PI/180)),this.legend.mesh)))},setLegendPosition:function(t){return this.legend.position=new THREE.Vector3(t.x,t.y,t.z),this.legend},setLegendLabels:function(t,e){if(!this.legend)return!1;"function"==typeof t&&(e=t),void 0===t&&(t={}),this.legend.labels={},this.legend.labels.fontsize=t.hasOwnProperty("fontsize")?t.fontsize:24,this.legend.labels.fontface=t.hasOwnProperty("fontface")?t.fontface:"Arial",this.legend.labels.title=t.hasOwnProperty("title")?t.title:"",this.legend.labels.um=t.hasOwnProperty("um")?" [ "+t.um+" ]":"",this.legend.labels.ticks=t.hasOwnProperty("ticks")?t.ticks:0,this.legend.labels.decimal=t.hasOwnProperty("decimal")?t.decimal:2,this.legend.labels.notation=t.hasOwnProperty("notation")?t.notation:"standard";var i={r:255,g:100,b:100,a:.8},n={r:255,g:0,b:0,a:1},o=4,s=document.createElement("canvas"),r=s.getContext("2d");r.font="Normal "+1.2*this.legend.labels.fontsize+"px "+this.legend.labels.fontface;var a=r.measureText(this.legend.labels.title.toString()+this.legend.labels.um.toString());a.width;r.fillStyle="rgba("+i.r+","+i.g+","+i.b+","+i.a+")",r.strokeStyle="rgba("+n.r+","+n.g+","+n.b+","+n.a+")",r.lineWidth=o,r.fillStyle="rgba( 0, 0, 0, 1.0 )",r.fillText(this.legend.labels.title.toString()+this.legend.labels.um.toString(),o,this.legend.labels.fontsize+o);var h=new THREE.CanvasTexture(s);h.minFilter=THREE.LinearFilter;var c=new THREE.SpriteMaterial({map:h}),l=new THREE.Sprite(c);if(l.scale.set(2,1,1),"vertical"==this.legend.layout&&l.position.set(this.legend.position.x+this.legend.dimensions.width,this.legend.position.y+.45*this.legend.dimensions.height,this.legend.position.z),"horizontal"==this.legend.layout&&l.position.set(1.015*this.legend.position.x,this.legend.position.y+.03*this.legend.dimensions.height,this.legend.position.z),this.legend.labels.ticks>0){var u={},p={};if("vertical"==this.legend.layout)var d=this.legend.position.y+.36*this.legend.dimensions.height,f=this.legend.position.y-.61*this.legend.dimensions.height;if("horizontal"==this.legend.layout)var m=this.legend.position.x+.75*this.legend.dimensions.height,v=this.legend.position.x-1.2*this.legend.dimensions.width;for(var y=0;y<this.legend.labels.ticks;y++){var g=(this.maxV-this.minV)/(this.legend.labels.ticks-1)*y+this.minV;g=e?e(g):"scientific"==this.legend.labels.notation?g.toExponential(this.legend.labels.decimal):g.toFixed(this.legend.labels.decimal);var E=document.createElement("canvas"),b=E.getContext("2d");b.font="Normal "+this.legend.labels.fontsize+"px "+this.legend.labels.fontface;var a=b.measureText(g.toString());a.width;b.fillStyle="rgba("+i.r+","+i.g+","+i.b+","+i.a+")",b.strokeStyle="rgba("+n.r+","+n.g+","+n.b+","+n.a+")",b.lineWidth=o,b.fillStyle="rgba( 0, 0, 0, 1.0 )",b.fillText(g.toString(),o,this.legend.labels.fontsize+o);var w=new THREE.CanvasTexture(E);w.minFilter=THREE.LinearFilter;var x=new THREE.SpriteMaterial({map:w}),T=new THREE.Sprite(x);if(T.scale.set(2,1,1),"vertical"==this.legend.layout){var H=f+(d-f)*((g-this.minV)/(this.maxV-this.minV));T.position.set(this.legend.position.x+2.7*this.legend.dimensions.width,H,this.legend.position.z)}if("horizontal"==this.legend.layout){var H=v+(m-v)*((g-this.minV)/(this.maxV-this.minV));if(this.legend.labels.ticks>5)if(y%2===0)var R=1.7;else var R=2.1;else var R=1.7;T.position.set(H,this.legend.position.y-this.legend.dimensions.width*R,this.legend.position.z)}var S=new THREE.LineBasicMaterial({color:0,linewidth:2}),z=new THREE.Geometry;if("vertical"==this.legend.layout){var k=this.legend.position.y-.5*this.legend.dimensions.height+.01+this.legend.dimensions.height*((g-this.minV)/(this.maxV-this.minV)*.99);z.vertices.push(new THREE.Vector3(this.legend.position.x+.55*this.legend.dimensions.width,k,this.legend.position.z)),z.vertices.push(new THREE.Vector3(this.legend.position.x+.7*this.legend.dimensions.width,k,this.legend.position.z))}if("horizontal"==this.legend.layout){var k=this.legend.position.x-.5*this.legend.dimensions.height+.01+this.legend.dimensions.height*((g-this.minV)/(this.maxV-this.minV)*.99);z.vertices.push(new THREE.Vector3(k,this.legend.position.y-.55*this.legend.dimensions.width,this.legend.position.z)),z.vertices.push(new THREE.Vector3(k,this.legend.position.y-.7*this.legend.dimensions.width,this.legend.position.z))}var O=new THREE.Line(z,S);p[y]=O,u[y]=T}}return{title:l,ticks:u,lines:p}}},THREE.ColorMapKeywords={rainbow:[[0,"0x0000FF"],[.2,"0x00FFFF"],[.5,"0x00FF00"],[.8,"0xFFFF00"],[1,"0xFF0000"]],cooltowarm:[[0,"0x3C4EC2"],[.2,"0x9BBCFF"],[.5,"0xDCDCDC"],[.8,"0xF6A385"],[1,"0xB40426"]],blackbody:[[0,"0x000000"],[.2,"0x780000"],[.5,"0xE63200"],[.8,"0xFFFF00"],[1,"0xFFFFFF"]],grayscale:[[0,"0x000000"],[.2,"0x404040"],[.5,"0x7F7F80"],[.8,"0xBFBFBF"],[1,"0xFFFFFF"]],water:[[0,"0x0000aa"],[.2,"0x2020bb"],[.5,"0x5050cc"],[.8,"0x8080dd"],[1,"0xa0a0ff"]],land:[[0,"0x128A47"],[.2,"0xd9E775"],[.4,"0xDAEF7A"],[.7,"0xEDF97D"],[1,"0xffffff"]]},THREE.OrbitControls=function(t,e){function i(){return 2*Math.PI/60/60*l.autoRotateSpeed}function n(){return Math.pow(.95,l.userZoomSpeed)}function o(t){l.enabled!==!1&&l.userRotate!==!1&&(t.preventDefault(),H===T.NONE&&(0===t.button&&(H=T.ROTATE),1===t.button&&(H=T.ZOOM),2===t.button&&(H=T.PAN)),H===T.ROTATE?d.set(t.clientX,t.clientY):H===T.ZOOM?v.set(t.clientX,t.clientY):H===T.PAN,document.addEventListener("mousemove",s,!1),document.addEventListener("mouseup",r,!1))}function s(t){if(l.enabled!==!1)if(t.preventDefault(),H===T.ROTATE)f.set(t.clientX,t.clientY),m.subVectors(f,d),l.rotateLeft(2*Math.PI*m.x/p*l.userRotateSpeed),l.rotateUp(2*Math.PI*m.y/p*l.userRotateSpeed),d.copy(f);else if(H===T.ZOOM)y.set(t.clientX,t.clientY),g.subVectors(y,v),g.y>0?l.zoomIn():l.zoomOut(),v.copy(y);else if(H===T.PAN){var e=t.movementX||t.mozMovementX||t.webkitMovementX||0,i=t.movementY||t.mozMovementY||t.webkitMovementY||0;l.pan(new THREE.Vector3((-e),i,0))}}function r(t){l.enabled!==!1&&l.userRotate!==!1&&(document.removeEventListener("mousemove",s,!1),document.removeEventListener("mouseup",r,!1),H=T.NONE)}function a(t){if(l.enabled!==!1&&l.userZoom!==!1){var e=0;t.wheelDelta?e=t.wheelDelta:t.detail&&(e=-t.detail),e>0?l.zoomOut():l.zoomIn()}}function h(t){if(t.preventDefault(),l.enabled!==!1&&l.userPan!==!1)switch(t.keyCode){case l.keys.UP:l.pan(new THREE.Vector3(0,1,0));break;case l.keys.BOTTOM:l.pan(new THREE.Vector3(0,(-1),0));break;case l.keys.LEFT:l.pan(new THREE.Vector3((-1),0,0));break;case l.keys.RIGHT:l.pan(new THREE.Vector3(1,0,0));break;case l.keys.ROTATE:H=T.ROTATE;break;case l.keys.ZOOM:H=T.ZOOM;break;case l.keys.PAN:H=T.PAN}}function c(t){switch(t.preventDefault(),t.keyCode){case l.keys.ROTATE:case l.keys.ZOOM:case l.keys.PAN:H=T.NONE}}this.object=t,this.domElement=void 0!==e?e:document,this.enabled=!0,this.center=new THREE.Vector3,this.userZoom=!0,this.userZoomSpeed=1,this.userRotate=!0,this.userRotateSpeed=1,this.userPan=!0,this.userPanSpeed=2,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minDistance=0,this.maxDistance=1/0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40,ROTATE:65,ZOOM:83,PAN:68};var l=this,u=1e-6,p=1800,d=new THREE.Vector2,f=new THREE.Vector2,m=new THREE.Vector2,v=new THREE.Vector2,y=new THREE.Vector2,g=new THREE.Vector2,E=0,b=0,w=1,x=new THREE.Vector3,T={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},H=T.NONE,R={type:"change"};this.rotateLeft=function(t){void 0===t&&(t=i()),b-=t},this.rotateRight=function(t){void 0===t&&(t=i()),b+=t},this.rotateUp=function(t){void 0===t&&(t=i()),E-=t},this.rotateDown=function(t){void 0===t&&(t=i()),E+=t},this.zoomIn=function(t){void 0===t&&(t=n()),w/=t},this.zoomOut=function(t){void 0===t&&(t=n()),w*=t},this.pan=function(t){t.transformDirection(this.object.matrix),t.multiplyScalar(l.userPanSpeed),this.object.position.add(t),this.center.add(t)},this.update=function(){var t=this.object.position,e=t.clone().sub(this.center),n=Math.atan2(e.x,e.z),o=Math.atan2(Math.sqrt(e.x*e.x+e.z*e.z),e.y);this.autoRotate&&this.rotateLeft(i()),n+=b,o+=E,o=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,o)),o=Math.max(u,Math.min(Math.PI-u,o));var s=e.length()*w;s=Math.max(this.minDistance,Math.min(this.maxDistance,s)),e.x=s*Math.sin(o)*Math.sin(n),e.y=s*Math.cos(o),e.z=s*Math.sin(o)*Math.cos(n),t.copy(this.center).add(e),this.object.lookAt(this.center),b=0,E=0,w=1,x.distanceTo(this.object.position)>0&&(this.dispatchEvent(R),x.copy(this.object.position))},this.domElement.addEventListener("contextmenu",function(t){t.preventDefault()},!1),this.domElement.addEventListener("mousedown",o,!1),this.domElement.addEventListener("mousewheel",a,!1),this.domElement.addEventListener("DOMMouseScroll",a,!1),window.addEventListener("keydown",h,!1),window.addEventListener("keyup",c,!1)},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),"function"!=typeof Object.assign&&(Object.assign=function(t,e){"use strict";if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(t),n=1;n<arguments.length;n++){var o=arguments[n];if(null!=o)for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&(i[s]=o[s])}return i});var __generator=this&&this.__generator||function(t,e){function i(t){return function(e){return n([t,e])}}function n(i){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,s&&(r=s[2&i[0]?"return":i[0]?"throw":"next"])&&!(r=r.call(s,i[1])).done)return r;switch(s=0,r&&(i=[0,r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,s=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(r=a.trys,!(r=r.length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],s=0}finally{o=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var o,s,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return{next:i(0),throw:i(1),return:i(2)}},Promise=this&&this.Promise||this.ES6Promise;String.prototype.startsWith||(String.prototype.startsWith=function(t,e){return e=e||0,this.substr(e,t.length)===t}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Explorer3d=t.Explorer3d||{})}(this,function(t){"use strict";function e(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function i(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{h(n.next(t))}catch(t){s(t)}}function a(t){try{h(n.throw(t))}catch(t){s(t)}}function h(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}h((n=n.apply(t,e)).next())})}function n(t){var e=t.split(/\s+/g),i=(e.length,{get xyz(){return[this.x,this.y,this.z]}});return e.forEach(function(t,e){switch(e){case 0:break;case 1:i.index=parseInt(t)-1;break;case 2:i.vertexId=parseFloat(t)-1;break;case 3:i.properties=[];default:i.properties.push(t)}}),i}function o(t){var e=t.split(/\s+/g);return{id:+e[1]-1,vertices:[+e[2]-1,+e[3]-1]}}function s(t){var e=t.split(/\s+/g);return parseInt(e[1])-1}function r(t){var e=t.split(/\s+/g),i=e.length,n={get abc(){return[this.a,this.b,this.c]}};return 4===i&&(n.a=parseInt(e[1])-1,n.b=parseFloat(e[2])-1,n.c=parseFloat(e[3])-1),n}function a(t,e,i){var n=t.split(/\s+/g),o=(n.length,i?i:1),s=[],r={get xyz(){return[this.x,this.y,this.z]},get all(){var t=[this.x,this.y,this.z];return this.properties&&this.properties.forEach(function(e){t.push(e)}),t}};return n.forEach(function(t,e){switch(e){case 0:break;case 1:r.index=+t-1;break;case 2:s[0]=+t;break;case 3:s[1]=+t;break;case 4:r.z=+t*o;break;case 5:r.properties=[];default:r.properties.push(t)}}),e&&(s=e(s)),r.x=s[0],r.y=s[1],r}function h(t){return t.split(/\s+/g).map(function(t){return t.replace(/\"/g,"")})}function c(t){return t=t.trim(),l(t)&&0!==t.indexOf("#")}function l(t){return 0!==t.trim().length}function u(t){return t}function p(t){return"true"===t}function d(t){if(t){var e=t.trim().split(/\s+/g);return 1===e.length&&0===e[0].indexOf("#")?parseInt("0x"+e[0].substring(1)):255*parseFloat(e[0])*256*256+255*parseFloat(e[1])*256+255*parseFloat(e[2])}return null}function f(t){var e=t.split(/\s+/g);return[parseInt(e[1])-1,parseInt(e[2])-1]}function m(t){var e=t.split(/\s+/g);return[parseInt(e[1]),parseInt(e[2]),parseInt(e[3]),parseInt(e[4])]}function v(t){return t}function y(t){var e=new THREE.Geometry;return t.borders.forEach(function(i){var n=t.vertices[i[0]];e.vertices.push(new THREE.Vector3(n[0],n[1],n[2])),n=t.vertices[i[1]],e.vertices.push(new THREE.Vector3(n[0],n[1],n[2]))}),e.vertices.length?(e.computeBoundingBox(),new THREE.LineSegments(e,new THREE.LineBasicMaterial({linewidth:10,color:16711935}))):null}function g(t){var e=new THREE.Geometry;if(t.bstones.forEach(function(i){var n=t.vertices[i];if(n){var o=new THREE.Vector3(n[0],n[1],n[2]);e.vertices.push(o)}}),e.vertices.length){e.computeBoundingBox();var i=new THREE.PointsMaterial({size:16384});return new THREE.Points(e,i)}return null}function E(t,e){var i=Array.isArray(e),n=i&&[]||{};if(i){var o=n;t=t||[],o=o.concat(t),e.forEach(function(e,i){"undefined"==typeof o[i]?o[i]=e:"object"==typeof e?o[i]=E(t[i],e):t.indexOf(e)===-1&&o.push(e)})}else t&&"object"==typeof t&&Object.keys(t).forEach(function(e){n[e]=t[e]}),Object.keys(e).forEach(function(i){"object"==typeof e[i]&&e[i]&&t[i]?n[i]=E(t[i],e[i]):n[i]=e[i]});return n}function b(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function w(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}var x=function(){function t(){}return t.prototype.addEventListener=function(t,e){void 0===this.listeners&&(this.listeners={});var i=this.listeners;void 0===i[t]&&(i[t]=[]),i[t].indexOf(e)===-1&&i[t].push(e)},t.prototype.hasEventListener=function(t,e){if(void 0===this.listeners)return!1;var i=this.listeners;return void 0!==i[t]&&i[t].indexOf(e)!==-1},t.prototype.removeEventListener=function(t,e){if(void 0!==this.listeners){var i=this.listeners[t];void 0!==i&&(this.listeners[t]=i.filter(function(t){return e!==t}))}},t.prototype.dispatchEvent=function(t){var e=this,i=this.listeners;if(void 0!==i){var n=i[t.type];void 0!==n&&(t.target=this,n.forEach(function(i){return i.call(e,t)}))}},t.prototype.removeAllListeners=function(){this.listeners=void 0},t}(),T=function(t){function i(){var e=t.call(this)||this;return e.complete=!1,e}return e(i,t),i}(x),H=function(){function t(){}return t}();H.names=["bstones","borders","complete","header","vertices","faces","lines","properties"];var R=function(){function t(t,e,i){this.type=t,this.data=e,this.target=i}return t}(),S=function(){function t(t,e){this.min=t,this.max=e}return t}(),z=function(){function t(t,e,i){this.x=t,this.y=e,this.z=i}return t}(),k=function(){function t(){}return t.fromVertices=function(e){void 0===e&&(e=[]);var i;return e.forEach(function(e){i=t.expand(i,e)}),i},t.expand=function(t,e){return void 0===t&&(t=new S(new z(1/0,1/0,1/0),new z((-(1/0)),(-(1/0)),(-(1/0))))),t.min.x=Math.min(t.min.x,e[0]),t.min.y=Math.min(t.min.y,e[1]),t.min.z=Math.min(t.min.z,e[2]),t.max.x=Math.max(t.max.x,e[0]),t.max.y=Math.max(t.max.y,e[1]),t.max.z=Math.max(t.max.z,e[2]),t},t.toThreeBox3=function(t){return new THREE.Box3(new THREE.Vector3(t.min.x,t.min.y,t.min.z),new THREE.Vector3(t.max.x,t.max.y,t.max.z))},t}(),O=function(){function t(){}return t.subVectors=function(t,e){return new z(t[0]-e[0],t[1]-e[1],t[2]-e[2])},t.cross=function(t,e){var i=t.x,n=t.y,o=t.z,s=e.x,r=e.y,a=e.z,h=n*a-o*r,c=o*s-i*a,l=i*r-n*s;return new z(h,c,l)},t.normalize=function(e){return t.divideScalar(e,t.calcLength(e))},t.calcLength=function(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)},t.divideScalar=function(e,i){return t.multiplyScalar(e,1/i)},t.multiplyScalar=function(t,e){return isFinite(e)?(t.x*=e,t.y*=e,t.z*=e):(t.x=0,t.y=0,t.z=0),t},t}(),L=function(){function t(){}return t.computeNormal=function(t,e){var i=e[t[0]],n=e[t[1]],o=e[t[2]],s=O.subVectors(o,n),r=O.subVectors(i,n);s=O.cross(s,r),O.normalize(s),t[3]=s},t}(),P=function(){function t(){this.type="Type",this.isValid=!1}return t}(),C=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="TSurf",e.vertices=[],e.faces=[],e.bstones=[],e.borders=[],e}return e(i,t),i}(P),M=function(){function t(){this.isValid=!0,this.typeMap={AXIS_NAME:h,AXIS_UNIT:h}}return t}(),V=function(t){function i(){var e=t.call(this)||this;return e.state=0,e}return e(i,t),i}(T),j=function(t){function i(){var e=t.call(this)||this;return e.coordinateSystem=new M,e.validHeader=!1,e}return e(i,t),Object.defineProperty(i.prototype,"obj",{get:function(){return this.coordinateSystem},enumerable:!0,configurable:!0}),i.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsurf pusher");switch(this.state){case 0:return this.hasBlock(t);case 1:return this.pushData(t)}},i.prototype.hasBlock=function(t){if(t=t.trim(),t.length){if("GOCAD_ORIGINAL_COORDINATE_SYSTEM"!==t)return this.complete=!0,this.coordinateSystem.isValid=!1,!1;this.state++}return!0},i.prototype.pushData=function(t){if(c(t))if("END_ORIGINAL_COORDINATE_SYSTEM"!==t){var e=t.indexOf(" ");if(e>0){var i=t.substring(0,e),n=t.substring(e).trim(),o=this.coordinateSystem.typeMap[i]?this.coordinateSystem.typeMap[i]:function(t){return t};this.coordinateSystem[i]=o(n)}}else this.coordinateSystem.typeMap=null,this.complete=!0;return!0},i}(V),F=function(){function t(){}return t.noop=function(){},Object.defineProperty(t,"level",{set:function(e){var i=parseInt(e);if(i=NaN===i?0:i,!t._broken){t.log=console.log;try{t.log("Setting log level")}catch(e){t._broken=!0}}t._broken?(t.log=i>=64?function(t){console.log(t)}:t.noop,t.info=i>=32?function(t){console.info(t)}:t.noop,t.warn=i>=16?function(t){console.warn(t)}:t.noop,t.log=i>=8?function(t){console.log(t)}:t.noop):(t.log=i>=64?console.log:t.noop,t.info=i>=32?console.info:t.noop,t.warn=i>=16?console.warn:t.noop,t.error=i>=8?console.error:t.noop)},enumerable:!0,configurable:!0}),t}();F.LOG_ALL=64,F.LOG_INFO=32,F.LOG_WARN=16,F.LOG_ERROR=8,F.LOG_NOTHING=0,F._broken=!1,F.log=F.noop,F.error=F.noop,F.info=F.noop,F.warn=F.noop;var A=function(){function t(){this.values={},this.typeMap={ivolmap:p,imap:p,parts:p,mesh:p,cn:p,border:p,"*solid*color":d}}return t}(),B=function(t){function i(){var e=t.call(this)||this;return e.header=new A,e}return e(i,t),Object.defineProperty(i.prototype,"obj",{get:function(){return this.header},enumerable:!0,configurable:!0}),i.prototype.push=function(t){if(!c(t))return!0;if(t=t.trim(),0===t.indexOf("}"))this.postLoad();else{var e=t.split(":");if(2===e.length){var i=this.header.typeMap[e[0]];i=i?i:u,this.header.values[e[0]]=i(e[1])}else F.warn("That doesn't look like a pair: "+t)}return!0},i.prototype.postLoad=function(){this.complete=!0;var t=this.header;t.name=t.values.name,t.solidColor=t.values["*solid*color"],t.solidColor=t.solidColor?t.solidColor:15658734,t.typeMap=null},i}(T),D=function(t){function i(e){var i=t.call(this)||this;return i.projectionFn=e,i.tsurf=new C,i.zSign=1,i.readTface=!1,i.verticesBuffer=[],i.facesBuffer=[],i.bordersBuffer=[],i.bstonesBuffer=[],i}return e(i,t),Object.defineProperty(i.prototype,"obj",{get:function(){return this.tsurf},enumerable:!0,configurable:!0}),i.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsurf pusher");switch(this.state){case 0:return this.waitForHead(t);case 1:return this.loadHeader(t);case 2:return this.loadCs(t);case 3:return this.waitForTface(t);case 4:return this.processToEnd(t)}},i.prototype.waitForHead=function(t){return t.startsWith("HEADER")&&(t.indexOf("{")===-1?this.complete=!0:this.headerPusher=new B,this.state++),!0},i.prototype.loadHeader=function(t){return this.headerPusher.push(t),this.headerPusher.complete&&(this.tsurf.header=this.headerPusher.obj,this.csPusher=new j,this.state++),!0},i.prototype.loadCs=function(t){return this.csPusher.push(t),this.csPusher.complete&&(this.csPusher.obj.isValid&&(this.tsurf.coordinateSystem=this.csPusher.obj,this.zSign="Depth"===this.tsurf.coordinateSystem.ZPOSITIVE?-1:1),this.state++,this.dispatchEvent(new R("header",this.tsurf))),!0},i.prototype.waitForTface=function(t){return t.indexOf("TFACE")||this.state++,!0},i.prototype.processToEnd=function(t){if(t=t.trim(),"END"===t)this.complete=!0,this.state=99,this.flushVertices(),this.flushFaces(),this.flushBstones(),this.flushBorders(),this.tsurf.vertices=[],this.dispatchEvent(new R("complete",{header:this.tsurf.header,coordinateSystem:this.tsurf.coordinateSystem,bbox:this.tsurf.bbox}));else{var e=this.tsurf,i=t.indexOf("VRTX");if(0===i||1===i){var h=a(t,this.projectionFn,this.zSign);e.vertices[h.index]=h.all,this.tsurf.bbox=k.expand(this.tsurf.bbox,h.all),this.checkVertices(h.all)}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var c=n(t);this.checkVertices(e.vertices[c.index]=e.vertices[c.vertexId])}else if(0===t.indexOf("TRGL")){var l=r(t).abc;L.computeNormal(l,this.tsurf.vertices),this.checkFaces(l)}else if(0===t.indexOf("BSTONE")){var u=s(t);this.checkBstones(u)}else if(0===t.indexOf("BORDER")){var p=o(t);this.checkBorders([p.vertices[0],p.vertices[1]])}}return!0},i.prototype.checkVertices=function(t){this.verticesBuffer.push(t),this.verticesBuffer.length>=i.PAGE_SIZE&&this.flushVertices()},i.prototype.flushVertices=function(){this.verticesBuffer=this.flush("vertices",this.verticesBuffer)},i.prototype.checkFaces=function(t){this.facesBuffer.push(t),this.facesBuffer.length>=i.PAGE_SIZE&&this.flushFaces()},i.prototype.flushFaces=function(){this.facesBuffer=this.flush("faces",this.facesBuffer)},i.prototype.checkBorders=function(t){this.bordersBuffer.push(t),this.bordersBuffer.length>=i.PAGE_SIZE&&this.flushBorders()},i.prototype.flushBorders=function(){this.bordersBuffer=this.flush("borders",this.bordersBuffer)},i.prototype.checkBstones=function(t){this.bstonesBuffer.push(t),this.bstonesBuffer.length>=i.PAGE_SIZE&&this.flushBstones()},i.prototype.flushBstones=function(){this.bstonesBuffer=this.flush("bstones",this.bstonesBuffer)},i.prototype.flush=function(t,e){return e.length&&this.dispatchEvent(new R(t,e)),[]},i}(V);D.PAGE_SIZE=65536;var N=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e(i,t),i}(A),I=function(t){function i(){return t.call(this)||this}return e(i,t),Object.defineProperty(i.prototype,"obj",{get:function(){return this.plineHeader},enumerable:!0,configurable:!0}),i.prototype.push=function(e){var i=t.prototype.push.call(this,e);if(this.complete){this.complete=!0,this.plineHeader=Object.assign(new N,this.header),this.plineHeader.typeMap=null,this.plineHeader.paintedVariable=this.plineHeader.values["*painted*variable"];var n=this.plineHeader.values["*line*color"];this.plineHeader.color=n?d(n):255}return i},i}(B),_=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="PLine",e.vertices=[],e.lines=[],e}return e(i,t),i}(P),W=function(t){function i(e){var i=t.call(this)||this;return i.projectionFn=e,i.pline=new _,i.verticesBuffer=[],i.segmentsBuffer=[],i}return e(i,t),Object.defineProperty(i.prototype,"obj",{get:function(){return this.pline},enumerable:!0,configurable:!0}),i.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsolid pusher");switch(this.state){case 0:return this.expectHeader(t);case 1:return this.pushHeader(t);case 2:return this.pushCs(t);case 3:return this.expectIline(t);case 4:return this.pushData(t)}return!0},i.prototype.expectHeader=function(t){return t=t.trim(),!t.startsWith("HEADER")||(t&&t.indexOf("{")!==-1?(this.child=new I,this.state++,!0):(this.complete=!0,
!0))},i.prototype.pushHeader=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.pline.header=this.child.obj,this.child=new j),e},i.prototype.pushCs=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.child.isValid&&(this.pline.coordinateSystem=this.child.obj,this.zSign="Depth"===this.pline.coordinateSystem.ZPOSITIVE?-1:1),this.dispatchEvent(new R("header",this.pline))),e},i.prototype.expectIline=function(t){return t.startsWith("ILINE")&&this.state++,!0},i.prototype.pushData=function(t){if(void 0===t&&(t=""),t=t.trim(),!t)return!0;var e=this.pline;if(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")){var i=a(t,this.projectionFn,this.zSign);this.verticesBuffer[i.index]=i.all,e.bbox=k.expand(e.bbox,i.all)}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var o=n(t),i=this.verticesBuffer[o.vertexId];this.verticesBuffer[o.index]=i}else if(0===t.indexOf("SEG")){var s=f(t);this.segmentsBuffer.push(this.verticesBuffer[s[0]]),this.segmentsBuffer.push(this.verticesBuffer[s[1]]),this.checkSegments()}else 0!==t.indexOf("ILINE")&&0!==t.indexOf("END")||(this.complete=0===t.indexOf("END"),this.verticesBuffer=[],this.complete&&(this.flushSegments(),this.dispatchEvent(new R("complete",{header:e.header,coordinateSystem:e.coordinateSystem,bbox:e.bbox}))));return!0},i.prototype.checkSegments=function(){this.segmentsBuffer.length>=i.PAGE_SIZE&&this.flushSegments()},i.prototype.flushSegments=function(){this.segmentsBuffer=this.flush("vertices",this.segmentsBuffer)},i.prototype.flush=function(t,e){return e.length&&this.dispatchEvent(new R(t,e)),[]},i}(V);W.PAGE_SIZE=32768;var G=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="TSolid",e.vertices=[],e.tetras=[],e}return e(i,t),i}(P),X=function(t){function i(e){var i=t.call(this)||this;return i.projectionFn=e,i.tsolid=new G,i}return e(i,t),Object.defineProperty(i.prototype,"obj",{get:function(){return this.tsolid},enumerable:!0,configurable:!0}),i.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsolid pusher");switch(this.state){case 0:return this.expectHeader(t);case 1:return this.pushHeader(t);case 2:return this.pushCs(t);case 3:return this.expectTvolume(t);case 4:return this.pushData(t)}return!0},i.prototype.expectHeader=function(t){return t.startsWith("HEADER")&&(this.child=new B,this.state++),!0},i.prototype.pushHeader=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.tsolid.header=this.child.obj,this.child=new j),e},i.prototype.pushCs=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.tsolid.coordinateSystem=this.child.obj,this.zSign="Depth"===this.tsolid.coordinateSystem.ZPOSITIVE?-1:1),e},i.prototype.expectTvolume=function(t){return t.startsWith("TVOLUME")&&this.state++,!0},i.prototype.pushData=function(t){if(t=t.trim(),"END"===t)if(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")){var e=a(t,this.projectionFn,this.zSign);this.tsolid.vertices[e.index]=e.all}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var i=n(t);this.tsolid.vertices[i.index]=this.tsolid.vertices[i.vertexId]}else 0===t.indexOf("TETRA")&&this.tsolid.tetras.push(m(t));else this.complete=!0;return!0},i}(V),Z=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="VSet",e.vertices=[],e}return e(i,t),i}(P),U=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e(i,t),i}(A),Y=function(t){function i(){return t.call(this)||this}return e(i,t),Object.defineProperty(i.prototype,"obj",{get:function(){return this.vsetHeader},enumerable:!0,configurable:!0}),i.prototype.push=function(e){var i=t.prototype.push.call(this,e);return this.complete&&(this.complete=!0,this.vsetHeader=Object.assign(new U,this.header),this.vsetHeader.color=d(this.vsetHeader.values["*atoms*color"])),i},i}(B),q=function(t){function i(e){var i=t.call(this)||this;return i.projectionFn=e,i.verticesBuffer=[],i.vset=new Z,i}return e(i,t),Object.defineProperty(i.prototype,"obj",{get:function(){return this.vset},enumerable:!0,configurable:!0}),i.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsolid pusher");switch(this.state){case 0:return this.expectHeader(t);case 1:return this.pushHeader(t);case 2:return this.pushCs(t);case 3:return this.pushData(t)}return!0},i.prototype.expectHeader=function(t){return void 0===t&&(t=""),t=t.trim(),!t.startsWith("HEADER")||(t.indexOf("{")===-1&&(this.complete=!0),this.child=new Y,this.state++,!0)},i.prototype.pushHeader=function(t){void 0===t&&(t="");var e=this.child.push(t);return this.child.complete&&(this.state++,this.vset.header=this.child.obj,this.child=new j,this.zSign=1,this.dispatchEvent(new R("header",this.vset))),e},i.prototype.pushCs=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.vset.coordinateSystem=this.child.obj,this.zSign="Depth"===this.vset.coordinateSystem.ZPOSITIVE?-1:1),e},i.prototype.pushData=function(t){if(void 0===t&&(t=""),t=t.trim())if(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")){var e=a(t,this.projectionFn,this.zSign);this.vset.bbox=k.expand(this.vset.bbox,e.all),this.checkVertices(e.all)}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var i=n(t);this.checkVertices(this.vset.vertices[i.vertexId])}else t.startsWith("END")&&!t.startsWith("END_")&&(this.complete=!0,this.flushVertices(),this.dispatchEvent(new R("complete",{header:this.vset.header,coordinateSystem:this.vset.coordinateSystem,bbox:this.vset.bbox})));return!0},i.prototype.checkVertices=function(t){this.verticesBuffer.push(t),this.verticesBuffer.length>=i.PAGE_SIZE&&this.flushVertices()},i.prototype.flushVertices=function(){this.verticesBuffer=this.flush("vertices",this.verticesBuffer)},i.prototype.flush=function(t,e){return e.length&&this.dispatchEvent(new R(t,e)),[]},i}(V);q.PAGE_SIZE=65536;var $=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="Unknown",e}return e(i,t),i}(P),K=function(t){function i(e){var i=t.call(this)||this;return i.projectionFn=e,i.unknown=new $,i}return e(i,t),Object.defineProperty(i.prototype,"obj",{get:function(){return this.unknown},enumerable:!0,configurable:!0}),i.prototype.push=function(t){return"END"===t.trim()&&(this.complete=!0),!0},i}(T),J=function(){function t(){this.isValid=!1}return t}(),Q=function(t){function i(e){var i=t.call(this)||this;return i.projectionFn=e,i.typeFactory=new J,i}return e(i,t),Object.defineProperty(i.prototype,"obj",{get:function(){return this.type.obj},enumerable:!0,configurable:!0}),i.prototype.push=function(t){var e=!0;return this.type?(e=this.type.push(t),this.complete=this.type.complete):e=this.create(t),e},i.prototype.create=function(t){function e(t){F.log("TFP: "+t.type),o.dispatchEvent(t)}var i=this;t=t.trim();var n=t.split(/\s+/g);this.typeFactory.isValid=3===n.length&&"GOCAD"===n[0]&&("1.0"===n[2]||"1"===n[2]),this.typeFactory.isValid&&(this.typeFactory.version=n[2],"TSurf"===n[1]?this.type=new D(this.projectionFn):"PLine"===n[1]?this.type=new W(this.projectionFn):"TSolid"===n[1]?this.type=new X(this.projectionFn):"VSet"===n[1]?this.type=new q(this.projectionFn):this.type=new K(this.projectionFn));var o=this;return H.names.forEach(function(t){return i.type.addEventListener(t,e)}),this.typeFactory.isValid},i}(T),tt=function(){function t(){this.types=[]}return t}(),et=function(t){function i(){var e=t.call(this)||this;return e.types=[],e}return e(i,t),i}(tt),it=function(t){function i(e,i){var n=t.call(this)||this;return n.proj4=i,n.eventHandler=function(t){F.log("DP: "+t.type),n.dispatchEvent(t)},e&&e.from&&e.to&&e.from!==e.to&&i?(i.defs("EPSG:3112","+proj=lcc +lat_1=-18 +lat_2=-36 +lat_0=0 +lon_0=134 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"),n.projectionFn=function(t,e){return function(n){return i(t,e,[n[0],n[1]])}}(e.from,e.to)):n.projectionFn=v,n.document=new et,n.typefactorypusher=n.createTypeFactoryPusher(n.projectionFn),n}return e(i,t),Object.defineProperty(i.prototype,"obj",{get:function(){return this.document},enumerable:!0,configurable:!0}),i.prototype.push=function(t){var e=this.typefactorypusher.push(t);return e?(this.typefactorypusher.complete&&(this.complete=!0,this.document.types.push(this.typefactorypusher.obj),this.destroyTypeFactoryPusher(this.typefactorypusher),this.typefactorypusher=this.createTypeFactoryPusher(this.projectionFn)),!0):(F.log("NOT PUSHED: "+t),this.push(t),!0)},i.prototype.createTypeFactoryPusher=function(t){var e=this,i=new Q(t);return H.names.forEach(function(t){i.addEventListener(t,e.eventHandler)}),i},i.prototype.destroyTypeFactoryPusher=function(t){var e=this;H.names.forEach(function(i){t.removeEventListener(i,e.eventHandler)})},i}(T),nt=function(){function t(t){this.callback=t}return t.prototype.receiver=function(t){var e=this;t.forEach(function(t){e.callback(t)})},t}(),ot=function(){function t(t,e){this.url=t,this.callback=e}return t.prototype.start=function(){var t=this;return new Promise(function(e,i){var n=t,o=new XMLHttpRequest,s=0,r=[],a=function(){if(null===o.readyState||!(o.readyState<3||200!==o.status)){for(var t=o.responseText,i=t.length,a=s;a<i;a++){var h=t[a];if("\r"!==h)if("\n"!==h)r.push(h);else{var c=r.join("");r=[],n.callback(c)}}s=i,4===o.readyState&&e(null)}};o.onreadystatechange=a,o.open("get",t.url),o.send()})},t}(),st=function(){function t(t,e,i){this.file=t,this.callback=i,this.blockSize=16384,this.file=t,this.length=t.size,this.pageNo=-1,this.index=0,this.blockSize=e.blockSize?e.blockSize:this.blockSize,this.reader,this.lineBuffer=[],this.reader=new FileReader}return t.prototype.start=function(){return i(this,void 0,void 0,function(){var t,e,i,n,o;return __generator(this,function(s){switch(s.label){case 0:return[4,this.read()];case 1:t=s.sent(),e=[],s.label=2;case 2:if(!t)return[3,8];switch(i=this.next(),n=i.state){case"more":return[3,3];case"line":return[3,5];case"complete":return[3,6]}return[3,7];case 3:o=e,e=[];try{this.callback(o)}catch(t){F.error(t),F.error("Someone died. Continue on.\n\n"+o.join("\n").substr(0,2e3))}return[4,this.read()];case 4:return t=s.sent(),[3,7];case 5:return e.push(i.line),[3,7];case 6:if(e.push(i.line),e.length)try{this.callback(e)}catch(t){F.error(t),F.error("Someone died. Continue on.\n\n"+e.join("\n").substr(0,2e3))}return t=!1,[3,7];case 7:return[3,2];case 8:return[2]}})})},t.prototype.read=function(){return i(this,void 0,void 0,function(){var t,e,i=this;return __generator(this,function(n){return this.pageNo++,this.index=0,t=this,e=this.pageNo*this.blockSize,F.log("Block size: "+this.blockSize+", file size: "+this.length),[2,new Promise(function(n){if(e>=i.length)return void n(!1);try{t.reader.onloadend=function(e){F.log("We have loaded with ready state = "+e.target.readyState),e.target.readyState===FileReader.prototype.DONE&&(F.log("Reading page "+t.pageNo),t.buffer=e.target.result,n(i.hasMore()))},t.reader.onerror=function(t){F.log("What do you mean, error")};var o=t.file.slice(e,e+t.blockSize);t.reader.readAsText(o)}catch(t){F.log(t)}})]})})},t.prototype.hasMore=function(){return this.index+this.blockSize*this.pageNo<this.length-1},t.prototype.next=function(){for(;this.hasMore();){if(!this.buffer||this.index>=this.blockSize)return{state:"more"};var t=this.buffer[this.index++];if("\r"!==t){if("\n"===t)break;this.lineBuffer.push(t)}}var e=this.lineBuffer.join("");return this.lineBuffer=[],{state:this.hasMore()?"line":"complete",line:e}},t}(),rt=function(){function t(t,e,i){void 0===i&&(i=window);var n=this;this.renderer=t,this.camera=e,this.container=i,this.update=function(){var t=n.container.getBoundingClientRect();n.renderer.setSize(t.width,t.height),n.camera.aspect=t.width/t.height,n.camera.updateProjectionMatrix()},window.addEventListener("resize",this.update,!1)}return t.prototype.resize=function(){this.update()},t.prototype.destroy=function(){window.removeEventListener("resize",this.update)},t}(),at=function(){function t(t,e){function i(){a.continueAnimation&&(window.requestAnimationFrame(i),a.camera.lookAt(a.lookAt),a.renderer.render(a.scene,a.camera),a.controls.update(.02))}void 0===e&&(e={}),this.options={camera:{fov:45,near:.1,far:5e5,position:{x:-30,y:40,z:30},up:{x:0,y:1,z:0}},lights:{ambient:{color:13421772},directional:{color:8947848,center:{x:0,y:0,z:0},position:{dx:500,dy:100,dz:-300}}},axisHelper:{on:!0,size:20}},this.lights=[],this.options=E(this.options,e);var n=document.body.getBoundingClientRect();"string"==typeof t?this.container=document.getElementById(""+t):this.container=t,this.scene=new THREE.Scene,this.renderer=new THREE.WebGLRenderer({clearColor:16711680}),this.renderer.setSize(n.width,n.height);var o=this.options.camera;this.camera=new THREE.PerspectiveCamera(o.fov,n.width/n.height,o.near,o.far),this.camera.up.set(o.up.x,o.up.y,o.up.z);var s=o.position;if(this.camera.position.x=s.x,this.camera.position.y=s.y,this.camera.position.z=s.z,e.camera.lookAt){var r=e.camera.lookAt;this.lookAt=new THREE.Vector3(r.x,r.y,r.z)}else this.lookAt=this.scene.position;this.camera.lookAt(this.lookAt),this.container.appendChild(this.renderer.domElement),this.renderer.render(this.scene,this.camera),this.axisHelper(this.options.axisHelper.on),this.addLights(),this.addFlyControls(),this.resizer=new rt(this.renderer,this.camera,this.container);var a=this;this.continueAnimation=!0,this.resizer.resize(),i()}return t.prototype.destroy=function(){for(this.lights=[],this.axis=null,this.renderer.dispose(),this.renderer=null,this.dataContainer.children.forEach(function(t){t.geometry.dispose(),t.material.dispose()}),this.scene.remove(this.dataContainer),this.scene=null,this.camera=null,this.controls.dispose&&this.controls.dispose(),this.controls=null,this.resizer.destroy(),this.resizer=null;this.container.lastChild;)this.container.removeChild(this.container.lastChild);this.continueAnimation=!1},t.prototype.resize=function(t){this.options=E(this.options,t?t:{});var e=this.options.axisHelper.on;this.axisHelper(!1),this.axisHelper(e),this.updateLights();var i=t.camera.lookAt;this.lookAt=new THREE.Vector3(i.x,i.y,i.z),this.camera.far=t.camera.far,this.camera.near=t.camera.near,this.camera.lookAt(this.lookAt)},t.prototype.update=function(t){this.options=E(this.options,t?t:{});var e=this.options.camera;this.camera.up.set(e.up.x,e.up.y,e.up.z);var i=e.position;if(this.camera.position.x=i.x,this.camera.position.y=i.y,this.camera.position.z=i.z,t.camera.lookAt){var n=t.camera.lookAt;this.lookAt=new THREE.Vector3(n.x,n.y,n.z)}else this.lookAt=this.scene.position;this.camera.lookAt(this.lookAt),this.controls.movementSpeed=this.options.radius;var o=this.options.axisHelper.on;this.axisHelper(!1),this.axisHelper(o),this.updateLights()},t.prototype.addLabels=function(t){function e(e,n){if(e){var o=E({fontface:"Arial",fontsize:14,borderThickness:4,borderColor:{r:0,g:0,b:0,a:1},backgroundColor:{r:255,g:255,b:255,a:1}},n?n:{}),s=document.createElement("canvas");s.width=256,s.height=128;var r=s.getContext("2d");r.font=o.fontsize+"px "+o.fontface;var a=r.measureText(e),h=a.width;F.log(h),r.fillStyle="rgba("+o.backgroundColor.r+","+o.backgroundColor.g+","+o.backgroundColor.b+","+o.backgroundColor.a+")",r.strokeStyle="rgba("+o.borderColor.r+","+o.borderColor.g+","+o.borderColor.b+","+o.borderColor.a+")",r.lineWidth=o.borderThickness,i(r,o.borderThickness/2,o.borderThickness/2,h+o.borderThickness,1.4*o.fontsize+o.borderThickness,6),r.fillStyle="rgba(0, 0, 0, 1.0)",r.fillText(e,o.borderThickness,o.fontsize+o.borderThickness);var c=new THREE.Texture(s);c.needsUpdate=!0;var l=new THREE.SpriteMaterial({map:c}),u=new THREE.Sprite(l);return u.scale.set(35*t,15*t,1),u}}function i(t,e,i,n,o,s){t.beginPath(),t.moveTo(e+s,i),t.lineTo(e+n-s,i),t.quadraticCurveTo(e+n,i,e+n,i+s),t.lineTo(e+n,i+o-s),t.quadraticCurveTo(e+n,i+o,e+n-s,i+o),t.lineTo(e+s,i+o),t.quadraticCurveTo(e,i+o,e,i+o-s),t.lineTo(e,i+s),t.quadraticCurveTo(e,i,e+s,i),t.closePath(),t.fill(),t.stroke()}var n=!0;this.labels&&(n=this.labels.visible,this.scene.remove(this.labels));var o=this.labels=new THREE.Object3D,s=this.options.axisHelper.position,r=this.options.axisHelper.size,a=this.options.axisHelper.labels,h={fontsize:54,backgroundColor:{r:255,g:200,b:200,a:.7}},c=e(a.x,h);return c&&(c.position.set(s.x+r,s.y,s.z),o.add(c)),h.backgroundColor={r:200,g:255,b:200,a:.7},c=e(a.y,h),c&&(c.position.set(s.x,s.y+r,s.z),o.add(c)),h.backgroundColor={r:200,g:200,b:255,a:.7},c=e(a.z,h),c&&(c.position.set(s.x,s.y,s.z+r),o.add(c)),this.scene.add(o),o.visible=n,o},t.prototype.axisHelper=function(t){if(this.axis)t||(this.scene.remove(this.axis),this.axis=null);else if(t){var e=this.options.axisHelper;if(this.axis=new THREE.AxisHelper(e.size),e.position&&(this.axis.position.set(e.position.x,e.position.y,e.position.z),e.labels)){var i=e.size/100;this.addLabels(i)}this.scene.add(this.axis)}this.options.axisHelper.on=t},t.prototype.addControls=function(){this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.25,this.controls.enableZoom=!0,this.controls.userPanSpeed=2e4},t.prototype.addFirstPersonControls=function(){this.controls=new THREE.FirstPersonControls(this.camera,this.renderer.domElement)},t.prototype.addFlyControls=function(){this.controls=new THREE.FlyControls(this.camera,this.renderer.domElement),this.controls.movementSpeed=this.options.radius,this.controls.domElement=this.container,this.controls.rollSpeed=24*Math.PI,this.controls.autoForward=!1,this.controls.dragToLook=!1},t.prototype.addLights=function(){var t=this.options.lights;this.lights[0]=new THREE.AmbientLight(t.ambient.color),this.scene.add(this.lights[0]);var e=t.directional;this.lights[1]=new THREE.DirectionalLight(e.color),this.lights[1].position.set(e.center.x+e.position.dx,e.center.y+e.position.dy,e.center.z+e.position.dz),this.scene.add(this.lights[1]),this.lights[2]=new THREE.DirectionalLight(e.color),this.lights[2].position.set(e.center.x+e.position.dx,e.center.y+e.position.dy,e.center.z-e.position.dz),this.scene.add(this.lights[2])},t.prototype.updateLights=function(){this.scene.remove(this.lights[0]),this.scene.remove(this.lights[1]),this.scene.remove(this.lights[2]),this.addLights()},t}(),ht=function(t){function i(e){var i=t.call(this)||this;return i.element=e,i.state={world:null,dataContainer:null,get isAllVisible(){if(this.state.world&&this.state.world.scene)return!this.state.dataContainer.children.some(function(t){return!t.visible})}},i}return e(i,t),i.prototype.destroy=function(){this.state.world&&(this.state.world.destroy(),this.state.world=null,this.state.dataContainer=null,this.dispatchEvent({type:"objects.changed",objects:[]}))},i.prototype.remove=function(t){var e=!1;return this.state.dataContainer&&(this.state.dataContainer.remove(t),e=this.state.dataContainer.children.length>0,e?(this.resize(),this.dispatchEvent({type:"objects.changed",objects:this.state.dataContainer.children})):this.destroy()),e},i.prototype.resize=function(){var t=(new THREE.Box3).setFromObject(this.state.dataContainer),e=t.getCenter(),i=t.getBoundingSphere().radius,n=2.5*i,o={radius:i,axisHelper:{on:!0,size:i,position:{x:e.x,y:e.y,z:e.z},labels:{x:" East ",y:" North ",z:" Elevation "}},camera:{far:250*n,near:.01*i,lookAt:{x:e.x,y:e.y,z:e.z}},lights:{directional:{center:{x:e.x,y:e.y,z:e.z},position:{dx:i,dy:-i,dz:n}}}};this.state.world.resize(o)},i.prototype.show=function(t){this.state.dataContainer?this.extend(t):this.create(t),this.dispatchEvent({type:"objects.changed",objects:this.state.dataContainer.children})},i.prototype.create=function(t){this.state.dataContainer=new THREE.Object3D,this.state.dataContainer.add(t);var e=(new THREE.Box3).setFromObject(t),i=e.getCenter();t.userData.center=i;var n=e.getBoundingSphere().radius,o=4*n,s={radius:n,axisHelper:{on:!0,size:n,position:{x:i.x,y:i.y,z:i.z},labels:{x:" East ",y:" North ",z:" Elevation "}},camera:{far:250*o,near:.01*n,up:{x:0,y:0,z:1},position:{x:i.x,y:i.y-3*n,z:i.z+n},lookAt:{x:i.x,y:i.y,z:i.z}},lights:{directional:{center:{x:i.x,y:i.y,z:i.z},position:{dx:n,dy:n,dz:o}}}};this.state.world&&this.state.world.destroy(),this.state.world=new at(this.element,s),this.add(this.state.dataContainer),this.dispatchEvent({type:"world.created",factory:this})},i.prototype.getWorld=function(){return this.state.world},i.prototype.add=function(t){this.state.world.scene.add(t),this.state.world.dataContainer=t},i.prototype.extend=function(t){var e=(new THREE.Box3).setFromObject(t).getCenter();t.userData.center=e,this.state.dataContainer.add(t);var i=(new THREE.Box3).setFromObject(this.state.dataContainer);e=i.getCenter();var n=i.getBoundingSphere().radius,o=4*n,s={radius:n,axisHelper:{on:!0,size:n,position:{x:e.x,y:e.y,z:e.z},labels:{x:" East ",y:" North ",z:" Elevation "}},camera:{far:250*o,near:.01*n,up:{x:0,y:0,z:1},position:{x:e.x,y:e.y-3*n,z:e.z+n},lookAt:{x:e.x,y:e.y,z:e.z}},lights:{directional:{center:{x:e.x,y:e.y,z:e.z},position:{dx:n,dy:-n,dz:o}}}};this.state.world.update(s)},i}(THREE.EventDispatcher),ct=function(t){function i(e,i){void 0===i&&(i={});var n=t.call(this)||this;return n.element=e,n.state={world:null,dataContainer:null,get isAllVisible(){if(this.state.world&&this.state.world.scene)return!this.state.dataContainer.children.some(function(t){return!t.visible})}},n.options={axisHelper:{on:!0,labels:{x:" East ",y:" North ",z:" Elevation "}}},n.options=E(n.options,i),n}return e(i,t),i.prototype.destroy=function(){this.state.world&&(this.state.world.destroy(),this.state.world=null,this.state.dataContainer=null,this.dispatchEvent({type:"objects.changed",objects:[]}))},i.prototype.remove=function(t){var e=!1;return this.state.dataContainer&&(this.state.dataContainer.remove(t),e=this.state.dataContainer.children.length>0,e?(this.resize(),this.dispatchEvent({type:"objects.changed",objects:this.state.dataContainer.children})):this.destroy()),e},i.prototype.resize=function(){var t=(new THREE.Box3).setFromObject(this.state.dataContainer),e=t.getCenter(),i=t.getBoundingSphere().radius,n=2.5*i,o=E({radius:i,axisHelper:{on:!0,size:i,position:{x:e.x,y:e.y,z:e.z}},camera:{far:250*n,near:.01*i,lookAt:{x:e.x,y:e.y,z:e.z}},lights:{directional:{center:{x:e.x,y:e.y,z:e.z},position:{dx:i,dy:-i,dz:n}}}},this.options);this.state.world.resize(o)},i.prototype.show=function(t){this.state.dataContainer?this.extend(t):this.create(t),this.dispatchEvent({type:"objects.changed",objects:this.state.dataContainer.children})},i.prototype.create=function(t){this.state.dataContainer=new THREE.Object3D,this.state.dataContainer.add(t);var e=(new THREE.Box3).setFromObject(t),i=e.getCenter();t.userData.center=i;var n=e.getBoundingSphere().radius,o=4*n,s=E({radius:n,axisHelper:{on:!0,size:n,position:{x:i.x,y:i.y,z:i.z}},camera:{far:250*o,near:.01*n,up:{x:0,y:0,z:1},position:{x:i.x,y:i.y-3*n,z:i.z+n},lookAt:{x:i.x,y:i.y,z:i.z}},lights:{directional:{center:{x:i.x,y:i.y,z:i.z},position:{dx:n,dy:n,dz:o}}}},this.options);this.state.world&&this.state.world.destroy(),this.state.world=new at(this.element,s),this.add(this.state.dataContainer),this.dispatchEvent({type:"world.created",factory:this})},i.prototype.getWorld=function(){return this.state.world},i.prototype.add=function(t){this.state.world.scene.add(t),this.state.world.dataContainer=t},i.prototype.extend=function(t,e){void 0===e&&(e=!0);var i=(new THREE.Box3).setFromObject(t).getCenter();if(t.userData.center=i,this.state.dataContainer.add(t),e){var n=(new THREE.Box3).setFromObject(this.state.dataContainer);i=n.getCenter();var o=n.getBoundingSphere().radius,s=4*o,r=Object.assign({radius:o,axisHelper:{on:!0,size:o,position:{x:i.x,y:i.y,z:i.z}},camera:{far:250*s,near:.01*o,up:{x:0,y:0,z:1},position:{x:i.x,y:i.y-3*o,z:i.z+o},lookAt:{x:i.x,y:i.y,z:i.z}},lights:{directional:{center:{x:i.x,y:i.y,z:i.z},position:{dx:o,dy:-o,dz:s}}}},this.options);this.state.world.update(r)}},i}(THREE.EventDispatcher),lt=function(){function t(t){var e=this;this.eventdispatcher=t,this.callbacks=[],t.addEventListener("world.created",function(t){e.factory=t.factory,e.flushCallbacks(t.factory)}),t.addEventListener("world.destroyed",function(t){e.factory=null,e.flushCallbacks(null)})}return t.prototype.flushCallbacks=function(t){this.callbacks&&(this.callbacks.forEach(function(e){e(t)}),this.callbacks=[])},t.prototype.onChange=function(t){var e=this;return setTimeout(function(){return t(e.factory)}),this.callbacks.push(t),this},t}(),ut=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e(i,t),i.prototype.set=function(t){this.factory&&this.factory.getWorld()&&(this.factory.getWorld().labels.visible=t)},i}(lt),pt=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e(i,t),i.prototype.set=function(t){this.factory&&this.factory.getWorld()&&(this.factory.getWorld().dataContainer.scale.z=t)},i}(lt),dt=function(){function t(t,e){function i(t){t.stopPropagation(),t.preventDefault(),F.log("dragenter")}function n(t){t.stopPropagation(),t.preventDefault(),F.log("dragover")}function o(t){t.stopPropagation(),t.preventDefault();var e=t.dataTransfer,i=e.files;s(i)}function s(t){if(t)for(var i=0;i<t.length;i++)e(t.item(i))}if(!e||"function"!=typeof e)throw Error("No file handler provided");if(!t)throw Error("No element provided");t.addEventListener("dragenter",i,!1),t.addEventListener("dragover",n,!1),t.addEventListener("drop",o,!1)}return t}(),ft=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e(i,t),i.prototype.getWorkersBase=function(){return i.codeBase+"/workers/"},i}(x);ft.codeBase="";var mt=function(t){function i(e){void 0===e&&(e={});var i=t.call(this)||this;return i.options=e,i}return e(i,t),i.prototype.parse=function(){var t=this,e=new Elevation.WcsXyzLoader(this.options);return e.load().then(function(e){var i=new THREE.Geometry,n=b(t.options.color?t.options.color:"#bbbbff"),o=(new THREE.Color).setRGB(n.r/255,n.g/255,n.b/255),s=new THREE.Lut("land",2200);s.setMax(Math.floor(2200)),s.setMin(Math.floor(0)),e.forEach(function(t,e){var n=t.x,r=t.y,a=t.z,h=new THREE.Vector3(n,r,a);i.vertices.push(h),i.colors.push(a>0?s.getColor(a):o)}),e.length&&(i.computeBoundingSphere(),i.boundingSphere.radius<5&&(console.log("Overriding bounding sphere radius"+i.boundingSphere.radius),i.boundingSphere.radius=5));var r=new THREE.PointsMaterial({vertexColors:THREE.VertexColors,size:1}),a=new THREE.Points(i,r);return a.userData=t.options,a})},i}(ft),vt=function(t){function i(e){void 0===e&&(e={});var i=t.call(this)||this;return i.options=e,i}return e(i,t),i.prototype.parse=function(){var t=this,e=new Elevation.WcsXyzLoader(this.options);return e.load().then(function(e){var i=t.options.resolutionX,n=e.length/i,o=new THREE.PlaneGeometry(i,n,i-1,n-1);t.options.bbox;o.vertices.forEach(function(t,i){var n=e[i],o=e[i].z;t.z=o,t.x=n.x,t.y=n.y}),e.length&&(o.computeBoundingSphere(),o.computeFaceNormals(),o.computeVertexNormals());var s=t.options.opacity?t.options.opacity:1,r=new THREE.MeshPhongMaterial({color:13311,specular:5592405,shininess:30,opacity:s,transparent:!0}),a=new THREE.Mesh(o,r);return a.userData=t.options,a})},i}(ft),yt=function(t){function i(e){function n(t,e,i,n,o,s){l[0]=i,l[1]=n,l[2]=o,l[3]=s,h.putImageData(c,t,e)}var o=t.call(this,e)||this;o.options=e;var s=e.data,r=document.createElement("canvas"),a=r.width=e.resolutionX,h=(r.height=e.resolutionY,r.getContext("2d")),c=h.createImageData(1,1),l=c.data,u=e.maxDepth?e.maxDepth:i.DEFAULT_MAX_DEPTH,p=e.maxElevation?e.maxElevation:i.DEFAULT_MAX_ELEVATION,d=new THREE.Lut("water",u),f=new THREE.Lut("land",p);d.setMax(0),d.setMin(-u),f.setMax(Math.floor(p)),f.setMin(0),s.forEach(function(t,e){var i=t.z;if(i>0){var o=f.getColor(i);n(e%a,Math.floor(e/a),255*o.r,255*o.g,255*o.b,255)}else{var o=d.getColor(i);n(e%a,Math.floor(e/a),255*o.r,255*o.g,255*o.b,255)}});var m=new THREE.Texture(r);m.needsUpdate=!0;var v=e.opacity?e.opacity:1;return o.setValues({map:m,transparent:!0,opacity:v,side:THREE.DoubleSide}),o}return e(i,t),i}(THREE.MeshPhongMaterial);yt.DEFAULT_MAX_DEPTH=5e3,yt.DEFAULT_MAX_ELEVATION=2200;var gt=function(t){function i(e){void 0===e&&(e={});var i=t.call(this)||this;return i.options=e,i}return e(i,t),i.prototype.parse=function(){var t=this,e=new Elevation.WcsXyzLoader(this.options);return e.load().then(function(e){var i=t.options.resolutionX,n=e.length/i,o=new THREE.PlaneGeometry(i,n,i-1,n-1);t.options.bbox;o.vertices.forEach(function(t,i){var n=e[i],o=e[i].z;t.z=o,t.x=n.x,t.y=n.y}),e.length&&(o.computeBoundingSphere(),o.computeFaceNormals(),o.computeVertexNormals());var s=t.options.opacity?t.options.opacity:1,r=new yt({resolutionX:i,resolutionY:n,data:o.vertices,transparent:!0,opacity:s,side:THREE.DoubleSide}),a=new THREE.Mesh(o,r);return a.userData=t.options,a})},i}(ft),Et=function(t){function i(e){void 0===e&&(e={});var i=t.call(this)||this;return i.options=e,i}return e(i,t),i.prototype.parse=function(t){return this.options.surface?new vt(this.options).parse():this.options.wmsSurface?new gt(this.options).parse():new mt(this.options).parse()},i}(ft),bt=function(){function t(t){this.options=t}return t.prototype.load=function(){var t=this.options.esriTemplate.replace("${bbox}",this.options.bbox).replace("${format}","JSON").replace("${size}",this.options.resolutionX+","+this.options.resolutionY),e=new Elevation.HttpTextLoader(t,this.options);return e.load().then(function(t){return JSON.parse(t)})},t}(),wt=function(t){function i(e){void 0===e&&(e={});var i=t.call(this)||this;return i.options=e,i}return e(i,t),i.prototype.loadImage=function(t,e){var n=this,o=Object.assign({},this.options,{bbox:e}),s=new Elevation.WcsXyzLoader(o);return s.load().then(function(e){var o=n.options.resolutionX,s=e.length/o,r=new THREE.PlaneGeometry(o,s,o-1,s-1);n.options.bbox;r.vertices.forEach(function(t,i){var n=e[i];t.z=n.z,t.x=n.x,t.y=n.y}),e.length&&(r.computeBoundingSphere(),r.computeFaceNormals(),r.computeVertexNormals());var a=new THREE.TextureLoader;a.crossOrigin="";var h=n.options.opacity?n.options.opacity:1,c=new THREE.MeshPhongMaterial({map:a.load(t,function(t){n.dispatchEvent(new R(i.TEXTURE_LOADED_EVENT,l))}),transparent:!0,opacity:h,side:THREE.DoubleSide}),l=new THREE.Mesh(r,c);return l.userData=n.options,l})},i.prototype.parse=function(){var t=this,e=Object.assign({},this.options,{resolutionX:this.options.imageWidth,resolutionY:this.options.imageHeight});if(this.options.imageOnly){var n=this.options.esriTemplate.replace("${bbox}",this.options.bbox).replace("$format}","Image").replace("${size}",this.options.resolutionX+","+this.options.resolutionY);return this.loadImage(n,this.options.bbox)}return new bt(e).load().then(function(e){var n=e.extent,o=[n.xmin,n.ymin,n.xmax,n.ymax];return t.dispatchEvent(new R(i.BBOX_CHANGED_EVENT,Object.assign({bbox:o,aspectRatio:e.width/e.height},e))),t.loadImage(e.href,o)})},i}(ft);wt.BBOX_CHANGED_EVENT="bbox.change",wt.TEXTURE_LOADED_EVENT="texture.loaded";var xt,Tt=function(t){function i(e){function i(){var t=new THREE.TextureLoader;t.crossOrigin="";var i=e.template.replace("${width}",e.width?e.width:512).replace("${height}",e.height?e.height:512).replace("${bbox}",e.bbox.join(","));return t.load(i)}var n=t.call(this,{map:i(),transparent:!0,opacity:e.opacity?e.opacity:1,side:THREE.DoubleSide})||this;return n.options=e,n}return e(i,t),i}(THREE.MeshPhongMaterial),Ht=function(t){function i(e){void 0===e&&(e={});var i=t.call(this)||this;return i.options=e,i}return e(i,t),i.prototype.parse=function(){var t=this,e=new Elevation.WcsXyzLoader(this.options);return e.load().then(function(e){var i=t.options.resolutionX,n=e.length/i,o=new THREE.PlaneGeometry(i,n,i-1,n-1);t.options.bbox,w(t.options.color?t.options.color:"#bbbbff");o.vertices.forEach(function(t,i){var n=e[i],o=e[i].z;t.z=o,t.x=n.x,t.y=n.y}),e.length&&(o.computeBoundingSphere(),o.computeFaceNormals(),o.computeVertexNormals());var s=new Tt({width:t.options.imageWidth,height:t.options.imageHeight,opacity:t.options.opacity,template:t.options.imageryTemplate}),r=new THREE.Mesh(o,s);
return r.userData=t.options,r})},i}(ft),Rt=function(t){function i(){return t.call(this)||this}return e(i,t),i.prototype.destroy=function(){this.removeAllListeners()},i}(x),St=function(t){function i(){var e=t.call(this)||this;return e.hasColors=!1,e}return e(i,t),i.prototype.destroy=function(){this.geometry=this.pline=this.solidColorObj=this.material=null,t.prototype.destroy.call(this)},i.prototype.pipe=function(t){var e=t.data;switch(t.eventName){case"header":this.processHeader(e);break;case"vertices":this.processVertices(e);break;case"complete":this.complete(e)}},i.prototype.complete=function(t){if(!this.geometry)return this.dispatchEvent(new R("error","We have complete before we even started")),void this.destroy();var e=null,i=this.solidColorObj,n=this.geometry.colors;if(!this.geometry.colors.length&&this.geometry.vertices.length){var o=Math.floor(this.max-this.min);o?(e=new THREE.Lut("rainbow",Math.floor(this.max-this.min)),e.setMax(Math.floor(this.max)),e.setMin(Math.floor(this.min)),this.ws.forEach(function(t){var o=e.getColor(t);o=o?o:i,n.push(o)})):this.geometry.vertices.forEach(function(){n.push(i)})}this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere();var s=new THREE.LineSegments(this.geometry,this.material);s.userData={header:t.header,coordinateSystem:t.coordinateSystem},this.dispatchEvent(new R("complete",s)),this.destroy()},i.prototype.processVertices=function(t){var e=this;if(!this.geometry)return this.dispatchEvent(new R("error","We have vertices before we have the header")),void this.destroy();var i=this.geometry.vertices,n=this.geometry.colors,o=this.solidColorObj;t.forEach(function(t,s){if(i.push(new THREE.Vector3(t[0],t[1],t[2])),t.length<3)n.push(o);else{var r=+t[3];e.min=Math.min(e.min,r),e.max=Math.max(e.max,r),e.ws.push(r)}}),F.log("WE have "+i.length+" vertices now")},i.prototype.processHeader=function(t){if(this.geometry)return this.dispatchEvent(new R("error","We already have processed a header. How did this happen?")),void this.destroy();this.geometry=new THREE.Geometry,this.pline=t;var e=t.header.color?t.header.color:16777215;this.solidColorObj=new THREE.Color(e);var i=t.header.width?t.header.width:10;this.material=new THREE.LineBasicMaterial({linewidth:i,color:e,vertexColors:THREE.VertexColors}),this.min=1/0,this.max=-(1/0),this.ws=[]},i}(Rt),zt=function(t){function i(){return t.call(this)||this}return e(i,t),i.prototype.destroy=function(){this.geometry=null,t.prototype.destroy.call(this)},i.prototype.pipe=function(t){var e=t.data;switch(t.eventName){case"header":this.processHeader(e);break;case"vertices":this.processVertices(e);break;case"faces":this.processFaces(e);break;case"complete":this.complete(e)}},i.prototype.complete=function(t){if(!this.geometry)return this.dispatchEvent(new R("error","We have complete before we even started")),void this.destroy();this.geometry.boundingBox=k.toThreeBox3(t.bbox);var e=t.header.solidColor,i=new THREE.MeshLambertMaterial({color:e?e:16716049,side:THREE.DoubleSide}),n=new THREE.Mesh(this.geometry,i);n.userData={header:t.header,coordinateSystem:t.coordinateSystem},this.dispatchEvent(new R("complete",n)),this.destroy()},i.prototype.processFaces=function(t){if(!this.geometry)return this.dispatchEvent(new R("error","We have faces before we have the header")),void this.destroy();var e=this.geometry.faces;t.forEach(function(t){var i=new THREE.Face3(t[0],t[1],t[2]),n=t[3];i.normal=new THREE.Vector3(n.x,n.y,n.z),e.push(i)})},i.prototype.processVertices=function(t){if(!this.geometry)return this.dispatchEvent(new R("error","We have vertices before we have the header")),void this.destroy();var e=this.geometry.vertices;t.forEach(function(t){e.push(new THREE.Vector3(t[0],t[1],t[2]))})},i.prototype.processHeader=function(t){return this.geometry?(this.dispatchEvent(new R("error","We already have processed a header. How did this happen?")),void this.destroy()):void(this.geometry=new THREE.Geometry)},i}(Rt),kt=function(t){function i(){return t.call(this)||this}return e(i,t),i.prototype.destroy=function(){this.geometry=null,t.prototype.destroy.call(this)},i.prototype.pipe=function(t){var e=t.data;switch(t.eventName){case"header":this.processHeader(e);break;case"vertices":this.processVertices(e);break;case"complete":this.complete(e)}},i.prototype.complete=function(t){if(!this.geometry)return this.dispatchEvent(new R("error","We have complete before we even started")),void this.destroy();var e=new THREE.PointsMaterial({size:16,color:t.header.color});this.geometry.boundingBox=k.toThreeBox3(t.bbox);var i=new THREE.Points(this.geometry,e);this.geometry.computeBoundingSphere(),i.userData={header:t.header,coordinateSystem:t.coordinateSystem},this.dispatchEvent(new R("complete",i)),this.destroy()},i.prototype.processVertices=function(t){if(!this.geometry)return this.dispatchEvent(new R("error","We have vertices before we have the header")),void this.destroy();var e=this.geometry.vertices;t.forEach(function(t){e.push(new THREE.Vector3(t[0],t[1],t[2]))}),F.log("WE have "+e.length+" vertices now")},i.prototype.processHeader=function(t){return this.geometry?(this.dispatchEvent(new R("error","We already have processed a header. How did this happen?")),void this.destroy()):void(this.geometry=new THREE.Geometry)},i}(Rt),Ot=function(t){function i(){var e=t.call(this)||this;return F.warn("We don't understand this type but we'll soldier on."),e}return e(i,t),i.prototype.pipe=function(t){"complete"===t.eventName&&this.dispatchEvent(new R("complete",{}))},i}(Rt);!function(t){t[t.Empty=0]="Empty",t[t.Loading=1]="Loading"}(xt||(xt={}));var Lt=function(t){function i(){var e=t.call(this)||this;return e.onEvent=function(t){var i=t;"complete"===t.type&&(i=new R("complete",t.data)),e.dispatchEvent(i),e.destroy()},e.state=xt.Empty,e}return e(i,t),i.prototype.pipe=function(t){switch(this.state){case xt.Empty:this.pipeHeader(t);break;case xt.Loading:this.next.pipe(t)}},i.prototype.pipeHeader=function(t){switch(t.eventName){case"start":break;case"header":var e=t.data;switch(e.type){case"TSurf":this.next=new zt;break;case"PLine":this.next=new St;break;case"VSet":this.next=new kt;break;default:this.next=new Ot}this.next.addEventListener("complete",this.onEvent),this.next.addEventListener("error",this.onEvent),this.next.pipe(t),this.state=xt.Loading}},i.prototype.destroy=function(){this.state===xt.Loading&&(this.next.destroy(),this.state=xt.Empty,this.next=null,t.prototype.destroy.call(this))},i}(Rt),Pt=function(){function t(){}return t.noop=function(){},Object.defineProperty(t,"level",{set:function(e){var i=parseInt(e);if(i=NaN===i?0:i,!t._broken){t.log=console.log;try{t.log("Setting log level")}catch(e){t._broken=!0}}t._broken?(t.log=i>=64?function(t){console.log(t)}:t.noop,t.info=i>=32?function(t){console.info(t)}:t.noop,t.warn=i>=16?function(t){console.warn(t)}:t.noop,t.log=i>=8?function(t){console.log(t)}:t.noop):(t.log=i>=64?console.log:t.noop,t.info=i>=32?console.info:t.noop,t.warn=i>=16?console.warn:t.noop,t.error=i>=8?console.error:t.noop)},enumerable:!0,configurable:!0}),t}();Pt.LOG_ALL=64,Pt.LOG_INFO=32,Pt.LOG_WARN=16,Pt.LOG_ERROR=8,Pt.LOG_NOTHING=0,Pt._broken=!1,Pt.log=Pt.noop,Pt.error=Pt.noop,Pt.info=Pt.noop,Pt.warn=Pt.noop;var Ct=function(t){function i(e){void 0===e&&(e={});var i=t.call(this)||this;return i.options=e,i}return e(i,t),i.prototype.parse=function(t){var e=this;return new Promise(function(n,o){var s=new Worker(e.getWorkersBase()+i.WORKER_NAME),r=new Lt;r.addEventListener("complete",function(t){s.terminate(),n(t.data)}),r.addEventListener("error",function(t){s.terminate(),Pt.log("There is an error with your pipes!"),o(t.data)}),s.addEventListener("message",function(t){var e=JSON.parse(t.data);r.pipe(e),Pt.log("EVENT = "+e.eventName)}),s.addEventListener("error",function(t){Pt.log("There is an error with your worker!"),Pt.log(t)}),s.postMessage(t)})},i}(ft);Ct.WORKER_NAME="gocadpusher.js";var Mt=function(t){function i(e){void 0===e&&(e={});var i=t.call(this)||this;return i.options=e,i}return e(i,t),i.prototype.parse=function(t){var e=this;return new Promise(function(n,o){var s=new Worker(e.getWorkersBase()+i.WORKER_NAME),r=new Lt;r.addEventListener("complete",function(t){s.terminate(),n(t.data)}),r.addEventListener("error",function(t){s.terminate(),Pt.log("There is an error with your pipes!"),o(t.data)}),s.addEventListener("message",function(t){var e=JSON.parse(t.data);r.pipe(e),Pt.log("EVENT = "+e.eventName)}),s.addEventListener("error",function(t){Pt.log("There is an error with your worker!"),Pt.log(t)}),s.postMessage(t)})},i}(ft);Mt.WORKER_NAME="gocadhttppusher.js";var Vt=["start","complete","bstones","borders","header","vertices","faces","lines","properties"],jt=function(t){function i(e){void 0===e&&(e={});var i=t.call(this)||this;return i.options=e,i}return e(i,t),i.prototype.parse=function(t){var e=this,i=t.file,n=t.options;return new Promise(function(t,o){var s=new it(e.options,proj4),r=new nt(function(t){s.push(t)}),a=new Lt;a.addEventListener("complete",function(e){t(e.data)}),a.addEventListener("error",function(t){Pt.log("There is an error with your pipes!"),o(t.data)}),new st(i,n,function(t){r.receiver(t)}).start().then(function(){Pt.log("******************* Local Kaput ****************************")}),Vt.forEach(function(t){Pt.log("Adding listener: "+t),s.addEventListener(t,function(t){Pt.log("GPW: "+t.type),a.pipe({eventName:t.type,data:t.data})})})})},i}(ft),Ft=function(t){function i(e,i){void 0===i&&(i=7);var n=t.call(this)||this;return n.parser=e,n.max=i,n.stack=[],n.count=0,n}return e(i,t),i.prototype.parse=function(t,e){function i(){}function n(){Pt.log("We have "+r.count+" jobs queued"),r.count>r.max||r.count<1||o()}function o(){Pt.log("Jobs length = "+r.count);var t=r.stack.shift();t&&t.self.parser.parse(t.file,t.options).then(function(e){s(),o(),t.resolver(e)}).catch(function(t){Pt.log("Ooops!"),Pt.log(t),s()})}function s(){r.count>0&&r.count--}var r=this,a={timestamp:Date.now(),file:t,options:e,self:r},h=new Promise(function(t){a.resolver=t});return this.stack.push(a),this.count++,n(),i(),h},i}(ft);t.loadBorders=y,t.loadBstones=g,t.DefaultWorldFactory=ht,t.WorldFactory=ct,t.LabelSwitch=ut,t.VerticalExaggerate=pt,t.FileDrop=dt,t.Parser=ft,t.ElevationParser=Et,t.WcsEsriImageryParser=wt,t.WcsWmsSurfaceParser=Ht,t.GocadPusherParser=Ct,t.HttpGocadPusherParser=Mt,t.LocalGocadPusherParser=jt,t.ThrottleProxyParser=Ft,t.ElevationMaterial=yt,t.WmsMaterial=Tt,t.DocumentPusher=it,t.LinesToLinePusher=nt,t.HttpPusher=ot,t.LinesPagedPusher=st,t.Logger=F,Object.defineProperty(t,"__esModule",{value:!0})});