!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Explorer3d=t.Explorer3d||{})}(this,function(t){"use strict";function e(t,e){function r(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}function r(t,e,r,i){return new(r||(r=Promise))(function(n,s){function o(t){try{c(i.next(t))}catch(t){s(t)}}function h(t){try{c(i.throw(t))}catch(t){s(t)}}function c(t){t.done?n(t.value):new r(function(e){e(t.value)}).then(o,h)}c((i=i.apply(t,e)).next())})}function i(t){var e=t.split(/\s+/g),r=(e.length,{get xyz(){return[this.x,this.y,this.z]}});return e.forEach(function(t,e){switch(e){case 0:break;case 1:r.index=parseInt(t)-1;break;case 2:r.vertexId=parseFloat(t)-1;break;case 3:r.properties=[];default:r.properties.push(t)}}),r}function n(t){var e=t.split(/\s+/g);return{id:+e[1]-1,vertices:[+e[2]-1,+e[3]-1]}}function s(t){var e=t.split(/\s+/g);return parseInt(e[1])-1}function o(t){var e=t.split(/\s+/g),r=e.length,i={get abc(){return[this.a,this.b,this.c]}};return 4===r&&(i.a=parseInt(e[1])-1,i.b=parseFloat(e[2])-1,i.c=parseFloat(e[3])-1),i}function h(t,e,r){var i=t.split(/\s+/g),n=(i.length,r?r:1),s=[],o={get xyz(){return[this.x,this.y,this.z]},get all(){var t=[this.x,this.y,this.z];return this.properties&&this.properties.forEach(function(e){t.push(e)}),t}};return i.forEach(function(t,e){switch(e){case 0:break;case 1:o.index=+t-1;break;case 2:s[0]=+t;break;case 3:s[1]=+t;break;case 4:o.z=+t*n;break;case 5:o.properties=[];default:o.properties.push(t)}}),e&&(s=e(s)),o.x=s[0],o.y=s[1],o}function c(t){return t.split(/\s+/g).map(function(t){return t.replace(/\"/g,"")})}function u(t){return t=t.trim(),a(t)&&0!==t.indexOf("#")}function a(t){return 0!==t.trim().length}function p(t){return t}function f(t){return"true"===t}function l(t){if(t){var e=t.trim().split(/\s+/g);return 1===e.length&&0===e[0].indexOf("#")?parseInt("0x"+e[0].substring(1)):255*parseFloat(e[0])*256*256+255*parseFloat(e[1])*256+255*parseFloat(e[2])}return null}function d(t){var e=t.split(/\s+/g);return[parseInt(e[1])-1,parseInt(e[2])-1]}function y(t){var e=t.split(/\s+/g);return[parseInt(e[1]),parseInt(e[2]),parseInt(e[3]),parseInt(e[4])]}function v(t){return t}var m=function(){function t(){}return t.prototype.addEventListener=function(t,e){void 0===this.listeners&&(this.listeners={});var r=this.listeners;void 0===r[t]&&(r[t]=[]),r[t].indexOf(e)===-1&&r[t].push(e)},t.prototype.hasEventListener=function(t,e){if(void 0===this.listeners)return!1;var r=this.listeners;return void 0!==r[t]&&r[t].indexOf(e)!==-1},t.prototype.removeEventListener=function(t,e){if(void 0!==this.listeners){var r=this.listeners[t];void 0!==r&&(this.listeners[t]=r.filter(function(t){return e!==t}))}},t.prototype.dispatchEvent=function(t){var e=this,r=this.listeners;if(void 0!==r){var i=r[t.type];void 0!==i&&(t.target=this,i.forEach(function(r){return r.call(e,t)}))}},t.prototype.removeAllListeners=function(){this.listeners=void 0},t}(),b=function(t){function r(){var e=t.call(this)||this;return e.complete=!1,e}return e(r,t),r}(m),x=function(){function t(){}return t}();x.names=["bstones","borders","complete","header","vertices","faces","lines","properties"];var g=function(){function t(t,e,r){this.type=t,this.data=e,this.target=r}return t}(),E=function(){function t(t,e){this.min=t,this.max=e}return t}(),S=function(){function t(t,e,r){this.x=t,this.y=e,this.z=r}return t}(),w=function(){function t(){}return t.fromVertices=function(e){void 0===e&&(e=[]);var r;return e.forEach(function(e){r=t.expand(r,e)}),r},t.expand=function(t,e){return void 0===t&&(t=new E(new S(1/0,1/0,1/0),new S((-(1/0)),(-(1/0)),(-(1/0))))),t.min.x=Math.min(t.min.x,e[0]),t.min.y=Math.min(t.min.y,e[1]),t.min.z=Math.min(t.min.z,e[2]),t.max.x=Math.max(t.max.x,e[0]),t.max.y=Math.max(t.max.y,e[1]),t.max.z=Math.max(t.max.z,e[2]),t},t.toThreeBox3=function(t){return new THREE.Box3(new THREE.Vector3(t.min.x,t.min.y,t.min.z),new THREE.Vector3(t.max.x,t.max.y,t.max.z))},t}(),O=function(){function t(){}return t.subVectors=function(t,e){return new S(t[0]-e[0],t[1]-e[1],t[2]-e[2])},t.cross=function(t,e){var r=t.x,i=t.y,n=t.z,s=e.x,o=e.y,h=e.z,c=i*h-n*o,u=n*s-r*h,a=r*o-i*s;return new S(c,u,a)},t.normalize=function(e){return t.divideScalar(e,t.calcLength(e))},t.calcLength=function(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)},t.divideScalar=function(e,r){return t.multiplyScalar(e,1/r)},t.multiplyScalar=function(t,e){return isFinite(e)?(t.x*=e,t.y*=e,t.z*=e):(t.x=0,t.y=0,t.z=0),t},t}(),j=function(){function t(){}return t.computeNormal=function(t,e){var r=e[t[0]],i=e[t[1]],n=e[t[2]],s=O.subVectors(n,i),o=O.subVectors(r,i);s=O.cross(s,o),O.normalize(s),t[3]=s},t}(),P=function(){function t(){this.type="Type",this.isValid=!1}return t}(),B=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="TSurf",e.vertices=[],e.faces=[],e.bstones=[],e.borders=[],e}return e(r,t),r}(P),T=function(){function t(){this.isValid=!0,this.typeMap={AXIS_NAME:c,AXIS_UNIT:c}}return t}(),F=function(t){function r(){var e=t.call(this)||this;return e.state=0,e}return e(r,t),r}(b),I=function(t){function r(){var e=t.call(this)||this;return e.coordinateSystem=new T,e.validHeader=!1,e}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.coordinateSystem},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsurf pusher");switch(this.state){case 0:return this.hasBlock(t);case 1:return this.pushData(t)}},r.prototype.hasBlock=function(t){if(t=t.trim(),t.length){if("GOCAD_ORIGINAL_COORDINATE_SYSTEM"!==t)return this.complete=!0,this.coordinateSystem.isValid=!1,!1;this.state++}return!0},r.prototype.pushData=function(t){if(u(t))if("END_ORIGINAL_COORDINATE_SYSTEM"!==t){var e=t.indexOf(" ");if(e>0){var r=t.substring(0,e),i=t.substring(e).trim(),n=this.coordinateSystem.typeMap[r]?this.coordinateSystem.typeMap[r]:function(t){return t};this.coordinateSystem[r]=n(i)}}else this.coordinateSystem.typeMap=null,this.complete=!0;return!0},r}(F),k=function(){function t(){this.values={},this.typeMap={ivolmap:f,imap:f,parts:f,mesh:f,cn:f,border:f,"*solid*color":l}}return t}(),z=function(t){function r(){var e=t.call(this)||this;return e.header=new k,e}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.header},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(!u(t))return!0;if(t=t.trim(),0===t.indexOf("}"))this.postLoad();else{var e=t.split(":");if(2===e.length){var r=this.header.typeMap[e[0]];r=r?r:p,this.header.values[e[0]]=r(e[1])}else console.warn("That doesn't look like a pair: "+t)}return!0},r.prototype.postLoad=function(){this.complete=!0;var t=this.header;t.name=t.values.name,t.solidColor=t.values["*solid*color"],t.solidColor=t.solidColor?t.solidColor:15658734,t.typeMap=null},r}(b),V=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.tsurf=new B,r.zSign=1,r.readTface=!1,r.verticesBuffer=[],r.facesBuffer=[],r.bordersBuffer=[],r.bstonesBuffer=[],r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.tsurf},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsurf pusher");switch(this.state){case 0:return this.waitForHead(t);case 1:return this.loadHeader(t);case 2:return this.loadCs(t);case 3:return this.waitForTface(t);case 4:return this.processToEnd(t)}},r.prototype.waitForHead=function(t){return t.startsWith("HEADER")&&(t.indexOf("{")===-1?this.complete=!0:this.headerPusher=new z,this.state++),!0},r.prototype.loadHeader=function(t){return this.headerPusher.push(t),this.headerPusher.complete&&(this.tsurf.header=this.headerPusher.obj,this.csPusher=new I,this.state++),!0},r.prototype.loadCs=function(t){return this.csPusher.push(t),this.csPusher.complete&&(this.csPusher.obj.isValid&&(this.tsurf.coordinateSystem=this.csPusher.obj,this.zSign="Depth"===this.tsurf.coordinateSystem.ZPOSITIVE?-1:1),this.state++,this.dispatchEvent(new g("header",this.tsurf))),!0},r.prototype.waitForTface=function(t){return t.indexOf("TFACE")||this.state++,!0},r.prototype.processToEnd=function(t){if(t=t.trim(),"END"===t)this.complete=!0,this.state=99,this.flushVertices(),this.flushFaces(),this.flushBstones(),this.flushBorders(),this.tsurf.vertices=[],this.dispatchEvent(new g("complete",{header:this.tsurf.header,coordinateSystem:this.tsurf.coordinateSystem,bbox:this.tsurf.bbox}));else{var e=this.tsurf,r=t.indexOf("VRTX");if(0===r||1===r){var c=h(t,this.projectionFn,this.zSign);e.vertices[c.index]=c.all,this.tsurf.bbox=w.expand(this.tsurf.bbox,c.all),this.checkVertices(c.all)}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var u=i(t);this.checkVertices(e.vertices[u.index]=e.vertices[u.vertexId])}else if(0===t.indexOf("TRGL")){var a=o(t).abc;j.computeNormal(a,this.tsurf.vertices),this.checkFaces(a)}else if(0===t.indexOf("BSTONE")){var p=s(t);this.checkBstones(p)}else if(0===t.indexOf("BORDER")){var f=n(t);this.checkBorders([f.vertices[0],f.vertices[1]])}}return!0},r.prototype.checkVertices=function(t){this.verticesBuffer.push(t),this.verticesBuffer.length>=r.PAGE_SIZE&&this.flushVertices()},r.prototype.flushVertices=function(){this.verticesBuffer=this.flush("vertices",this.verticesBuffer)},r.prototype.checkFaces=function(t){this.facesBuffer.push(t),this.facesBuffer.length>=r.PAGE_SIZE&&this.flushFaces()},r.prototype.flushFaces=function(){this.facesBuffer=this.flush("faces",this.facesBuffer)},r.prototype.checkBorders=function(t){this.bordersBuffer.push(t),this.bordersBuffer.length>=r.PAGE_SIZE&&this.flushBorders()},r.prototype.flushBorders=function(){this.bordersBuffer=this.flush("borders",this.bordersBuffer)},r.prototype.checkBstones=function(t){this.bstonesBuffer.push(t),this.bstonesBuffer.length>=r.PAGE_SIZE&&this.flushBstones()},r.prototype.flushBstones=function(){this.bstonesBuffer=this.flush("bstones",this.bstonesBuffer)},r.prototype.flush=function(t,e){return e.length&&this.dispatchEvent(new g(t,e)),[]},r}(F);V.PAGE_SIZE=65536;var H=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r}(k),A=function(t){function r(){return t.call(this)||this}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.plineHeader},enumerable:!0,configurable:!0}),r.prototype.push=function(e){var r=t.prototype.push.call(this,e);if(this.complete){this.complete=!0,this.plineHeader=Object.assign(new H,this.header),this.plineHeader.typeMap=null,this.plineHeader.paintedVariable=this.plineHeader.values["*painted*variable"];var i=this.plineHeader.values["*line*color"];this.plineHeader.color=i?l(i):255}return r},r}(z),D=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="PLine",e.vertices=[],e.lines=[],e}return e(r,t),r}(P),M=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.pline=new D,r.verticesBuffer=[],r.segmentsBuffer=[],r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.pline},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsolid pusher");switch(this.state){case 0:return this.expectHeader(t);case 1:return this.pushHeader(t);case 2:return this.pushCs(t);case 3:return this.expectIline(t);case 4:return this.pushData(t)}return!0},r.prototype.expectHeader=function(t){return t=t.trim(),!t.startsWith("HEADER")||(t&&t.indexOf("{")!==-1?(this.child=new A,this.state++,!0):(this.complete=!0,!0))},r.prototype.pushHeader=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.pline.header=this.child.obj,this.child=new I),e},r.prototype.pushCs=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.child.isValid&&(this.pline.coordinateSystem=this.child.obj,this.zSign="Depth"===this.pline.coordinateSystem.ZPOSITIVE?-1:1),this.dispatchEvent(new g("header",this.pline))),e},r.prototype.expectIline=function(t){return t.startsWith("ILINE")&&this.state++,!0},r.prototype.pushData=function(t){if(void 0===t&&(t=""),t=t.trim(),!t)return!0;var e=this.pline;if(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")){var r=h(t,this.projectionFn,this.zSign);this.verticesBuffer[r.index]=r.all,e.bbox=w.expand(e.bbox,r.all)}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var n=i(t),r=this.verticesBuffer[n.vertexId];this.verticesBuffer[n.index]=r}else if(0===t.indexOf("SEG")){var s=d(t);this.segmentsBuffer.push(this.verticesBuffer[s[0]]),this.segmentsBuffer.push(this.verticesBuffer[s[1]]),this.checkSegments()}else 0!==t.indexOf("ILINE")&&0!==t.indexOf("END")||(this.complete=0===t.indexOf("END"),this.verticesBuffer=[],this.complete&&(this.flushSegments(),this.dispatchEvent(new g("complete",{header:e.header,coordinateSystem:e.coordinateSystem,bbox:e.bbox}))));return!0},r.prototype.checkSegments=function(){this.segmentsBuffer.length>=r.PAGE_SIZE&&this.flushSegments()},r.prototype.flushSegments=function(){this.segmentsBuffer=this.flush("vertices",this.segmentsBuffer)},r.prototype.flush=function(t,e){return e.length&&this.dispatchEvent(new g(t,e)),[]},r}(F);M.PAGE_SIZE=32768;var _=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="TSolid",e.vertices=[],e.tetras=[],e}return e(r,t),r}(P),N=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.tsolid=new _,r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.tsolid},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsolid pusher");switch(this.state){case 0:return this.expectHeader(t);case 1:return this.pushHeader(t);case 2:return this.pushCs(t);case 3:return this.expectTvolume(t);case 4:return this.pushData(t)}return!0},r.prototype.expectHeader=function(t){return t.startsWith("HEADER")&&(this.child=new z,this.state++),!0},r.prototype.pushHeader=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.tsolid.header=this.child.obj,this.child=new I),e},r.prototype.pushCs=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.tsolid.coordinateSystem=this.child.obj,this.zSign="Depth"===this.tsolid.coordinateSystem.ZPOSITIVE?-1:1),e},r.prototype.expectTvolume=function(t){return t.startsWith("TVOLUME")&&this.state++,!0},r.prototype.pushData=function(t){if(t=t.trim(),"END"===t)if(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")){var e=h(t,this.projectionFn,this.zSign);this.tsolid.vertices[e.index]=e.all}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var r=i(t);this.tsolid.vertices[r.index]=this.tsolid.vertices[r.vertexId]}else 0===t.indexOf("TETRA")&&this.tsolid.tetras.push(y(t));else this.complete=!0;return!0},r}(F),R=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="VSet",e.vertices=[],e}return e(r,t),r}(P),L=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r}(k),C=function(t){function r(){return t.call(this)||this}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.vsetHeader},enumerable:!0,configurable:!0}),r.prototype.push=function(e){var r=t.prototype.push.call(this,e);return this.complete&&(this.complete=!0,this.vsetHeader=Object.assign(new L,this.header),this.vsetHeader.color=l(this.vsetHeader.values["*atoms*color"])),r},r}(z),G=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.verticesBuffer=[],r.vset=new R,r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.vset},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsolid pusher");switch(this.state){case 0:return this.expectHeader(t);case 1:return this.pushHeader(t);case 2:return this.pushCs(t);case 3:return this.pushData(t)}return!0},r.prototype.expectHeader=function(t){return void 0===t&&(t=""),t=t.trim(),!t.startsWith("HEADER")||(t.indexOf("{")===-1&&(this.complete=!0),this.child=new C,this.state++,!0)},r.prototype.pushHeader=function(t){void 0===t&&(t="");var e=this.child.push(t);return this.child.complete&&(this.state++,this.vset.header=this.child.obj,this.child=new I,this.zSign=1,this.dispatchEvent(new g("header",this.vset))),e},r.prototype.pushCs=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.vset.coordinateSystem=this.child.obj,this.zSign="Depth"===this.vset.coordinateSystem.ZPOSITIVE?-1:1),e},r.prototype.pushData=function(t){if(void 0===t&&(t=""),t=t.trim())if(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")){var e=h(t,this.projectionFn,this.zSign);this.vset.bbox=w.expand(this.vset.bbox,e.all),this.checkVertices(e.all)}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var r=i(t);this.checkVertices(this.vset.vertices[r.vertexId])}else t.startsWith("END")&&!t.startsWith("END_")&&(this.complete=!0,this.flushVertices(),this.dispatchEvent(new g("complete",{header:this.vset.header,coordinateSystem:this.vset.coordinateSystem,bbox:this.vset.bbox})));return!0},r.prototype.checkVertices=function(t){this.verticesBuffer.push(t),this.verticesBuffer.length>=r.PAGE_SIZE&&this.flushVertices()},r.prototype.flushVertices=function(){this.verticesBuffer=this.flush("vertices",this.verticesBuffer)},r.prototype.flush=function(t,e){return e.length&&this.dispatchEvent(new g(t,e)),[]},r}(F);G.PAGE_SIZE=65536;var Z=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="Unknown",e}return e(r,t),r}(P),W=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.unknown=new Z,r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.unknown},enumerable:!0,configurable:!0}),r.prototype.push=function(t){return"END"===t.trim()&&(this.complete=!0),!0},r}(b),X=function(){function t(){this.isValid=!1}return t}(),U=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.typeFactory=new X,r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.type.obj},enumerable:!0,configurable:!0}),r.prototype.push=function(t){var e=!0;return this.type?(e=this.type.push(t),this.complete=this.type.complete):e=this.create(t),e},r.prototype.create=function(t){function e(t){n.dispatchEvent(t)}var r=this;t=t.trim();var i=t.split(/\s+/g);this.typeFactory.isValid=3===i.length&&"GOCAD"===i[0]&&("1.0"===i[2]||"1"===i[2]),this.typeFactory.isValid&&(this.typeFactory.version=i[2],"TSurf"===i[1]?this.type=new V(this.projectionFn):"PLine"===i[1]?this.type=new M(this.projectionFn):"TSolid"===i[1]?this.type=new N(this.projectionFn):"VSet"===i[1]?this.type=new G(this.projectionFn):this.type=new W(this.projectionFn));var n=this;return x.names.forEach(function(t){return r.type.addEventListener(t,e)}),this.typeFactory.isValid},r}(b),Y=function(){function t(){this.types=[]}return t}(),q=function(t){function r(){var e=t.call(this)||this;return e.types=[],e}return e(r,t),r}(Y),J=function(t){function r(e,r){var i=t.call(this)||this;return i.proj4=r,i.eventHandler=function(t){i.dispatchEvent(t)},i.proj4.defs("EPSG:3112","+proj=lcc +lat_1=-18 +lat_2=-36 +lat_0=0 +lon_0=134 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"),e&&e.from&&e.to&&e.from!==e.to?i.projectionFn=function(t,e){return function(i){return r(t,e,[i[0],i[1]])}}(e.from,e.to):i.projectionFn=v,i.document=new q,i.typefactorypusher=i.createTypeFactoryPusher(i.projectionFn),i}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.document},enumerable:!0,configurable:!0}),r.prototype.push=function(t){var e=this.typefactorypusher.push(t);return e?(this.typefactorypusher.complete&&(this.complete=!0,this.document.types.push(this.typefactorypusher.obj),this.destroyTypeFactoryPusher(this.typefactorypusher),this.typefactorypusher=this.createTypeFactoryPusher(this.projectionFn)),!0):(console.log("NOT PUSHED: "+t),this.push(t),!0)},r.prototype.createTypeFactoryPusher=function(t){var e=this,r=new U(t);return x.names.forEach(function(t){r.addEventListener(t,e.eventHandler)}),r},r.prototype.destroyTypeFactoryPusher=function(t){var e=this;x.names.forEach(function(r){t.removeEventListener(r,e.eventHandler)})},r}(b),K=function(){function t(t){this.callback=t}return t.prototype.receiver=function(t){var e=this;t.forEach(function(t){e.callback(t)})},t}(),Q=function(){function t(t,e,r){this.file=t,this.callback=r,this.blockSize=16384,this.file=t,this.length=t.size,this.pageNo=-1,this.index=0,this.blockSize=e.blockSize?e.blockSize:this.blockSize,this.reader,this.lineBuffer=[],this.reader=new FileReader}return t.prototype.start=function(){return r(this,void 0,void 0,function(){var t,e,r,i,n;return __generator(this,function(s){switch(s.label){case 0:return[4,this.read()];case 1:t=s.sent(),e=[],s.label=2;case 2:if(!t)return[3,8];switch(r=this.next(),i=r.state){case"more":return[3,3];case"line":return[3,5];case"complete":return[3,6]}return[3,7];case 3:n=e,e=[];try{this.callback(n)}catch(t){console.error(t),console.error("Someone died. Continue on.\n\n"+n.join("\n").substr(0,2e3))}return[4,this.read()];case 4:return t=s.sent(),[3,7];case 5:return e.push(r.line),[3,7];case 6:if(e.push(r.line),e.length)try{this.callback(e)}catch(t){console.error(t),console.error("Someone died. Continue on.\n\n"+e.join("\n").substr(0,2e3))}return t=!1,[3,7];case 7:return[3,2];case 8:return[2]}})})},t.prototype.read=function(){return r(this,void 0,void 0,function(){var t,e,r=this;return __generator(this,function(i){return this.pageNo++,this.index=0,t=this,e=this.pageNo*this.blockSize,console.log("Block size: "+this.blockSize+", file size: "+this.length),[2,new Promise(function(i){if(e>=r.length)return void i(!1);try{t.reader.onloadend=function(e){console.log("We have loaded with ready state = "+e.target.readyState),e.target.readyState===FileReader.prototype.DONE&&(console.log("Reading page "+t.pageNo),t.buffer=e.target.result,i(r.hasMore()))},t.reader.onerror=function(t){console.log("What do you mean, error")};var n=t.file.slice(e,e+t.blockSize);t.reader.readAsText(n)}catch(t){console.log(t)}})]})})},t.prototype.hasMore=function(){return this.index+this.blockSize*this.pageNo<this.length-1},t.prototype.next=function(){for(;this.hasMore();){if(!this.buffer||this.index>=this.blockSize)return{state:"more"};var t=this.buffer[this.index++];if("\r"!==t){if("\n"===t)break;this.lineBuffer.push(t)}}var e=this.lineBuffer.join("");return this.lineBuffer=[],{state:this.hasMore()?"line":"complete",line:e}},t}();t.DocumentPusher=J,t.LinesToLinePusher=K,t.LinesPagedPusher=Q,Object.defineProperty(t,"__esModule",{value:!0})});