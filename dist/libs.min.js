"function"!=typeof Object.assign&&(Object.assign=function(t,e){"use strict";if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var r=Object(t),n=1;n<arguments.length;n++){var i=arguments[n];if(null!=i)for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(r[s]=i[s])}return r});var __generator=this&&this.__generator||function(t,e){function r(t){return function(e){return n([t,e])}}function n(r){if(i)throw new TypeError("Generator is already executing.");for(;h;)try{if(i=1,s&&(o=s[2&r[0]?"return":r[0]?"throw":"next"])&&!(o=o.call(s,r[1])).done)return o;switch(s=0,o&&(r=[0,o.value]),r[0]){case 0:case 1:o=r;break;case 4:return h.label++,{value:r[1],done:!1};case 5:h.label++,s=r[1],r=[0];continue;case 7:r=h.ops.pop(),h.trys.pop();continue;default:if(o=h.trys,!(o=o.length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){h=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){h.label=r[1];break}if(6===r[0]&&h.label<o[1]){h.label=o[1],o=r;break}if(o&&h.label<o[2]){h.label=o[2],h.ops.push(r);break}o[2]&&h.ops.pop(),h.trys.pop();continue}r=e.call(t,h)}catch(t){r=[6,t],s=0}finally{i=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var i,s,o,h={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return{next:r(0),throw:r(1),return:r(2)}},Promise=this&&this.Promise||this.ES6Promise;String.prototype.startsWith||(String.prototype.startsWith=function(t,e){return e=e||0,this.substr(e,t.length)===t}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Explorer3d=t.Explorer3d||{})}(this,function(t){"use strict";function e(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}function r(t,e,r,n){return new(r||(r=Promise))(function(i,s){function o(t){try{u(n.next(t))}catch(t){s(t)}}function h(t){try{u(n.throw(t))}catch(t){s(t)}}function u(t){t.done?i(t.value):new r(function(e){e(t.value)}).then(o,h)}u((n=n.apply(t,e)).next())})}function n(t){var e=t.split(/\s+/g),r=(e.length,{get xyz(){return[this.x,this.y,this.z]}});return e.forEach(function(t,e){switch(e){case 0:break;case 1:r.index=parseInt(t)-1;break;case 2:r.vertexId=parseFloat(t)-1;break;case 3:r.properties=[];default:r.properties.push(t)}}),r}function i(t){var e=t.split(/\s+/g);return{id:+e[1]-1,vertices:[+e[2]-1,+e[3]-1]}}function s(t){var e=t.split(/\s+/g);return parseInt(e[1])-1}function o(t){var e=t.split(/\s+/g),r=e.length,n={get abc(){return[this.a,this.b,this.c]}};return 4===r&&(n.a=parseInt(e[1])-1,n.b=parseFloat(e[2])-1,n.c=parseFloat(e[3])-1),n}function h(t,e,r){var n=t.split(/\s+/g),i=(n.length,r?r:1),s=[],o={get xyz(){return[this.x,this.y,this.z]},get all(){var t=[this.x,this.y,this.z];return this.properties&&this.properties.forEach(function(e){t.push(e)}),t}};return n.forEach(function(t,e){switch(e){case 0:break;case 1:o.index=+t-1;break;case 2:s[0]=+t;break;case 3:s[1]=+t;break;case 4:o.z=+t*i;break;case 5:o.properties=[];default:o.properties.push(t)}}),e&&(s=e(s)),o.x=s[0],o.y=s[1],o}function u(t){return t.split(/\s+/g).map(function(t){return t.replace(/\"/g,"")})}function c(t){return t=t.trim(),a(t)&&0!==t.indexOf("#")}function a(t){return 0!==t.trim().length}function p(t){return t}function f(t){return"true"===t}function l(t){if(t){var e=t.trim().split(/\s+/g);return 1===e.length&&0===e[0].indexOf("#")?parseInt("0x"+e[0].substring(1)):255*parseFloat(e[0])*256*256+255*parseFloat(e[1])*256+255*parseFloat(e[2])}return null}function d(t){var e=t.split(/\s+/g);return[parseInt(e[1])-1,parseInt(e[2])-1]}function y(t){var e=t.split(/\s+/g);return[parseInt(e[1]),parseInt(e[2]),parseInt(e[3]),parseInt(e[4])]}function v(t){return t}var b=function(){function t(){}return t.prototype.addEventListener=function(t,e){void 0===this.listeners&&(this.listeners={});var r=this.listeners;void 0===r[t]&&(r[t]=[]),r[t].indexOf(e)===-1&&r[t].push(e)},t.prototype.hasEventListener=function(t,e){if(void 0===this.listeners)return!1;var r=this.listeners;return void 0!==r[t]&&r[t].indexOf(e)!==-1},t.prototype.removeEventListener=function(t,e){if(void 0!==this.listeners){var r=this.listeners[t];void 0!==r&&(this.listeners[t]=r.filter(function(t){return e!==t}))}},t.prototype.dispatchEvent=function(t){var e=this,r=this.listeners;if(void 0!==r){var n=r[t.type];void 0!==n&&(t.target=this,n.forEach(function(r){return r.call(e,t)}))}},t.prototype.removeAllListeners=function(){this.listeners=void 0},t}(),m=function(t){function r(){var e=t.call(this)||this;return e.complete=!1,e}return e(r,t),r}(b),g=function(){function t(){}return t}();g.names=["bstones","borders","complete","header","vertices","faces","lines","properties"];var x=function(){function t(t,e,r){this.type=t,this.data=e,this.target=r}return t}(),E=function(){function t(t,e){this.min=t,this.max=e}return t}(),w=function(){function t(t,e,r){this.x=t,this.y=e,this.z=r}return t}(),O=function(){function t(){}return t.fromVertices=function(e){void 0===e&&(e=[]);var r;return e.forEach(function(e){r=t.expand(r,e)}),r},t.expand=function(t,e){return void 0===t&&(t=new E(new w(1/0,1/0,1/0),new w((-(1/0)),(-(1/0)),(-(1/0))))),t.min.x=Math.min(t.min.x,e[0]),t.min.y=Math.min(t.min.y,e[1]),t.min.z=Math.min(t.min.z,e[2]),t.max.x=Math.max(t.max.x,e[0]),t.max.y=Math.max(t.max.y,e[1]),t.max.z=Math.max(t.max.z,e[2]),t},t.toThreeBox3=function(t){return new THREE.Box3(new THREE.Vector3(t.min.x,t.min.y,t.min.z),new THREE.Vector3(t.max.x,t.max.y,t.max.z))},t}(),S=function(){function t(){}return t.subVectors=function(t,e){return new w(t[0]-e[0],t[1]-e[1],t[2]-e[2])},t.cross=function(t,e){var r=t.x,n=t.y,i=t.z,s=e.x,o=e.y,h=e.z,u=n*h-i*o,c=i*s-r*h,a=r*o-n*s;return new w(u,c,a)},t.normalize=function(e){return t.divideScalar(e,t.calcLength(e))},t.calcLength=function(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)},t.divideScalar=function(e,r){return t.multiplyScalar(e,1/r)},t.multiplyScalar=function(t,e){return isFinite(e)?(t.x*=e,t.y*=e,t.z*=e):(t.x=0,t.y=0,t.z=0),t},t}(),j=function(){function t(){}return t.computeNormal=function(t,e){var r=e[t[0]],n=e[t[1]],i=e[t[2]],s=S.subVectors(i,n),o=S.subVectors(r,n);s=S.cross(s,o),S.normalize(s),t[3]=s},t}(),P=function(){function t(){this.type="Type",this.isValid=!1}return t}(),T=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="TSurf",e.vertices=[],e.faces=[],e.bstones=[],e.borders=[],e}return e(r,t),r}(P),B=function(){function t(){this.isValid=!0,this.typeMap={AXIS_NAME:u,AXIS_UNIT:u}}return t}(),k=function(t){function r(){var e=t.call(this)||this;return e.state=0,e}return e(r,t),r}(m),F=function(t){function r(){var e=t.call(this)||this;return e.coordinateSystem=new B,e.validHeader=!1,e}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.coordinateSystem},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsurf pusher");switch(this.state){case 0:return this.hasBlock(t);case 1:return this.pushData(t)}},r.prototype.hasBlock=function(t){if(t=t.trim(),t.length){if("GOCAD_ORIGINAL_COORDINATE_SYSTEM"!==t)return this.complete=!0,this.coordinateSystem.isValid=!1,!1;this.state++}return!0},r.prototype.pushData=function(t){if(c(t))if("END_ORIGINAL_COORDINATE_SYSTEM"!==t){var e=t.indexOf(" ");if(e>0){var r=t.substring(0,e),n=t.substring(e).trim(),i=this.coordinateSystem.typeMap[r]?this.coordinateSystem.typeMap[r]:function(t){return t};this.coordinateSystem[r]=i(n)}}else this.coordinateSystem.typeMap=null,this.complete=!0;return!0},r}(k),I=function(){function t(){}return t.noop=function(){},Object.defineProperty(t,"level",{set:function(e){var r=parseInt(e);if(r=NaN===r?0:r,!t._broken){t.log=console.log;try{t.log("Setting log level")}catch(e){t._broken=!0}}t._broken?(t.log=r>=64?function(t){console.log(t)}:t.noop,t.info=r>=32?function(t){console.info(t)}:t.noop,t.warn=r>=16?function(t){console.warn(t)}:t.noop,t.log=r>=8?function(t){console.log(t)}:t.noop):(t.log=r>=64?console.log:t.noop,t.info=r>=32?console.info:t.noop,t.warn=r>=16?console.warn:t.noop,t.error=r>=8?console.error:t.noop)},enumerable:!0,configurable:!0}),t}();I.LOG_ALL=64,I.LOG_INFO=32,I.LOG_WARN=16,I.LOG_ERROR=8,I.LOG_NOTHING=0,I._broken=!1,I.log=I.noop,I.error=I.noop,I.info=I.noop,I.warn=I.noop;var _=function(){function t(){this.values={},this.typeMap={ivolmap:f,imap:f,parts:f,mesh:f,cn:f,border:f,"*solid*color":l}}return t}(),z=function(t){function r(){var e=t.call(this)||this;return e.header=new _,e}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.header},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(!c(t))return!0;if(t=t.trim(),0===t.indexOf("}"))this.postLoad();else{var e=t.split(":");if(2===e.length){var r=this.header.typeMap[e[0]];r=r?r:p,this.header.values[e[0]]=r(e[1])}else I.warn("That doesn't look like a pair: "+t)}return!0},r.prototype.postLoad=function(){this.complete=!0;var t=this.header;t.name=t.values.name,t.solidColor=t.values["*solid*color"],t.solidColor=t.solidColor?t.solidColor:15658734,t.typeMap=null},r}(m),H=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.tsurf=new T,r.zSign=1,r.readTface=!1,r.verticesBuffer=[],r.facesBuffer=[],r.bordersBuffer=[],r.bstonesBuffer=[],r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.tsurf},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsurf pusher");switch(this.state){case 0:return this.waitForHead(t);case 1:return this.loadHeader(t);case 2:return this.loadCs(t);case 3:return this.waitForTface(t);case 4:return this.processToEnd(t)}},r.prototype.waitForHead=function(t){return t.startsWith("HEADER")&&(t.indexOf("{")===-1?this.complete=!0:this.headerPusher=new z,this.state++),!0},r.prototype.loadHeader=function(t){return this.headerPusher.push(t),this.headerPusher.complete&&(this.tsurf.header=this.headerPusher.obj,this.csPusher=new F,this.state++),!0},r.prototype.loadCs=function(t){return this.csPusher.push(t),this.csPusher.complete&&(this.csPusher.obj.isValid&&(this.tsurf.coordinateSystem=this.csPusher.obj,this.zSign="Depth"===this.tsurf.coordinateSystem.ZPOSITIVE?-1:1),this.state++,this.dispatchEvent(new x("header",this.tsurf))),!0},r.prototype.waitForTface=function(t){return t.indexOf("TFACE")||this.state++,!0},r.prototype.processToEnd=function(t){if(t=t.trim(),"END"===t)this.complete=!0,this.state=99,this.flushVertices(),this.flushFaces(),this.flushBstones(),this.flushBorders(),this.tsurf.vertices=[],this.dispatchEvent(new x("complete",{header:this.tsurf.header,coordinateSystem:this.tsurf.coordinateSystem,bbox:this.tsurf.bbox}));else{var e=this.tsurf,r=t.indexOf("VRTX");if(0===r||1===r){var u=h(t,this.projectionFn,this.zSign);e.vertices[u.index]=u.all,this.tsurf.bbox=O.expand(this.tsurf.bbox,u.all),this.checkVertices(u.all)}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var c=n(t);this.checkVertices(e.vertices[c.index]=e.vertices[c.vertexId])}else if(0===t.indexOf("TRGL")){var a=o(t).abc;j.computeNormal(a,this.tsurf.vertices),this.checkFaces(a)}else if(0===t.indexOf("BSTONE")){var p=s(t);this.checkBstones(p)}else if(0===t.indexOf("BORDER")){var f=i(t);this.checkBorders([f.vertices[0],f.vertices[1]])}}return!0},r.prototype.checkVertices=function(t){this.verticesBuffer.push(t),this.verticesBuffer.length>=r.PAGE_SIZE&&this.flushVertices()},r.prototype.flushVertices=function(){this.verticesBuffer=this.flush("vertices",this.verticesBuffer)},r.prototype.checkFaces=function(t){this.facesBuffer.push(t),this.facesBuffer.length>=r.PAGE_SIZE&&this.flushFaces()},r.prototype.flushFaces=function(){this.facesBuffer=this.flush("faces",this.facesBuffer)},r.prototype.checkBorders=function(t){this.bordersBuffer.push(t),this.bordersBuffer.length>=r.PAGE_SIZE&&this.flushBorders()},r.prototype.flushBorders=function(){this.bordersBuffer=this.flush("borders",this.bordersBuffer)},r.prototype.checkBstones=function(t){this.bstonesBuffer.push(t),this.bstonesBuffer.length>=r.PAGE_SIZE&&this.flushBstones()},r.prototype.flushBstones=function(){this.bstonesBuffer=this.flush("bstones",this.bstonesBuffer)},r.prototype.flush=function(t,e){return e.length&&this.dispatchEvent(new x(t,e)),[]},r}(k);H.PAGE_SIZE=65536;var V=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r}(_),A=function(t){function r(){return t.call(this)||this}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.plineHeader},enumerable:!0,configurable:!0}),r.prototype.push=function(e){var r=t.prototype.push.call(this,e);if(this.complete){this.complete=!0,this.plineHeader=Object.assign(new V,this.header),this.plineHeader.typeMap=null,this.plineHeader.paintedVariable=this.plineHeader.values["*painted*variable"];var n=this.plineHeader.values["*line*color"];this.plineHeader.color=n?l(n):255}return r},r}(z),D=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="PLine",e.vertices=[],e.lines=[],e}return e(r,t),r}(P),M=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.pline=new D,r.verticesBuffer=[],r.segmentsBuffer=[],r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.pline},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsolid pusher");switch(this.state){case 0:return this.expectHeader(t);case 1:return this.pushHeader(t);case 2:return this.pushCs(t);case 3:return this.expectIline(t);case 4:return this.pushData(t)}return!0},r.prototype.expectHeader=function(t){return t=t.trim(),!t.startsWith("HEADER")||(t&&t.indexOf("{")!==-1?(this.child=new A,this.state++,!0):(this.complete=!0,!0))},r.prototype.pushHeader=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.pline.header=this.child.obj,this.child=new F),e},r.prototype.pushCs=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.child.isValid&&(this.pline.coordinateSystem=this.child.obj,this.zSign="Depth"===this.pline.coordinateSystem.ZPOSITIVE?-1:1),this.dispatchEvent(new x("header",this.pline))),e},r.prototype.expectIline=function(t){return t.startsWith("ILINE")&&this.state++,!0},r.prototype.pushData=function(t){if(void 0===t&&(t=""),t=t.trim(),!t)return!0;var e=this.pline;if(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")){var r=h(t,this.projectionFn,this.zSign);this.verticesBuffer[r.index]=r.all,e.bbox=O.expand(e.bbox,r.all)}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var i=n(t),r=this.verticesBuffer[i.vertexId];this.verticesBuffer[i.index]=r}else if(0===t.indexOf("SEG")){var s=d(t);this.segmentsBuffer.push(this.verticesBuffer[s[0]]),this.segmentsBuffer.push(this.verticesBuffer[s[1]]),this.checkSegments()}else 0!==t.indexOf("ILINE")&&0!==t.indexOf("END")||(this.complete=0===t.indexOf("END"),this.verticesBuffer=[],this.complete&&(this.flushSegments(),this.dispatchEvent(new x("complete",{header:e.header,coordinateSystem:e.coordinateSystem,bbox:e.bbox}))));return!0},r.prototype.checkSegments=function(){this.segmentsBuffer.length>=r.PAGE_SIZE&&this.flushSegments()},r.prototype.flushSegments=function(){this.segmentsBuffer=this.flush("vertices",this.segmentsBuffer)},r.prototype.flush=function(t,e){return e.length&&this.dispatchEvent(new x(t,e)),[]},r}(k);M.PAGE_SIZE=32768;var N=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="TSolid",e.vertices=[],e.tetras=[],e}return e(r,t),r}(P),L=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.tsolid=new N,r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.tsolid},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsolid pusher");switch(this.state){case 0:return this.expectHeader(t);case 1:return this.pushHeader(t);case 2:return this.pushCs(t);case 3:return this.expectTvolume(t);case 4:return this.pushData(t)}return!0},r.prototype.expectHeader=function(t){return t.startsWith("HEADER")&&(this.child=new z,this.state++),!0},r.prototype.pushHeader=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.tsolid.header=this.child.obj,this.child=new F),e},r.prototype.pushCs=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.tsolid.coordinateSystem=this.child.obj,this.zSign="Depth"===this.tsolid.coordinateSystem.ZPOSITIVE?-1:1),e},r.prototype.expectTvolume=function(t){return t.startsWith("TVOLUME")&&this.state++,!0},r.prototype.pushData=function(t){if(t=t.trim(),"END"===t)if(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")){var e=h(t,this.projectionFn,this.zSign);this.tsolid.vertices[e.index]=e.all}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var r=n(t);this.tsolid.vertices[r.index]=this.tsolid.vertices[r.vertexId]}else 0===t.indexOf("TETRA")&&this.tsolid.tetras.push(y(t));else this.complete=!0;return!0},r}(k),R=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="VSet",e.vertices=[],e}return e(r,t),r}(P),G=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r}(_),C=function(t){function r(){return t.call(this)||this}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.vsetHeader},enumerable:!0,configurable:!0}),r.prototype.push=function(e){var r=t.prototype.push.call(this,e);return this.complete&&(this.complete=!0,this.vsetHeader=Object.assign(new G,this.header),this.vsetHeader.color=l(this.vsetHeader.values["*atoms*color"])),r},r}(z),W=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.verticesBuffer=[],r.vset=new R,r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.vset},enumerable:!0,configurable:!0}),r.prototype.push=function(t){if(this.complete)throw new Error("Pushed line to completed tsolid pusher");switch(this.state){case 0:return this.expectHeader(t);case 1:return this.pushHeader(t);case 2:return this.pushCs(t);case 3:return this.pushData(t)}return!0},r.prototype.expectHeader=function(t){return void 0===t&&(t=""),t=t.trim(),!t.startsWith("HEADER")||(t.indexOf("{")===-1&&(this.complete=!0),this.child=new C,this.state++,!0)},r.prototype.pushHeader=function(t){void 0===t&&(t="");var e=this.child.push(t);return this.child.complete&&(this.state++,this.vset.header=this.child.obj,this.child=new F,this.zSign=1,this.dispatchEvent(new x("header",this.vset))),e},r.prototype.pushCs=function(t){var e=this.child.push(t);return this.child.complete&&(this.state++,this.vset.coordinateSystem=this.child.obj,this.zSign="Depth"===this.vset.coordinateSystem.ZPOSITIVE?-1:1),e},r.prototype.pushData=function(t){if(void 0===t&&(t=""),t=t.trim())if(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")){var e=h(t,this.projectionFn,this.zSign);this.vset.bbox=O.expand(this.vset.bbox,e.all),this.checkVertices(e.all)}else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM")){var r=n(t);this.checkVertices(this.vset.vertices[r.vertexId])}else t.startsWith("END")&&!t.startsWith("END_")&&(this.complete=!0,this.flushVertices(),this.dispatchEvent(new x("complete",{header:this.vset.header,coordinateSystem:this.vset.coordinateSystem,bbox:this.vset.bbox})));return!0},r.prototype.checkVertices=function(t){this.verticesBuffer.push(t),this.verticesBuffer.length>=r.PAGE_SIZE&&this.flushVertices()},r.prototype.flushVertices=function(){this.verticesBuffer=this.flush("vertices",this.verticesBuffer)},r.prototype.flush=function(t,e){return e.length&&this.dispatchEvent(new x(t,e)),[]},r}(k);W.PAGE_SIZE=65536;var Z=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="Unknown",e}return e(r,t),r}(P),X=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.unknown=new Z,r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.unknown},enumerable:!0,configurable:!0}),r.prototype.push=function(t){return"END"===t.trim()&&(this.complete=!0),!0},r}(m),U=function(){function t(){this.isValid=!1}return t}(),q=function(t){function r(e){var r=t.call(this)||this;return r.projectionFn=e,r.typeFactory=new U,r}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.type.obj},enumerable:!0,configurable:!0}),r.prototype.push=function(t){var e=!0;return this.type?(e=this.type.push(t),this.complete=this.type.complete):e=this.create(t),e},r.prototype.create=function(t){function e(t){I.log("TFP: "+t.type),i.dispatchEvent(t)}var r=this;t=t.trim();var n=t.split(/\s+/g);this.typeFactory.isValid=3===n.length&&"GOCAD"===n[0]&&("1.0"===n[2]||"1"===n[2]),this.typeFactory.isValid&&(this.typeFactory.version=n[2],"TSurf"===n[1]?this.type=new H(this.projectionFn):"PLine"===n[1]?this.type=new M(this.projectionFn):"TSolid"===n[1]?this.type=new L(this.projectionFn):"VSet"===n[1]?this.type=new W(this.projectionFn):this.type=new X(this.projectionFn));var i=this;return g.names.forEach(function(t){return r.type.addEventListener(t,e)}),this.typeFactory.isValid},r}(m),Y=function(){function t(){this.types=[]}return t}(),J=function(t){function r(){var e=t.call(this)||this;return e.types=[],e}return e(r,t),r}(Y),K=function(t){function r(e,r){var n=t.call(this)||this;return n.proj4=r,n.eventHandler=function(t){I.log("DP: "+t.type),n.dispatchEvent(t)},e&&e.from&&e.to&&e.from!==e.to&&r?(r.defs("EPSG:3112","+proj=lcc +lat_1=-18 +lat_2=-36 +lat_0=0 +lon_0=134 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"),n.projectionFn=function(t,e){return function(n){return r(t,e,[n[0],n[1]])}}(e.from,e.to)):n.projectionFn=v,n.document=new J,n.typefactorypusher=n.createTypeFactoryPusher(n.projectionFn),n}return e(r,t),Object.defineProperty(r.prototype,"obj",{get:function(){return this.document},enumerable:!0,configurable:!0}),r.prototype.push=function(t){var e=this.typefactorypusher.push(t);return e?(this.typefactorypusher.complete&&(this.complete=!0,this.document.types.push(this.typefactorypusher.obj),this.destroyTypeFactoryPusher(this.typefactorypusher),this.typefactorypusher=this.createTypeFactoryPusher(this.projectionFn)),!0):(I.log("NOT PUSHED: "+t),this.push(t),!0)},r.prototype.createTypeFactoryPusher=function(t){var e=this,r=new q(t);return g.names.forEach(function(t){r.addEventListener(t,e.eventHandler)}),r},r.prototype.destroyTypeFactoryPusher=function(t){var e=this;g.names.forEach(function(r){t.removeEventListener(r,e.eventHandler)})},r}(m),Q=function(){function t(t){this.callback=t}return t.prototype.receiver=function(t){var e=this;t.forEach(function(t){e.callback(t)})},t}(),$=function(){function t(t,e){this.url=t,this.callback=e}return t.prototype.start=function(){var t=this;return new Promise(function(e,r){var n=t,i=new XMLHttpRequest,s=0,o=[],h=function(){if(null===i.readyState||!(i.readyState<3||200!==i.status)){for(var t=i.responseText,r=t.length,h=s;h<r;h++){var u=t[h];if("\r"!==u)if("\n"!==u)o.push(u);else{var c=o.join("");o=[],n.callback(c)}}s=r,4===i.readyState&&e(null)}};i.onreadystatechange=h,i.open("get",t.url),i.send()})},t}(),tt=function(){function t(t,e,r){this.file=t,this.callback=r,this.blockSize=16384,this.file=t,this.length=t.size,this.pageNo=-1,this.index=0,this.blockSize=e.blockSize?e.blockSize:this.blockSize,this.reader,this.lineBuffer=[],this.reader=new FileReader}return t.prototype.start=function(){return r(this,void 0,void 0,function(){var t,e,r,n,i;return __generator(this,function(s){switch(s.label){case 0:return[4,this.read()];case 1:t=s.sent(),e=[],s.label=2;case 2:if(!t)return[3,8];switch(r=this.next(),n=r.state){case"more":return[3,3];case"line":return[3,5];case"complete":return[3,6]}return[3,7];case 3:i=e,e=[];try{this.callback(i)}catch(t){I.error(t),I.error("Someone died. Continue on.\n\n"+i.join("\n").substr(0,2e3))}return[4,this.read()];case 4:return t=s.sent(),[3,7];case 5:return e.push(r.line),[3,7];case 6:if(e.push(r.line),e.length)try{this.callback(e)}catch(t){I.error(t),I.error("Someone died. Continue on.\n\n"+e.join("\n").substr(0,2e3))}return t=!1,[3,7];case 7:return[3,2];case 8:return[2]}})})},t.prototype.read=function(){return r(this,void 0,void 0,function(){var t,e,r=this;return __generator(this,function(n){return this.pageNo++,this.index=0,t=this,e=this.pageNo*this.blockSize,I.log("Block size: "+this.blockSize+", file size: "+this.length),[2,new Promise(function(n){if(e>=r.length)return void n(!1);try{t.reader.onloadend=function(e){I.log("We have loaded with ready state = "+e.target.readyState),e.target.readyState===FileReader.prototype.DONE&&(I.log("Reading page "+t.pageNo),t.buffer=e.target.result,n(r.hasMore()))},t.reader.onerror=function(t){I.log("What do you mean, error")};var i=t.file.slice(e,e+t.blockSize);t.reader.readAsText(i)}catch(t){I.log(t)}})]})})},t.prototype.hasMore=function(){return this.index+this.blockSize*this.pageNo<this.length-1},t.prototype.next=function(){for(;this.hasMore();){if(!this.buffer||this.index>=this.blockSize)return{state:"more"};var t=this.buffer[this.index++];if("\r"!==t){if("\n"===t)break;this.lineBuffer.push(t)}}var e=this.lineBuffer.join("");return this.lineBuffer=[],{state:this.hasMore()?"line":"complete",line:e}},t}();t.DocumentPusher=K,t.LinesToLinePusher=Q,t.HttpPusher=$,t.LinesPagedPusher=tt,t.Logger=I,Object.defineProperty(t,"__esModule",{value:!0})});