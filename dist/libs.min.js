!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Explorer3d=t.Explorer3d||{})}(this,function(t){"use strict";function e(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function i(t){return t.split(/\s+/g).map(function(t){return t.replace(/\"/g,"")})}function n(t){var e=t.split(/\s+/g),i=(e.length,{get xyz(){return[this.x,this.y,this.z]}});return e.forEach(function(t,e){switch(e){case 0:break;case 1:i.index=parseInt(t);break;case 2:i.vertexId=parseFloat(t);break;case 3:i.properties=[];default:i.properties.push(t)}}),i}function r(t,e,i){var n=t.split(/\s+/g),r=(n.length,i?i:1),s=[],o={get xyz(){return[this.x,this.y,this.z]},get all(){var t=[this.x,this.y,this.z];return this.properties&&this.properties.forEach(function(e){t.push(e)}),t}};return n.forEach(function(t,e){switch(e){case 0:break;case 1:o.index=parseInt(t);break;case 2:s[0]=parseFloat(t);break;case 3:s[1]=parseFloat(t);break;case 4:o.z=parseFloat(t)*r;break;case 5:o.properties=[];default:o.properties.push(t)}}),e&&(s=e(s)),o.x=s[0],o.y=s[1],o}function s(t){return"true"===t}function o(t){return t}function a(t){if(t){var e=t.trim().split(/\s+/g);return 1===e.length&&0===e[0].indexOf("#")?parseInt("0x"+e[0].substring(1)):255*parseFloat(e[0])*256*256+255*parseFloat(e[1])*256+255*parseFloat(e[2])}return null}function h(t){var e=t.split(/\s+/g);return{id:+e[1],vertices:[+e[2],+e[3]]}}function f(t){var e=t.split(/\s+/g),i=e.length,n={get abc(){return[this.a,this.b,this.c]}};return 4===i&&(n.a=parseInt(e[1]),n.b=parseFloat(e[2]),n.c=parseFloat(e[3])),n}function c(t){var e=t.split(/\s+/g);return parseInt(e[1])}function l(t){var e=t.split(/\s+/g);return[parseInt(e[1]),parseInt(e[2])]}function p(t){var e=t.split(/\s+/g);return[parseInt(e[1]),parseInt(e[2]),parseInt(e[3]),parseInt(e[4])]}function u(t){var e=t.split(/\s+/g);return e.shift(),e}function d(t,e){var i=Array.isArray(e),n=i&&[]||{};if(Array.isArray(e)){var r=n;t=t||[],r=r.concat(t),e.forEach(function(e,i){"undefined"==typeof r[i]?r[i]=e:"object"==typeof e?r[i]=d(t[i],e):t.indexOf(e)===-1&&r.push(e)})}else t&&"object"==typeof t&&Object.keys(t).forEach(function(e){n[e]=t[e]}),Object.keys(e).forEach(function(i){"object"==typeof e[i]&&e[i]&&t[i]?n[i]=d(t[i],e[i]):n[i]=e[i]});return n}function v(t,e){var i,n,r,s=-1,o=t.length;if(null==e){for(;++s<o;)if(null!=(n=t[s])&&n>=n){i=r=n;break}for(;++s<o;)null!=(n=t[s])&&(i=Math.min(i,n),r=Math.max(r,n))}else{for(;++s<o;)if(null!=(n=e(t[s],s,t))&&n>=n){i=r=n;break}for(;++s<o;)null!=(n=e(t[s],s,t))&&(i=Math.min(i,n),r=Math.max(r,n))}return[i,r]}function x(t){if("undefined"!=typeof DOMParser)return(new DOMParser).parseFromString(t,"text/xml");if("undefined"!=typeof ActiveXObject&&new ActiveXObject("Microsoft.XMLDOM")){var e=new ActiveXObject("Microsoft.XMLDOM");return e.async="false",e.loadXML(t),e}return null}var y=function(){function t(t){this.isValid=!0,this.typeMap={AXIS_NAME:i,AXIS_UNIT:i};var e=t.nextDataLine().trim();if("GOCAD_ORIGINAL_COORDINATE_SYSTEM"!==e)t.previous(),this.isValid=!1;else for(e=t.nextDataLine().trim();e&&"END_ORIGINAL_COORDINATE_SYSTEM"!==e;){var n=e.indexOf(" ");if(n>0){var r=e.substring(0,n),s=e.substring(n).trim(),o=this.typeMap[r]?this.typeMap[r]:function(t){return t};this[r]=o(s)}e=t.nextDataLine().trim()}this.typeMap=null}return t}(),O=function(){function t(){}return t.prototype.apply=function(e){e.addEventListener=t.prototype.addEventListener,e.hasEventListener=t.prototype.hasEventListener,e.removeEventListener=t.prototype.removeEventListener,e.dispatchEvent=t.prototype.dispatchEvent},t.prototype.addEventListener=function(t,e){void 0===this._listeners&&(this._listeners={});var i=this._listeners;void 0===i[t]&&(i[t]=[]),i[t].indexOf(e)===-1&&i[t].push(e)},t.prototype.hasEventListener=function(t,e){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[t]&&i[t].indexOf(e)!==-1},t.prototype.removeEventListener=function(t,e){if(void 0!==this._listeners){var i=this._listeners,n=i[t];if(void 0!==n){var r=n.indexOf(e);r!==-1&&n.splice(r,1)}}},t.prototype.dispatchEvent=function(){},t}(),E=function(t){function i(e,i){t.call(this),this.type="Type",this.projectionFn=function(t){return t},this.isValid=!1,this.reader=e,i&&(this.projectionFn=i)}return e(i,t),i.prototype.clear=function(){this.reader=null},i}(O),m=function(){function t(t){this.values={},this.typeMap={ivolmap:s,imap:s,parts:s,mesh:s,cn:s,border:s,"*solid*color":a};for(var e=t.nextDataLine().trim();e&&0!==e.indexOf("}");){var i=e.split(":");if(2===i.length){var n=this.typeMap[i[0]];n=n?n:o,this.values[i[0]]=n(i[1])}else console.warn("That doesn't look like a pair: "+e);e=t.nextDataLine().trim()}this.name=this.values.name,this.solidColor=this.values["*solid*color"],this.solidColor=this.solidColor?this.solidColor:15658734,this.typeMap=null}return t.prototype.toColor=function(t){return a(t)},t.prototype.toBool=function(t){return s(t)},t}(),g=function(t){function i(e,i){t.call(this,e,i),this.type="TSurf",this.vertices=[],this.faces=[],this.bstones=[],this.borders=[];var s=e.expects("HEADER");if(s&&s.indexOf("{")!==-1){this.header=new m(e);var o=new y(e),a=1;for(o.isValid&&(this.coordinateSystem=o,a="Depth"===this.coordinateSystem.ZPOSITIVE?-1:1),s=e.expects("TFACE");"END"!==(s=e.nextDataLine().trim());)if(0===s.indexOf("VRTX")||0===s.indexOf("PVRTX")){var l=r(s,this.projectionFn,a);this.vertices[l.index]=l.all}else if(0===s.indexOf("ATOM")||0===s.indexOf("PATOM")){var p=n(s);this.vertices[p.index]=this.vertices[p.vertexId]}else if(0===s.indexOf("TRGL"))this.faces.push(f(s).abc);else if(0===s.indexOf("BSTONE"))this.bstones.push(c(s));else if(0===s.indexOf("BORDER")){var u=h(s);this.borders[u.id]=[u.vertices[0],u.vertices[1]]}this.clear()}}return e(i,t),i}(E),S=function(t){function i(e){t.call(this,e),this.paintedVariable=this.values["*painted*variable"];var i=this.values["*line*color"];this.color=i?this.toColor(i):255}return e(i,t),i}(m),T=function(t){function i(e,i){t.call(this,e,i),this.type="PLine",this.vertices=[],this.lines=[];var s=e.expects("HEADER");if(s&&s.indexOf("{")!==-1){this.header=new S(e);var o=new y(e),a=1;o.isValid&&(this.coordinateSystem=o,a="Depth"===this.coordinateSystem.ZPOSITIVE?-1:1),s=e.expects("ILINE");var h=1,f=1,c=!1,p=[];s=e.nextDataLine();for(var u="}"===(s?s.trim():"}");!u;){if(0===s.indexOf("VRTX")||0===s.indexOf("PVRTX")){var d=r(s,this.projectionFn,a);this.vertices[d.index]=d.all,f=d.index}else if(0===s.indexOf("ATOM")||0===s.indexOf("PATOM")){var v=n(s);this.vertices[v.index]=this.vertices[v.vertexId]}else if(0===s.indexOf("SEG"))p.push(l(s)),c=!0;else if(0===s.indexOf("ILINE")||0===s.indexOf("END")){if(u=0===s.indexOf("END"),!c&&f>h)for(var x=h;x<f;x++)p.push([x,x+1]);this.lines.push(p),p=[],h=f+1,c=!1}u=!e.hasMore(),u||(u="}"===(s=e.nextDataLine().trim()))}this.clear()}}return e(i,t),i}(E),b=function(t){function i(e,i){t.call(this,e,i),this.type="TSolid",this.vertices=[],this.tetras=[];var s=e.expects("HEADER");if(s){this.header=new m(e);var o=new y(e),a=1;for(o.isValid&&(this.coordinateSystem=o,a="Depth"===this.coordinateSystem.ZPOSITIVE?-1:1),s=e.expects("TVOLUME");"END"!==(s=e.nextDataLine().trim());)if(0===s.indexOf("VRTX")||0===s.indexOf("PVRTX")){var h=r(s,this.projectionFn,a);this.vertices[h.index]=h.all}else if(0===s.indexOf("ATOM")||0===s.indexOf("PATOM")){var f=n(s);this.vertices[f.index]=this.vertices[f.vertexId]}else 0===s.indexOf("TETRA")&&this.tetras.push(p(s));this.clear()}}return e(i,t),i}(E),I=function(t){function i(e){t.call(this,e),this.color=this.toColor(this.values["*atoms*color"])}return e(i,t),i}(m),D=function(t){function i(e,i){t.call(this,e,i),this.type="VSet",this.vertices=[];var s=e.expects("HEADER");if(s&&s.indexOf("{")!==-1){this.header=new I(e);var o=new y(e),a=1;for(o.isValid&&(this.coordinateSystem=o,a="Depth"===this.coordinateSystem.ZPOSITIVE?-1:1);"END"!==(s=e.nextDataLine().trim());)if(0===s.indexOf("VRTX")||0===s.indexOf("PVRTX")){var h=r(s,i,a);this.vertices[h.index]=h.all}else if(0===s.indexOf("ATOM")||0===s.indexOf("PATOM")){var f=n(s);this.vertices[f.index]=this.vertices[f.vertexId]}this.clear()}}return e(i,t),i}(E),L=function(t){function i(e,i){for(t.call(this,e,i),this.type="Unknown";e.hasMore();){var n=e.next().trim();if("END"===n)break}this.clear()}return e(i,t),i}(E),M=function(){function t(t,e){if(this.isValid=!1,t.hasMore()){var i=t.next().trim(),n=i.split(/\s+/g);this.isValid=3===n.length&&"GOCAD"===n[0]&&("1.0"===n[2]||"1"===n[2]),this.isValid&&(this.version=n[2],"TSurf"===n[1]?this.type=new g(t,e):"PLine"===n[1]?this.type=new T(t,e):"TSolid"===n[1]?this.type=new b(t,e):"VSet"===n[1]?this.type=new D(t,e):this.type=new L(t,e))}}return t}(),A=function(){function t(t,e){if(this.types=[],this.reader=t,t.hasMore()){var i=new M(t,e);i.isValid&&this.types.push(i.type)}this.clean()}return t.prototype.clean=function(){this.reader=null,this.types&&this.types.forEach(function(t){t.projectionFn=null})},t}(),P=function(){function t(t,e){var i=this;this.isValid=!0,this.names={},this.range={min:null,max:null},this.terminator="}",e=e?e:[],e.push(this.terminator);var n=t.nextDataLine().trim();if(this.isValid=!1,0!==n.indexOf("PROPERTIES"))t.previous();else{var r=u(n);for(r.length&&r.forEach(function(t){i.names[t]={}}),this.isValid=!0,n=t.nextDataLine().trim();;){var s=u(n);if(0===n.indexOf("PROP_LEGAL_RANGES")&&2===s.length?("**none**"!==s[0]&&(this.range.min=parseFloat(s[0])),"**none**"!==s[1]&&(this.range.min=parseFloat(s[1]))):0===n.indexOf("PROPERTY_CLASSES")&&s.length>0?s.forEach(function(t,e){i.names[r[e]].className=t}):0===n.indexOf("UNITS")&&s.length>0&&s.forEach(function(t,e){i.names[r[e]].unit=t}),n=t.nextDataLine()?n.trim():"}",0===n.indexOf("}"))break}}}return t}(),V=function(){function t(t,e){if(t){var i=t.split(/\s+/g),n=e([parseFloat(i[0]),parseFloat(i[1])]);this.x=n[0],this.y=n[1],this.z=parseFloat(i[2])}}return t}(),R=function(){function t(t,e,i){this.PAGE_SIZE=1048576,this.file=t,this.length=t.size,this.handler=e,this.errorHandler=i,this.pageNo=this.index=0,this.lineBuffer=[],this.process()}return t.prototype.process=function(){this.readPage()},t.prototype.readPage=function(){function t(t){for(var e=0;e<t.length;e++){var i=t[this.index];"\r"!==i&&("\n"!==i?this.lineBuffer.push(t[e]):(this.handler(this.lineBuffer.join("")),this.lineBuffer=[]))}}var e=this,i=this.pageNo*this.PAGE_SIZE;i>=this.length&&this.complete();var n=new FileReader,r=this.file.slice(i,i+this.PAGE_SIZE);n.onloadend=function(i){if(i.target.readyState===FileReader.prototype.DONE){var n=i.target.result;t(n),e.pageNo++,e.readPage()}},n.readAsText(r)},t.prototype.complete=function(){this.lineBuffer.length&&this.handler(this.lineBuffer.join("")),this.handler(null)},t}(),j=function(){function t(t){this.indexStack=[],this.data=t,this.length=t.length,this.index=0}return t.prototype.hasMore=function(){return this.index<this.length-1},t.prototype.peek=function(){this.next();this.previous()},t.prototype.previous=function(){this.indexStack.length&&(this.index=this.indexStack.pop())},t.prototype.next=function(){this.indexStack.push(this.index);for(var t=[];this.index<this.length;this.index++){var e=this.data[this.index];if("\r"!==e){if("\n"===e){this.index++;break}t.push(this.data[this.index])}}return t?t.join(""):null},t.prototype.expects=function(t){for(;this.hasMore();){var e=this.next();if(!e.indexOf(t))return e}return null},t.prototype.nextNonEmpty=function(){for(;this.hasMore();){var t=this.next();if(t)return t}return null},t.prototype.nextDataLine=function(){for(var t=this.nextNonEmpty();t;){if(t.indexOf("#"))return t;t=this.nextNonEmpty()}return t},t}();t.CoordinateSystem=y,t.Document=A,t.PLine=T,t.PLineHeader=S,t.Properties=P,t.TSolid=b,t.TSurf=g,t.TypeFactory=M,t.Unknown=L,t.Vertex=V,t.VSet=D,t.VSetHeader=I,t.deepMerge=d,t.EventDispatcher=O,t.LinePusher=R,t.LineReader=j,t.range=v,t.parseXml=x,t.toBool=s,t.flowThru=o,t.toColor=a,t.Header=m,t.atom=n,t.vertex=r,t.Type=E,Object.defineProperty(t,"__esModule",{value:!0})});