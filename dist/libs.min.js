!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Explorer3d=e.Explorer3d||{})}(this,function(e){"use strict";function t(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function n(e,t,n,r){return new(n||(n=Promise))(function(i,s){function o(e){try{u(r.next(e))}catch(e){s(e)}}function a(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(o,a)}u((r=r.apply(e,t)).next())})}function r(e){return e.split(/\s+/g).map(function(e){return e.replace(/\"/g,"")})}function i(e){return"true"===e}function s(e){return e}function o(e){if(e){var t=e.trim().split(/\s+/g);return 1===t.length&&0===t[0].indexOf("#")?parseInt("0x"+t[0].substring(1)):255*parseFloat(t[0])*256*256+255*parseFloat(t[1])*256+255*parseFloat(t[2])}return null}function a(e,t,n){var r=e.split(/\s+/g),i=(r.length,n?n:1),s=[],o={get xyz(){return[this.x,this.y,this.z]},get all(){var e=[this.x,this.y,this.z];return this.properties&&this.properties.forEach(function(t){e.push(t)}),e}};return r.forEach(function(e,t){switch(t){case 0:break;case 1:o.index=parseInt(e);break;case 2:s[0]=parseFloat(e);break;case 3:s[1]=parseFloat(e);break;case 4:o.z=parseFloat(e)*i;break;case 5:o.properties=[];default:o.properties.push(e)}}),t&&(s=t(s)),o.x=s[0],o.y=s[1],o}function u(e){var t=e.split(/\s+/g),n=(t.length,{get xyz(){return[this.x,this.y,this.z]}});return t.forEach(function(e,t){switch(t){case 0:break;case 1:n.index=parseInt(e);break;case 2:n.vertexId=parseFloat(e);break;case 3:n.properties=[];default:n.properties.push(e)}}),n}function c(e){var t=e.split(/\s+/g);return{id:+t[1],vertices:[+t[2],+t[3]]}}function d(e){var t=e.split(/\s+/g),n=t.length,r={get abc(){return[this.a,this.b,this.c]}};return 4===n&&(r.a=parseInt(t[1]),r.b=parseFloat(t[2]),r.c=parseFloat(t[3])),r}function h(e){var t=e.split(/\s+/g);return parseInt(t[1])}function f(e){var t=e.split(/\s+/g);return[parseInt(t[1]),parseInt(t[2])]}function p(e){var t=e.split(/\s+/g);return[parseInt(t[1]),parseInt(t[2]),parseInt(t[3]),parseInt(t[4])]}function l(e,t){t.defs("EPSG:3112","+proj=lcc +lat_1=-18 +lat_2=-36 +lat_0=0 +lon_0=134 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");var n=e.data.file,r=e.data.options,i=v;r&&r.from&&r.to&&r.from!==r.to&&(i=function(e,n){return function(r){return t(e,n,[r[0],r[1]])}}(r.from,r.to));n.name;return new Promise(function(e){new Q(new $(n),i).read().then(function(t){e(t)})})}function v(e){return e}function x(e){var t=e.split(/\s+/g);return{id:+t[1],vertices:[+t[2],+t[3]]}}function y(e){var t=e.split(/\s+/g),n=t.length,r={get abc(){return[this.a,this.b,this.c]}};return 4===n&&(r.a=parseInt(t[1]),r.b=parseFloat(t[2]),r.c=parseFloat(t[3])),r}function O(e){var t=e.split(/\s+/g);return parseInt(t[1])}function g(e){var t=e.split(/\s+/g);return[parseInt(t[1]),parseInt(t[2])]}function w(e){var t=e.split(/\s+/g);return[parseInt(t[1]),parseInt(t[2]),parseInt(t[3]),parseInt(t[4])]}function E(e,t){t.defs("EPSG:3112","+proj=lcc +lat_1=-18 +lat_2=-36 +lat_0=0 +lon_0=134 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");var n=e.data.file,r=e.data.options,i=m;r&&r.from&&r.to&&r.from!==r.to&&(i=function(e,n){return function(r){return t(e,n,[r[0],r[1]])}}(r.from,r.to));var s=(n.name,new FileReader);return new Promise(function(e){s.onload=function(t){try{new he(new fe(t.target.result),i).read().then(function(t){e(t)})}catch(t){e(null)}},console.log(n.name),s.readAsText(n)})}function m(e){return e}function _(e,t){var n=Array.isArray(t),r=n&&[]||{};if(Array.isArray(t)){var i=r;e=e||[],i=i.concat(e),t.forEach(function(t,n){"undefined"==typeof i[n]?i[n]=t:"object"==typeof t?i[n]=_(e[n],t):e.indexOf(t)===-1&&i.push(t)})}else e&&"object"==typeof e&&Object.keys(e).forEach(function(t){r[t]=e[t]}),Object.keys(t).forEach(function(n){"object"==typeof t[n]&&t[n]&&e[n]?r[n]=_(e[n],t[n]):r[n]=t[n]});return r}function b(e,t){var n,r,i,s=-1,o=e.length;if(null==t){for(;++s<o;)if(null!=(r=e[s])&&r>=r){n=i=r;break}for(;++s<o;)null!=(r=e[s])&&(n=Math.min(n,r),i=Math.max(i,r))}else{for(;++s<o;)if(null!=(r=t(e[s],s,e))&&r>=r){n=i=r;break}for(;++s<o;)null!=(r=t(e[s],s,e))&&(n=Math.min(n,r),i=Math.max(i,r))}return[n,i]}function T(e){if("undefined"!=typeof DOMParser)return(new DOMParser).parseFromString(e,"text/xml");if("undefined"!=typeof ActiveXObject&&new ActiveXObject("Microsoft.XMLDOM")){var t=new ActiveXObject("Microsoft.XMLDOM");return t.async="false",t.loadXML(e),t}return null}var I=function(){function e(){this.isValid=!0,this.typeMap={AXIS_NAME:r,AXIS_UNIT:r}}return e}(),D=function(){function e(){}return e}(),S=function(){function e(){this.values={},this.typeMap={ivolmap:i,imap:i,parts:i,mesh:i,cn:i,border:i,"*solid*color":o}}return e}(),M=function(){function e(){this.type="Type",this.isValid=!1}return e}(),j=function(e){function n(){var t=e.apply(this,arguments)||this;return t.type="PLine",t.vertices=[],t.lines=[],t}return t(n,e),n}(M),A=function(e){function n(){return e.apply(this,arguments)||this}return t(n,e),n}(S),F=function(){function e(){this.isValid=!0,this.names={},this.range={min:null,max:null}}return e}(),P=function(e){function n(){var t=e.apply(this,arguments)||this;return t.type="TSolid",t.vertices=[],t.tetras=[],t}return t(n,e),n}(M),L=function(e){function n(){var t=e.apply(this,arguments)||this;return t.type="TSurf",t.vertices=[],t.faces=[],t.bstones=[],t.borders=[],t}return t(n,e),n}(M),R=function(){function e(){this.isValid=!1}return e}(),V=function(e){function n(){var t=e.apply(this,arguments)||this;return t.type="Unknown",t}return t(n,e),n}(M),N=function(){function e(e,t){if(e){var n=e.split(/\s+/g),r=t([parseFloat(n[0]),parseFloat(n[1])]);this.x=r[0],this.y=r[1],this.z=parseFloat(n[2])}}return e}(),G=function(e){function n(){var t=e.apply(this,arguments)||this;return t.type="VSet",t.vertices=[],t}return t(n,e),n}(M),X=function(e){function n(){return e.apply(this,arguments)||this}return t(n,e),n}(S),k=function(){function e(e){this.reader=e}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t,n,r,i,s;return __generator(this,function(o){switch(o.label){case 0:return e=new I,[4,this.reader.nextDataLine()];case 1:return t=o.sent().trim(),"GOCAD_ORIGINAL_COORDINATE_SYSTEM"===t?[3,2]:(this.reader.previous(),e.isValid=!0,[3,6]);case 2:return[4,this.reader.nextDataLine()];case 3:t=o.sent().trim(),o.label=4;case 4:return t&&"END_ORIGINAL_COORDINATE_SYSTEM"!==t?(n=t.indexOf(" "),n>0&&(r=t.substring(0,n),i=t.substring(n).trim(),s=e.typeMap[r]?e.typeMap[r]:function(e){return e},e[r]=s(i)),[4,this.reader.nextDataLine()]):[3,6];case 5:return t=o.sent().trim(),[3,4];case 6:return e.typeMap=null,[2,e]}})})},e}(),C=function(){function e(e){this.reader=e}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t,n,r;return __generator(this,function(i){switch(i.label){case 0:return e=new S,[4,this.reader.nextDataLine()];case 1:t=i.sent().trim(),i.label=2;case 2:return t?0===t.indexOf("}")?[3,4]:(n=t.split(":"),2===n.length?(r=e.typeMap[n[0]],r=r?r:s,e.values[n[0]]=r(n[1])):console.warn("That doesn't look like a pair: "+t),[4,this.reader.nextDataLine()]):[3,4];case 3:return t=i.sent().trim(),[3,2];case 4:return e.name=e.values.name,e.solidColor=e.values["*solid*color"],e.solidColor=e.solidColor?e.solidColor:15658734,e.typeMap=null,[2,e]}})})},e}(),Z=function(){function e(e,t){this.reader=e,this.projectionFn=t}return e.prototype.read=function(){return n(this,void 0,void 0,function(){return __generator(this,function(e){return[2,new M]})})},e}(),B=function(e){function r(t,n){return e.call(this,t,n)||this}return t(r,e),r.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t,n,r,i,s,o,f;return __generator(this,function(p){switch(p.label){case 0:return e=new L,[4,this.reader.expects("HEADER")];case 1:return t=p.sent(),t&&t.indexOf("{")!==-1?(n=e,[4,new C(this.reader).read()]):[2,e];case 2:return n.header=p.sent(),[4,new k(this.reader).read()];case 3:return r=p.sent(),i=1,r.isValid&&(e.coordinateSystem=r,i="Depth"===e.coordinateSystem.ZPOSITIVE?-1:1),[4,this.reader.expects("TFACE")];case 4:t=p.sent(),p.label=5;case 5:return[4,this.reader.nextDataLine()];case 6:return"END"===(t=p.sent().trim())?[3,7]:(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")?(s=a(t,this.projectionFn,i),e.vertices[s.index]=s.all):0===t.indexOf("ATOM")||0===t.indexOf("PATOM")?(o=u(t),e.vertices[o.index]=e.vertices[o.vertexId]):0===t.indexOf("TRGL")?e.faces.push(d(t).abc):0===t.indexOf("BSTONE")?e.bstones.push(h(t)):0===t.indexOf("BORDER")&&(f=c(t),e.borders[f.id]=[f.vertices[0],f.vertices[1]]),[3,5]);case 7:return[2,e]}})})},r}(Z),H=function(e){function r(t){return e.call(this,t)||this}return t(r,e),r.prototype.read=function(){return n(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(i){switch(i.label){case 0:return[4,e.prototype.read.call(this)];case 1:return t=i.sent(),n=Object.assign(new A,t),n.paintedVariable=n.values["*painted*variable"],r=n.values["*line*color"],n.color=r?o(r):255,[2,n]}})})},r}(C),z=function(e){function r(t,n){return e.call(this,t,n)||this}return t(r,e),r.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t,n,r,i,s,o,c,d,h,p,l,v;return __generator(this,function(x){switch(x.label){case 0:return e=new j,[4,this.reader.expects("HEADER")];case 1:return t=x.sent(),t&&t.indexOf("{")!==-1?[4,new H(this.reader).read()]:[2,e];case 2:return n=x.sent(),e.header=n,[4,new k(this.reader).read()];case 3:return r=x.sent(),i=1,r.isValid&&(e.coordinateSystem=r,i="Depth"===e.coordinateSystem.ZPOSITIVE?-1:1),[4,this.reader.expects("ILINE")];case 4:return t=x.sent(),s=1,o=1,c=!1,d=[],[4,this.reader.nextDataLine()];case 5:t=x.sent(),h="}"===(t?t.trim():"}"),x.label=6;case 6:if(h)return[3,9];if(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX"))p=a(t,this.projectionFn,i),e.vertices[p.index]=p.all,o=p.index;else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM"))l=u(t),e.vertices[l.index]=e.vertices[l.vertexId];else if(0===t.indexOf("SEG"))d.push(f(t)),c=!0;else if(0===t.indexOf("ILINE")||0===t.indexOf("END")){if(h=0===t.indexOf("END"),!c&&o>s)for(v=s;v<o;v++)d.push([v,v+1]);e.lines.push(d),d=[],s=o+1,c=!1}return h=!this.reader.hasMore(),h?[3,8]:[4,this.reader.nextDataLine()];case 7:t=x.sent().trim(),h="}"===t,x.label=8;case 8:return[3,6];case 9:return[2,e]}})})},r}(Z),U=function(){function e(e,t){this.reader=e,this.projectionFn=t}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t,n,r,i,s,o,c;return __generator(this,function(d){switch(d.label){case 0:return e=new P,[4,new Z(this.reader,this.projectionFn).read()];case 1:return t=d.sent(),[4,this.reader.expects("HEADER")];case 2:return(n=d.sent())?(r=e,[4,new C(this.reader).read()]):[3,8];case 3:return r.header=d.sent(),[4,new k(this.reader).read()];case 4:return i=d.sent(),s=1,i.isValid&&(e.coordinateSystem=i,s="Depth"===e.coordinateSystem.ZPOSITIVE?-1:1),[4,this.reader.expects("TVOLUME")];case 5:n=d.sent(),d.label=6;case 6:return[4,this.reader.nextDataLine()];case 7:return"END"===(n=d.sent().trim())?[3,8]:(0===n.indexOf("VRTX")||0===n.indexOf("PVRTX")?(o=a(n,this.projectionFn,s),e.vertices[o.index]=o.all):0===n.indexOf("ATOM")||0===n.indexOf("PATOM")?(c=u(n),e.vertices[c.index]=e.vertices[c.vertexId]):0===n.indexOf("TETRA")&&e.tetras.push(p(n)),[3,6]);case 8:return[2,e]}})})},e}(),Y=function(){function e(e){this.reader=e}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t;return __generator(this,function(n){switch(n.label){case 0:return[4,new C(this.reader).read()];case 1:return e=n.sent(),t=Object.assign(new X,e),t.color=o(t.values["*atoms*color"]),[2,t]}})})},e}(),q=function(){function e(e,t){this.reader=e,this.projectionFn=t}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t,n,r,i,s,o;return __generator(this,function(c){switch(c.label){case 0:return e=new G,[4,this.reader.expects("HEADER")];case 1:return t=c.sent(),t&&t.indexOf("{")!==-1?(n=e,[4,new Y(this.reader).read()]):[2];case 2:return n.header=c.sent(),[4,new k(this.reader).read()];case 3:r=c.sent(),i=1,r.isValid&&(e.coordinateSystem=r,i="Depth"===e.coordinateSystem.ZPOSITIVE?-1:1),c.label=4;case 4:return[4,this.reader.nextDataLine()];case 5:return"END"===(t=c.sent().trim())?[3,6]:(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")?(s=a(t,this.projectionFn,i),e.vertices[s.index]=s.all):0!==t.indexOf("ATOM")&&0!==t.indexOf("PATOM")||(o=u(t),e.vertices[o.index]=e.vertices[o.vertexId]),[3,4]);case 6:return[2,e]}})})},e}(),J=function(){function e(e,t){this.reader=e,this.projectionFn=t}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t;return __generator(this,function(n){switch(n.label){case 0:e=new V,n.label=1;case 1:return this.reader.hasMore()?[4,this.reader.next()]:[3,3];case 2:return t=n.sent().trim(),"END"===t?[3,3]:[3,1];case 3:return[2,e]}})})},e}(),K=function(){function e(e,t){this.reader=e,this.projectionFn=t}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t,n,r,i,s,o,a;return __generator(this,function(u){switch(u.label){case 0:return e=new R,this.reader.hasMore()?[4,this.reader.next()]:[3,11];case 1:return t=u.sent().trim(),n=t.split(/\s+/g),e.isValid=3===n.length&&"GOCAD"===n[0]&&("1.0"===n[2]||"1"===n[2]),e.isValid?(e.version=n[2],"TSurf"!==n[1]?[3,3]:(r=e,[4,new B(this.reader,this.projectionFn).read()])):[3,11];case 2:return r.type=u.sent(),[3,11];case 3:return"PLine"!==n[1]?[3,5]:(i=e,[4,new z(this.reader,this.projectionFn).read()]);case 4:return i.type=u.sent(),[3,11];case 5:return"TSolid"!==n[1]?[3,7]:(s=e,[4,new U(this.reader,this.projectionFn).read()]);case 6:return s.type=u.sent(),[3,11];case 7:return"VSet"!==n[1]?[3,9]:(o=e,[4,new q(this.reader,this.projectionFn).read()]);case 8:return o.type=u.sent(),[3,11];case 9:return a=e,[4,new J(this.reader,this.projectionFn).read()];case 10:a.type=u.sent(),u.label=11;case 11:return[2,e]}})})},e}(),Q=function(){function e(e,t){this.reader=e,this.projectionFn=t,this.document=new D}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t;return __generator(this,function(n){switch(n.label){case 0:return this.document.types=[],this.reader.hasMore()?(e=new K(this.reader,this.projectionFn),[4,e.read()]):[3,2];case 1:t=n.sent(),t.isValid&&this.document.types.push(t.type),n.label=2;case 2:return[2,this.document]}})})},e}(),W=function(){function e(e){this.PAGE_SIZE=1048576,this.file=e,this.length=e.size,this.pageNo=0,this.index=this.PAGE_SIZE}return e.prototype.readPage=function(){return n(this,void 0,void 0,function(){var e,t,n,r=this;return __generator(this,function(i){return e=this.pageNo*this.PAGE_SIZE,e>=this.length?[2,""]:(t=new FileReader,n=this.file.slice(e,e+this.PAGE_SIZE),t.readAsText(n),[2,new Promise(function(e){t.onloadend=function(t){t.target.readyState===FileReader.prototype.DONE&&(console.log("Reading page "+r.pageNo),r.buffer=t.target.result,r.pageNo++,r.index=0,console.log("read"),e(!0))}})])})})},e.prototype.hasMore=function(){return this.index+this.PAGE_SIZE*this.pageNo<this.length-1},e.prototype.next=function(){return n(this,void 0,void 0,function(){var e,t;return __generator(this,function(n){switch(n.label){case 0:e=[],n.label=1;case 1:return this.hasMore()?this.index>=this.PAGE_SIZE?[4,this.readPage()]:[3,3]:[3,4];case 2:n.sent(),n.label=3;case 3:return t=this.buffer[this.index],"\r"===t?[3,1]:"\n"===t?(this.index++,[3,4]):(e.push(t),[3,1]);case 4:return[2,e.join("")]}})})},e}(),$=function(){function e(e){this.streamer=new W(e),this.current=""}return e.prototype.hasMore=function(){return this.streamer.hasMore()},e.prototype.previous=function(){this.useLast=!0},e.prototype.next=function(){return n(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return this.useLast?(this.useLast=!1,[2,this.current]):(e=this,[4,this.streamer.next()]);case 1:return e.current=t.sent(),[2,this.current]}})})},e.prototype.expects=function(e){return n(this,void 0,void 0,function(){var t;return __generator(this,function(n){switch(n.label){case 0:return this.hasMore()?[4,this.next()]:[3,2];case 1:return t=n.sent(),t.indexOf(e)?[3,0]:[2,t];case 2:return[2,null]}})})},e.prototype.nextNonEmpty=function(){return n(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return this.hasMore()?[4,this.next()]:[3,2];case 1:return e=t.sent(),e?[2,e]:[3,0];case 2:return[2,null]}})})},e.prototype.nextDataLine=function(){return n(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.nextNonEmpty()];case 1:e=t.sent(),t.label=2;case 2:return e?e.indexOf("#")?[2,e]:[4,this.nextNonEmpty()]:[3,4];case 3:return e=t.sent(),[3,2];case 4:return[2,e]}})})},e}(),ee=function(){function e(e){this.reader=e}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t,n,r,i,s;return __generator(this,function(o){if(e=new I,t=this.reader.nextDataLine().trim(),"GOCAD_ORIGINAL_COORDINATE_SYSTEM"!==t)this.reader.previous(),e.isValid=!1;else for(t=this.reader.nextDataLine().trim();t&&"END_ORIGINAL_COORDINATE_SYSTEM"!==t;)n=t.indexOf(" "),n>0&&(r=t.substring(0,n),i=t.substring(n).trim(),s=e.typeMap[r]?e.typeMap[r]:function(e){return e},e[r]=s(i)),t=this.reader.nextDataLine().trim();return e.typeMap=null,[2,e]})})},e}(),te=function(){function e(e){this.reader=e}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t,n,r;return __generator(this,function(i){for(e=new S,t=this.reader.nextDataLine().trim();t&&0!==t.indexOf("}");)n=t.split(":"),2===n.length?(r=e.typeMap[n[0]],r=r?r:s,e.values[n[0]]=r(n[1])):console.warn("That doesn't look like a pair: "+t),t=this.reader.nextDataLine().trim();return e.name=e.values.name,e.solidColor=e.values["*solid*color"],e.solidColor=e.solidColor?e.solidColor:15658734,e.typeMap=null,[2,e]})})},e}(),ne=function(){function e(e,t){this.reader=e,this.projectionFn=t}return e.prototype.read=function(){return n(this,void 0,void 0,function(){return __generator(this,function(e){return[2,new Promise(function(e){var t=new M;e(t)})]})})},e}(),re=function(e){function r(t,n){return e.call(this,t,n)||this}return t(r,e),r.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t,n,r,i,s,o,c;return __generator(this,function(d){switch(d.label){case 0:return e=new L,t=this.reader.expects("HEADER"),t&&t.indexOf("{")!==-1?(n=e,[4,new te(this.reader).read()]):[2,new Promise(function(t){return e})];case 1:return n.header=d.sent(),[4,new ee(this.reader).read()];case 2:for(r=d.sent(),i=1,r.isValid&&(e.coordinateSystem=r,i="Depth"===e.coordinateSystem.ZPOSITIVE?-1:1),t=this.reader.expects("TFACE");"END"!==(t=this.reader.nextDataLine().trim());)0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")?(s=a(t,this.projectionFn,i),e.vertices[s.index]=s.all):0===t.indexOf("ATOM")||0===t.indexOf("PATOM")?(o=u(t),e.vertices[o.index]=e.vertices[o.vertexId]):0===t.indexOf("TRGL")?e.faces.push(y(t).abc):0===t.indexOf("BSTONE")?e.bstones.push(O(t)):0===t.indexOf("BORDER")&&(c=x(t),e.borders[c.id]=[c.vertices[0],c.vertices[1]]);return[2,e]}})})},r}(ne),ie=function(e){function r(t){return e.call(this,t)||this}return t(r,e),r.prototype.read=function(){return n(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(i){switch(i.label){case 0:return[4,e.prototype.read.call(this)];case 1:return t=i.sent(),n=Object.assign(new A,t),n.paintedVariable=n.values["*painted*variable"],r=n.values["*line*color"],n.color=r?o(r):255,[2,n]}})})},r}(te),se=function(e){function r(t,n){return e.call(this,t,n)||this}return t(r,e),r.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t,n,r,i,s,o,c,d,h,f,p,l;return __generator(this,function(v){switch(v.label){case 0:return e=new j,t=this.reader.expects("HEADER"),t&&t.indexOf("{")!==-1?[4,new ie(this.reader).read()]:[2,new Promise(function(t){t(e)})];case 1:return n=v.sent(),e.header=n,[4,new ee(this.reader).read()];case 2:for(r=v.sent(),i=1,r.isValid&&(e.coordinateSystem=r,i="Depth"===e.coordinateSystem.ZPOSITIVE?-1:1),t=this.reader.expects("ILINE"),s=1,o=1,c=!1,d=[],t=this.reader.nextDataLine(),h="}"===(t?t.trim():"}");!h;){if(0===t.indexOf("VRTX")||0===t.indexOf("PVRTX"))f=a(t,e.projectionFn,i),e.vertices[f.index]=f.all,o=f.index;else if(0===t.indexOf("ATOM")||0===t.indexOf("PATOM"))p=u(t),e.vertices[p.index]=e.vertices[p.vertexId];else if(0===t.indexOf("SEG"))d.push(g(t)),c=!0;else if(0===t.indexOf("ILINE")||0===t.indexOf("END")){if(h=0===t.indexOf("END"),!c&&o>s)for(l=s;l<o;l++)d.push([l,l+1]);e.lines.push(d),d=[],s=o+1,c=!1}h=!this.reader.hasMore(),h||(h="}"===(t=this.reader.nextDataLine().trim()))}return[2,e]}})})},r}(ne),oe=function(){function e(e,t){this.reader=e,this.projectionFn=t}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t,n,r,i,s,o,c;return __generator(this,function(d){switch(d.label){case 0:return e=new P,[4,new ne(this.reader,this.projectionFn).read()];case 1:return t=d.sent(),(n=this.reader.expects("HEADER"))?(r=e,[4,new te(this.reader).read()]):[3,4];case 2:return r.header=d.sent(),[4,new ee(this.reader).read()];case 3:for(i=d.sent(),s=1,i.isValid&&(e.coordinateSystem=i,s="Depth"===e.coordinateSystem.ZPOSITIVE?-1:1),n=this.reader.expects("TVOLUME");"END"!==(n=this.reader.nextDataLine().trim());)0===n.indexOf("VRTX")||0===n.indexOf("PVRTX")?(o=a(n,this.projectionFn,s),e.vertices[o.index]=o.all):0===n.indexOf("ATOM")||0===n.indexOf("PATOM")?(c=u(n),e.vertices[c.index]=e.vertices[c.vertexId]):0===n.indexOf("TETRA")&&e.tetras.push(w(n));d.label=4;case 4:return[2,e]}})})},e}(),ae=function(){function e(e){this.reader=e}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t;return __generator(this,function(n){switch(n.label){case 0:return[4,new te(this.reader).read()];case 1:return e=n.sent(),t=Object.assign(new X,e),t.color=o(t.values["*atoms*color"]),[2,t]}})})},e}(),ue=function(){function e(e,t){this.reader=e,this.projectionFn=t}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t,n,r,i,s,o;return __generator(this,function(c){switch(c.label){case 0:return e=new G,t=this.reader.expects("HEADER"),t&&t.indexOf("{")!==-1?(n=e,[4,new ae(this.reader).read()]):[2];case 1:return n.header=c.sent(),[4,new ee(this.reader).read()];case 2:for(r=c.sent(),i=1,r.isValid&&(e.coordinateSystem=r,i="Depth"===e.coordinateSystem.ZPOSITIVE?-1:1);"END"!==(t=this.reader.nextDataLine().trim());)0===t.indexOf("VRTX")||0===t.indexOf("PVRTX")?(s=a(t,this.projectionFn,i),e.vertices[s.index]=s.all):0!==t.indexOf("ATOM")&&0!==t.indexOf("PATOM")||(o=u(t),e.vertices[o.index]=e.vertices[o.vertexId]);return[2,e]}})})},e}(),ce=function(){function e(e,t){this.reader=e,this.projectionFn=t}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t;return __generator(this,function(n){for(e=new V;this.reader.hasMore()&&(t=this.reader.next().trim(),"END"!==t););return[2,new Promise(function(t){t(e)})]})})},e}(),de=function(){function e(e,t){this.reader=e,this.projectionFn=t}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t,n,r,i,s,o,a;return __generator(this,function(u){switch(u.label){case 0:return e=new R,this.reader.hasMore()?(t=this.reader.next().trim(),n=t.split(/\s+/g),e.isValid=3===n.length&&"GOCAD"===n[0]&&("1.0"===n[2]||"1"===n[2]),e.isValid?(e.version=n[2],"TSurf"!==n[1]?[3,2]:(r=e,[4,new re(this.reader,this.projectionFn).read()])):[3,10]):[3,10];case 1:return r.type=u.sent(),[3,10];case 2:return"PLine"!==n[1]?[3,4]:(i=e,[4,new se(this.reader,this.projectionFn).read()]);case 3:return i.type=u.sent(),[3,10];case 4:return"TSolid"!==n[1]?[3,6]:(s=e,[4,new oe(this.reader,this.projectionFn).read()]);case 5:return s.type=u.sent(),[3,10];case 6:return"VSet"!==n[1]?[3,8]:(o=e,[4,new ue(this.reader,this.projectionFn).read()]);case 7:return o.type=u.sent(),[3,10];case 8:return a=e,[4,new ce(this.reader,this.projectionFn).read()];case 9:a.type=u.sent(),u.label=10;case 10:return[2,e]}})})},e}(),he=function(){function e(e,t){this.reader=e,this.projectionFn=t,this.document=new D}return e.prototype.read=function(){return n(this,void 0,void 0,function(){var e,t;return __generator(this,function(n){switch(n.label){case 0:return this.document.types=[],this.reader.hasMore()?(e=new de(this.reader,this.projectionFn),[4,e.read()]):[3,2];case 1:t=n.sent(),t.isValid&&this.document.types.push(t.type),n.label=2;case 2:return[2,this.document]}})})},e}(),fe=function(){function e(e){this.indexStack=[],this.data=e,this.length=e.length,this.index=0}return e.prototype.hasMore=function(){return this.index<this.length-1},e.prototype.peek=function(){this.next();this.previous()},e.prototype.previous=function(){this.indexStack.length&&(this.index=this.indexStack.pop())},e.prototype.next=function(){this.indexStack.push(this.index);for(var e=[];this.index<this.length;this.index++){var t=this.data[this.index];if("\r"!==t){if("\n"===t){this.index++;break}e.push(this.data[this.index])}}return e?e.join(""):null},e.prototype.expects=function(e){for(;this.hasMore();){var t=this.next();if(!t.indexOf(e))return t}return null},e.prototype.nextNonEmpty=function(){for(;this.hasMore();){var e=this.next();if(e)return e}return null},e.prototype.nextDataLine=function(){for(var e=this.nextNonEmpty();e;){if(e.indexOf("#"))return e;e=this.nextNonEmpty()}return e},e}(),pe=function(){function e(){}return e.prototype.apply=function(t){t.addEventListener=e.prototype.addEventListener,t.hasEventListener=e.prototype.hasEventListener,t.removeEventListener=e.prototype.removeEventListener,t.dispatchEvent=e.prototype.dispatchEvent},e.prototype.addEventListener=function(e,t){void 0===this._listeners&&(this._listeners={});var n=this._listeners;void 0===n[e]&&(n[e]=[]),n[e].indexOf(t)===-1&&n[e].push(t)},e.prototype.hasEventListener=function(e,t){if(void 0===this._listeners)return!1;var n=this._listeners;return void 0!==n[e]&&n[e].indexOf(t)!==-1},e.prototype.removeEventListener=function(e,t){if(void 0!==this._listeners){var n=this._listeners,r=n[e];if(void 0!==r){var i=r.indexOf(t);i!==-1&&r.splice(i,1)}}},e.prototype.dispatchEvent=function(){},e}(),le=function(){function e(e,t,n){this.PAGE_SIZE=1048576,this.file=e,this.length=e.size,this.handler=t,this.errorHandler=n,this.pageNo=this.index=0,this.lineBuffer=[],this.process()}return e.prototype.process=function(){this.readPage()},e.prototype.readPage=function(){function e(e){for(var t=0;t<e.length;t++){var n=e[this.index];"\r"!==n&&("\n"!==n?this.lineBuffer.push(e[t]):(this.handler(this.lineBuffer.join("")),this.lineBuffer=[]))}}var t=this,n=this.pageNo*this.PAGE_SIZE;n>=this.length&&this.complete();var r=new FileReader,i=this.file.slice(n,n+this.PAGE_SIZE);r.onloadend=function(n){if(n.target.readyState===FileReader.prototype.DONE){var r=n.target.result;e(r),t.pageNo++,t.readPage()}},r.readAsText(i)},e.prototype.complete=function(){this.lineBuffer.length&&this.handler(this.lineBuffer.join("")),this.handler(null)},e}();e.CoordinateSystem=I,e.Document=D,e.PLine=j,e.PLineHeader=A,e.Properties=F,e.TSolid=P,e.TSurf=L,e.TypeFactory=R,e.Unknown=V,e.Vertex=N,e.VSet=G,e.VSetHeader=X,e.DocumentBufferedReader=Q,e.fileBufferedReader=l,e.TypeFactoryBufferedReader=K,e.DocumentReader=he,e.fileReader=E,e.TypeFactoryReader=de,e.deepMerge=_,e.EventDispatcher=pe,e.LinePusher=le,e.LineReader=fe,e.range=b,e.parseXml=T,e.toBool=i,e.flowThru=s,e.toColor=o,e.Header=S,e.Type=M,Object.defineProperty(e,"__esModule",{value:!0})});